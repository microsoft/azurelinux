From 90a452ef5766803b53d7af14c876384933688ffd Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Sat, 13 Sep 2025 04:38:52 +0000
Subject: [PATCH] cupsd: Block authentication using alternate method

Fixes: CVE-2025-58060
Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/OpenPrinting/cups/commit/595d691075b1d396d2edfaa0a8fd0873a0a1f221.patch
---
 scheduler/auth.c | 20 ++++++++++++++++++++
 1 file changed, 20 insertions(+)

diff --git a/scheduler/auth.c b/scheduler/auth.c
index 4fbad6e..82f9865 100644
--- a/scheduler/auth.c
+++ b/scheduler/auth.c
@@ -504,6 +504,15 @@ cupsdAuthorize(cupsd_client_t *con)	/* I - Client connection */
 
     int	userlen;			/* Username:password length */
 
+   /*
+    * Only allow Basic if enabled...
+    */
+
+    if (type != CUPSD_AUTH_BASIC)
+    {
+      cupsdLogClient(con, CUPSD_LOG_ERROR, "Basic authentication is not enabled.");
+      return;
+    }
 
     authorization += 5;
     while (isspace(*authorization & 255))
@@ -716,6 +725,17 @@ cupsdAuthorize(cupsd_client_t *con)	/* I - Client connection */
   else if (!strncmp(authorization, "Negotiate", 9))
   {
     int			len;		/* Length of authorization string */
+
+   /*
+    * Only allow Kerberos if enabled...
+    */
+
+    if (type != CUPSD_AUTH_NEGOTIATE)
+    {
+      cupsdLogClient(con, CUPSD_LOG_ERROR, "Kerberos authentication is not enabled.");
+      return;
+    }
+
     gss_ctx_id_t	context;	/* Authorization context */
     OM_uint32		major_status,	/* Major status code */
 			minor_status;	/* Minor status code */
-- 
2.45.4

