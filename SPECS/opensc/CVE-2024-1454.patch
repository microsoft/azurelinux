From 4d1fbfdce97b44bb4ffb991bbc481da5056c1bfe Mon Sep 17 00:00:00 2001
From: Sreenivasulu Malavathula <v-smalavathu@microsoft.com>
Date: Sun, 23 Feb 2025 19:04:16 -0600
Subject: [PATCH] Address CVE-2024-1454

---
 src/pkcs15init/pkcs15-authentic.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/src/pkcs15init/pkcs15-authentic.c b/src/pkcs15init/pkcs15-authentic.c
index c6894dd..adedd0a 100644
--- a/src/pkcs15init/pkcs15-authentic.c
+++ b/src/pkcs15init/pkcs15-authentic.c
@@ -858,7 +858,10 @@ authentic_emu_update_tokeninfo(struct sc_profile *profile, struct sc_pkcs15_card
         rv = sc_select_file(p15card->card, &path, &file);
         if (!rv)   {
 		rv = sc_get_challenge(p15card->card, buffer, sizeof(buffer));
-		LOG_TEST_RET(ctx, rv, "Get challenge error");
+		if (rv < 0) {
+			sc_file_free(file);
+			LOG_TEST_RET(ctx, rv, "Get challenge error");
+		}
 
 		len = file->size > sizeof(buffer) ? sizeof(buffer) : file->size;
 	        rv = sc_update_binary(p15card->card, 0, buffer, len, 0);
-- 
2.45.2

