From 9eb423834eec8a61773b2bd02b694d132459ade7 Mon Sep 17 00:00:00 2001
From: Kevin Lockwood <v-klockwood@microsoft.com>
Date: Wed, 5 Feb 2025 11:57:38 -0800
Subject: [PATCH] [Medium] Patch ceph for CVE-2021-24032

Link: https://github.com/facebook/zstd/commit/a774c5797399040af62db21d8a9b9769e005430e.patch
---
 src/zstd/programs/fileio.c | 9 +++------
 src/zstd/programs/util.c   | 9 +++++++++
 src/zstd/programs/util.h   | 7 ++++++-
 3 files changed, 18 insertions(+), 7 deletions(-)

diff --git a/src/zstd/programs/fileio.c b/src/zstd/programs/fileio.c
index d72879d64..f4529840a 100644
--- a/src/zstd/programs/fileio.c
+++ b/src/zstd/programs/fileio.c
@@ -611,14 +611,11 @@ FIO_openDstFile(FIO_prefs_t* const prefs,
             FIO_remove(dstFileName);
     }   }
 
-    {   FILE* const f = fopen( dstFileName, "wb" );
+    {   const int old_umask = UTIL_umask(0177); /* u-x,go-rwx */
+        FILE* const f = fopen( dstFileName, "wb" );
+        UTIL_umask(old_umask);
         if (f == NULL) {
             DISPLAYLEVEL(1, "zstd: %s: %s\n", dstFileName, strerror(errno));
-        } else if (srcFileName != NULL
-               && strcmp (srcFileName, stdinmark)
-               && strcmp(dstFileName, nulmark) ) {
-            /* reduce rights on newly created dst file while compression is ongoing */
-            UTIL_chmod(dstFileName, 00600);
         }
         return f;
     }
diff --git a/src/zstd/programs/util.c b/src/zstd/programs/util.c
index ab1abd3b1..950697252 100644
--- a/src/zstd/programs/util.c
+++ b/src/zstd/programs/util.c
@@ -137,6 +137,15 @@ int UTIL_chmod(char const* filename, mode_t permissions)
     return chmod(filename, permissions);
 }
 
+int UTIL_umask(int mode) {
+#if PLATFORM_POSIX_VERSION > 0
+    return umask(mode);
+#else
+    /* do nothing, fake return value */
+    return mode;
+#endif
+}
+
 int UTIL_setFileStat(const char *filename, stat_t *statbuf)
 {
     int res = 0;
diff --git a/src/zstd/programs/util.h b/src/zstd/programs/util.h
index 8e187e4f2..8b1f80bb1 100644
--- a/src/zstd/programs/util.h
+++ b/src/zstd/programs/util.h
@@ -22,7 +22,7 @@ extern "C" {
 #include "platform.h"     /* PLATFORM_POSIX_VERSION, ZSTD_NANOSLEEP_SUPPORT, ZSTD_SETPRIORITY_SUPPORT */
 #include <stddef.h>       /* size_t, ptrdiff_t */
 #include <sys/types.h>    /* stat, utime */
-#include <sys/stat.h>     /* stat, chmod */
+#include <sys/stat.h>     /* stat, chmod, umask */
 #include "../lib/common/mem.h"          /* U64 */
 
 
@@ -119,6 +119,11 @@ U64 UTIL_getTotalFileSize(const char* const * fileNamesTable, unsigned nbFiles);
 int UTIL_getFileStat(const char* infilename, stat_t* statbuf);
 int UTIL_setFileStat(const char* filename, stat_t* statbuf);
 int UTIL_chmod(char const* filename, mode_t permissions);   /*< like chmod, but avoid changing permission of /dev/null */
+/**
+ * Wraps umask(). Does nothing when the platform doesn't have that concept.
+ */
+int UTIL_umask(int mode);
+
 int UTIL_compareStr(const void *p1, const void *p2);
 const char* UTIL_getFileExtension(const char* infilename);
 
-- 
2.34.1

