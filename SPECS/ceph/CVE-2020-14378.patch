From a70de0405b30f576c7c947098775b07bcdcbbce2 Mon Sep 17 00:00:00 2001
From: archana25-ms <v-shettigara@microsoft.com>
Date: Wed, 26 Mar 2025 07:08:51 +0000
Subject: [PATCH] Address CVE-2020-14378

Upstream Patch Reference: https://git.dpdk.org/dpdk-stable/commit/?id=7a5af91f8bf46f121cc1a7873045ef37f63d56c2

---
 src/seastar/dpdk/lib/librte_vhost/vhost_crypto.c | 3 ++-
 src/spdk/dpdk/lib/librte_vhost/vhost_crypto.c    | 3 ++-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/seastar/dpdk/lib/librte_vhost/vhost_crypto.c b/src/seastar/dpdk/lib/librte_vhost/vhost_crypto.c
index 9d569fcc5..28969297a 100644
--- a/src/seastar/dpdk/lib/librte_vhost/vhost_crypto.c
+++ b/src/seastar/dpdk/lib/librte_vhost/vhost_crypto.c
@@ -540,13 +540,14 @@ move_desc(struct vring_desc *head, struct vring_desc **cur_desc,
 	int left = size - desc->len;
 
 	while ((desc->flags & VRING_DESC_F_NEXT) && left > 0) {
-		(*nb_descs)--;
 		if (unlikely(*nb_descs == 0 || desc->next >= vq_size))
 			return -1;
 
 		desc = &head[desc->next];
 		rte_prefetch0(&head[desc->next]);
 		left -= desc->len;
+		if (left > 0)
+			(*nb_descs)--;
 	}
 
 	if (unlikely(left > 0))
diff --git a/src/spdk/dpdk/lib/librte_vhost/vhost_crypto.c b/src/spdk/dpdk/lib/librte_vhost/vhost_crypto.c
index 0f9df4059..86747dd5f 100644
--- a/src/spdk/dpdk/lib/librte_vhost/vhost_crypto.c
+++ b/src/spdk/dpdk/lib/librte_vhost/vhost_crypto.c
@@ -530,13 +530,14 @@ move_desc(struct vring_desc *head, struct vring_desc **cur_desc,
 	int left = size - desc->len;
 
 	while ((desc->flags & VRING_DESC_F_NEXT) && left > 0) {
-		(*nb_descs)--;
 		if (unlikely(*nb_descs == 0 || desc->next >= vq_size))
 			return -1;
 
 		desc = &head[desc->next];
 		rte_prefetch0(&head[desc->next]);
 		left -= desc->len;
+		if (left > 0)
+			(*nb_descs)--;
 	}
 
 	if (unlikely(left > 0))
-- 
2.45.3

