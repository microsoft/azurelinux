From 2d65c514bc964b192bab212ddf3c1fcea4ae96b8 Mon Sep 17 00:00:00 2001
From: Motoyuki Kimura <moymoymox@gmail.com>
Date: Fri, 8 Aug 2025 16:25:07 +0900
Subject: [PATCH] Fix get_disjoint_mut error condition (#152)
Upstream Reference Patch: https://github.com/tokio-rs/slab/commit/2d65c514bc964b192bab212ddf3c1fcea4ae96b8.patch
---
 vendor/slab-0.4.10/src/lib.rs    |  5 +++--
 vendor/slab-0.4.10/tests/slab.rs | 13 +++++++++++++
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/vendor/slab-0.4.10/src/lib.rs b/vendor/slab-0.4.10/src/lib.rs
index bd00e085d..01ed42127 100644
--- a/vendor/slab-0.4.10/src/lib.rs
+++ b/vendor/slab-0.4.10/src/lib.rs
@@ -823,13 +823,14 @@ impl<T> Slab<T> {
         }
 
         let entries_ptr = self.entries.as_mut_ptr();
-        let entries_cap = self.entries.capacity();
+	let entries_len = self.entries.len();
 
         let mut res = MaybeUninit::<[&mut T; N]>::uninit();
         let res_ptr = res.as_mut_ptr() as *mut &mut T;
 
         for (i, &key) in keys.iter().enumerate() {
-            if key >= entries_cap {
+	    // `key` won't be greater than `entries_len`.
+            if key >= entries_len {
                 return Err(GetDisjointMutError::IndexOutOfBounds);
             }
             // SAFETY: we made sure above that this key is in bounds.
diff --git a/vendor/slab-0.4.10/tests/slab.rs b/vendor/slab-0.4.10/tests/slab.rs
index 1b134f8c8..b9c9bd561 100644
--- a/vendor/slab-0.4.10/tests/slab.rs
+++ b/vendor/slab-0.4.10/tests/slab.rs
@@ -767,3 +767,16 @@ fn get_disjoint_mut() {
     assert_eq!(slab[0], 4);
     assert_eq!(slab[4], 0);
 }
+
+#[test]
+fn get_disjoint_mut_out_of_bounds_index_error() {
+    let mut slab: Slab<i32> = Slab::with_capacity(10);
+    slab.insert(1);
+    slab.insert(2);
+
+    // Index 0 and 1 are valid, but index 5 is out of bounds (beyond len)
+    assert_eq!(
+        slab.get_disjoint_mut([0, 1, 5]),
+        Err(GetDisjointMutError::IndexOutOfBounds)
+    );
+}
-- 
2.45.4

