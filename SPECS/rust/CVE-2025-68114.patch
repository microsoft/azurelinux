From 2c7797182a1618be12017d7d41e0b6581d5d529e Mon Sep 17 00:00:00 2001
From: Rot127 <45763064+Rot127@users.noreply.github.com>
Date: Wed, 17 Dec 2025 14:01:10 +0000
Subject: [PATCH] Merge commit from fork

* Check return value of cs_vsnprintf for negative values.

This prevents underflow of SStream.index.
This bug was reported by Github user Finder16.

* Add overflow check before adding cs_vsnprintf return value.

Upstream Patch Reference: https://github.com/capstone-engine/capstone/commit/2c7797182a1618be12017d7d41e0b6581d5d529e.patch
---
 vendor/capstone-sys-0.17.0/capstone/SStream.c | 67 +++++++++++++++++--
 vendor/capstone-sys-0.17.0/capstone/SStream.h | 18 ++++-
 2 files changed, 76 insertions(+), 9 deletions(-)

diff --git a/vendor/capstone-sys-0.17.0/capstone/SStream.c b/vendor/capstone-sys-0.17.0/capstone/SStream.c
index 4a50a14cf..7da115f14 100644
--- a/vendor/capstone-sys-0.17.0/capstone/SStream.c
+++ b/vendor/capstone-sys-0.17.0/capstone/SStream.c
@@ -18,44 +18,97 @@
 #include "cs_priv.h"
 #include "utils.h"
 
-#ifdef _MSC_VER
-#pragma warning(disable: 4996) // disable MSVC's warning on strcpy()
-#endif
-
 void SStream_Init(SStream *ss)
 {
+	assert(ss);
 	ss->index = 0;
-	ss->buffer[0] = '\0';
+	memset(ss->buffer, 0, sizeof(ss->buffer));
+	ss->is_closed = false;
+	ss->markup_stream = false;
+	ss->prefixed_by_markup = false;
+	ss->unsigned_num = false;
 }
 
 void SStream_concat0(SStream *ss, const char *s)
 {
 #ifndef CAPSTONE_DIET
-	unsigned int len = (unsigned int) strlen(s);
+	assert(ss && s);
+	SSTREAM_RETURN_IF_CLOSED(ss);
+	if (s[0] == '\0')
+		return;
+	unsigned int len = (unsigned int)strlen(s);
+
+	SSTREAM_OVERFLOW_CHECK(ss, len);
 
 	memcpy(ss->buffer + ss->index, s, len);
 	ss->index += len;
 	ss->buffer[ss->index] = '\0';
+	if (ss->markup_stream && ss->prefixed_by_markup) {
+		SSTREAM_OVERFLOW_CHECK(ss, 1);
+		ss->buffer[ss->index] = '>';
+		ss->index += 1;
+		ss->buffer[ss->index] = '\0';
+	}
+#else
+	ss->buffer[ss->index] = '\0';
 #endif
 }
 
+/**
+ * Copy the single char \p c to the buffer of \p ss.
+*/
+
 void SStream_concat1(SStream *ss, const char c)
 {
 #ifndef CAPSTONE_DIET
+	assert(ss);
+	SSTREAM_RETURN_IF_CLOSED(ss);
+	if (c == '\0')
+		return;
+
+	SSTREAM_OVERFLOW_CHECK(ss, 1);
+
 	ss->buffer[ss->index] = c;
 	ss->index++;
 	ss->buffer[ss->index] = '\0';
+	if (ss->markup_stream && ss->prefixed_by_markup) {
+		SSTREAM_OVERFLOW_CHECK(ss, 1);
+		ss->buffer[ss->index] = '>';
+		ss->index++;
+	}
+#else
+	ss->buffer[ss->index] = '\0';
 #endif
 }
 
+/**
+ * Copy all strings given to the buffer of \p ss according to formatting \p fmt.
+*/
+
 void SStream_concat(SStream *ss, const char *fmt, ...)
 {
 #ifndef CAPSTONE_DIET
+	assert(ss && fmt);
+	SSTREAM_RETURN_IF_CLOSED(ss);
 	va_list ap;
 	int ret;
 
 	va_start(ap, fmt);
-	ret = cs_vsnprintf(ss->buffer + ss->index, sizeof(ss->buffer) - (ss->index + 1), fmt, ap);
+	ret = cs_vsnprintf(ss->buffer + ss->index,
+			   sizeof(ss->buffer) - (ss->index + 1), fmt, ap);
+	va_end(ap);
+	if (ret < 0) {
+		return;
+	}
+	SSTREAM_OVERFLOW_CHECK(ss, ret);
+	ss->index += ret;
+	if (ss->markup_stream && ss->prefixed_by_markup) {
+		SSTREAM_OVERFLOW_CHECK(ss, 1);
+		ss->buffer[ss->index] = '>';
+		ss->index += 1;
+	}
+#else
+	ss->buffer[ss->index] = '\0';
 	va_end(ap);
 	ss->index += ret;
 #endif
diff --git a/vendor/capstone-sys-0.17.0/capstone/SStream.h b/vendor/capstone-sys-0.17.0/capstone/SStream.h
index e70a3141b..fc59c1141 100644
--- a/vendor/capstone-sys-0.17.0/capstone/SStream.h
+++ b/vendor/capstone-sys-0.17.0/capstone/SStream.h
@@ -5,10 +5,24 @@
 #define CS_SSTREAM_H_
 
 #include "include/capstone/platform.h"
+#include <stdio.h>
+
+typedef enum {
+	Markup_Immediate,
+	Markup_Register,
+	Markup_Target,
+	Markup_Memory,
+} SStreamMarkup;
+
+#define SSTREAM_BUF_LEN 512
 
 typedef struct SStream {
-	char buffer[512];
-	int index;
+	char buffer[SSTREAM_BUF_LEN];
+	size_t index;
+	bool is_closed;
+	bool markup_stream; ///< If true, markups to the stream are allowed.
+	bool prefixed_by_markup; ///< Set after the stream wrote a markup for an operand.
+	bool unsigned_num; ///< Print all numbers as unsigned. Set with CS_OPT_UNSIGNED.
 } SStream;
 
 void SStream_Init(SStream *ss);
-- 
2.45.4

