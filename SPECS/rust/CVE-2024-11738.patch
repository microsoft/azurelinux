From 874dd834f5444394deda1f7fcc19cc09afebf6bd Mon Sep 17 00:00:00 2001
From: Kevin Wang <wy721@qq.com>
Date: Fri, 22 Nov 2024 20:48:01 +0800
Subject: [PATCH] Record and restore the processed cursor in
 first_handshake_message

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: https://github.com/rustls/rustls/pull/2231.patch
---
 vendor/rustls-0.23.13/src/conn.rs | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/vendor/rustls-0.23.13/src/conn.rs b/vendor/rustls-0.23.13/src/conn.rs
index 60b597ba5..d45d71fd0 100644
--- a/vendor/rustls-0.23.13/src/conn.rs
+++ b/vendor/rustls-0.23.13/src/conn.rs
@@ -655,6 +655,7 @@ impl<Data> ConnectionCommon<Data> {
     /// `process_handshake_messages()` path, specialized for the first handshake message.
     pub(crate) fn first_handshake_message(&mut self) -> Result<Option<Message<'static>>, Error> {
         let mut buffer_progress = BufferProgress::default();
+        buffer_progress.add_processed(self.deframer_buffer.processed);
 
         let res = self
             .core
@@ -665,6 +666,7 @@ impl<Data> ConnectionCommon<Data> {
             )
             .map(|opt| opt.map(|pm| Message::try_from(pm).map(|m| m.into_owned())));
 
+        self.deframer_buffer.processed = buffer_progress.processed();
         match res? {
             Some(Ok(msg)) => {
                 self.deframer_buffer
-- 
2.45.4

