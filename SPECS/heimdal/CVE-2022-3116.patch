From 2584657af19b706fe49225cc9227bbfded0ee704 Mon Sep 17 00:00:00 2001
From: ankita <ankitapareek@microsoft.com>
Date: Tue, 1 Oct 2024 16:05:50 +0530
Subject: [PATCH] heimdal: Fix NULL deref in spnego for fixing CVE-2022-3116

Signed-off-by: ankita <ankitapareek@microsoft.com>
---
 lib/gssapi/spnego/accept_sec_context.c | 28 +++++++++++++-------------
 1 file changed, 14 insertions(+), 14 deletions(-)

diff --git a/lib/gssapi/spnego/accept_sec_context.c b/lib/gssapi/spnego/accept_sec_context.c
index 5fe1a1a..4920664 100644
--- a/lib/gssapi/spnego/accept_sec_context.c
+++ b/lib/gssapi/spnego/accept_sec_context.c
@@ -605,20 +605,20 @@ acceptor_start
      * If opportunistic token failed, lets try the other mechs.
      */
 
-    if (!first_ok && ni->mechToken != NULL) {
-	size_t j;
-
-	preferred_mech_type = GSS_C_NO_OID;
-
-	/* Call glue layer to find first mech we support */
-	for (j = 1; j < ni->mechTypes.len; ++j) {
-	    ret = select_mech(minor_status,
-			      &ni->mechTypes.val[j],
-			      1,
-			      &preferred_mech_type);
-	    if (ret == 0)
-		break;
-	}
+    if (!first_ok) {
+		size_t j;
+
+		preferred_mech_type = GSS_C_NO_OID;
+
+		/* Call glue layer to find first mech we support */
+		for (j = 1; j < ni->mechTypes.len; ++j) {
+			ret = select_mech(minor_status,
+					&ni->mechTypes.val[j],
+					1,
+					&preferred_mech_type);
+			if (ret == 0)
+			break;
+		}
     }
 
     ctx->preferred_mech_type = preferred_mech_type;
-- 
2.34.1

