From 45f8ada19d3fa5a8806d172fa9069517899d014a Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Fri, 21 Nov 2025 17:12:39 +0000
Subject: [PATCH] vendor/runc: avoid os.Create when creating device nodes; add
 GetPtyPeer wrapper\n\nBackport partial upstream changes to avoid using
 os.Create for device inode creation to prevent symlink truncation issues, and
 add GetPtyPeer wrapper.

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/opencontainers/runc/commit/01de9d65dc72f67b256ef03f9bfb795a2bf143b4.patch
---
 .../runc/libcontainer/rootfs_linux.go         | 16 ++++++++------
 .../runc/libcontainer/system/linux.go         | 21 +++++++++++++++++++
 2 files changed, 31 insertions(+), 6 deletions(-)

diff --git a/vendor/github.com/opencontainers/runc/libcontainer/rootfs_linux.go b/vendor/github.com/opencontainers/runc/libcontainer/rootfs_linux.go
index c3f88fc7..6e4fee9b 100644
--- a/vendor/github.com/opencontainers/runc/libcontainer/rootfs_linux.go
+++ b/vendor/github.com/opencontainers/runc/libcontainer/rootfs_linux.go
@@ -707,12 +707,16 @@ func createDevices(config *configs.Config) error {
 }
 
 func bindMountDeviceNode(rootfs, dest string, node *devices.Device) error {
-	f, err := os.Create(dest)
-	if err != nil && !os.IsExist(err) {
-		return err
-	}
-	if f != nil {
-		_ = f.Close()
+	// Avoid using os.Create which can follow symlinks and truncate unexpected files.
+	// Instead, create the destination with O_NOFOLLOW so we don't follow symlinks.
+	fd, err := unix.Open(dest, unix.O_CREAT|unix.O_CLOEXEC|unix.O_NOFOLLOW, 0o000)
+	if err != nil {
+		// If the file already exists, that's fine. Otherwise, return the error.
+		if !errors.Is(err, os.ErrExist) {
+			return err
+		}
+	} else {
+		_ = unix.Close(fd)
 	}
 	return utils.WithProcfd(rootfs, dest, func(procfd string) error {
 		return mount(node.Path, dest, procfd, "bind", unix.MS_BIND, "")
diff --git a/vendor/github.com/opencontainers/runc/libcontainer/system/linux.go b/vendor/github.com/opencontainers/runc/libcontainer/system/linux.go
index e1d6eb18..98ee1c6d 100644
--- a/vendor/github.com/opencontainers/runc/libcontainer/system/linux.go
+++ b/vendor/github.com/opencontainers/runc/libcontainer/system/linux.go
@@ -102,3 +102,24 @@ func GetSubreaper() (int, error) {
 
 	return int(i), nil
 }
+
+
+// GetPtyPeer is a wrapper for ioctl(TIOCGPTPEER).
+func GetPtyPeer(ptyFd uintptr, unsafePeerPath string, flags int) (*os.File, error) {
+	// Make sure O_NOCTTY is always set -- otherwise runc might accidentally
+	// gain it as a controlling terminal. O_CLOEXEC also needs to be set to
+	// make sure we don't leak the handle either.
+	flags |= unix.O_NOCTTY | unix.O_CLOEXEC
+
+	// There is no nice wrapper for this kind of ioctl in unix.
+	peerFd, _, errno := unix.Syscall(
+		unix.SYS_IOCTL,
+		ptyFd,
+		uintptr(unix.TIOCGPTPEER),
+		uintptr(flags),
+	)
+	if errno != 0 {
+		return nil, os.NewSyscallError("ioctl TIOCGPTPEER", errno)
+	}
+	return os.NewFile(peerFd, unsafePeerPath), nil
+}
-- 
2.45.4

