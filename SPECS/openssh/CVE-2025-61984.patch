From c3f60955db44c675359e6fa512e16eb2f6fddd0b Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Tue, 7 Oct 2025 16:06:54 +0000
Subject: [PATCH] Backport: Improve rules for %-expansion of username. Validate
 control chars in usernames, avoid percent expansion for command line or
 default users; expand only configuration-specified users without using %r/%C;
 update validation rules accordingly.

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/openssh/openssh-portable/commit/35d5917652106aede47621bb3f64044604164043.patch

---
 ssh.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/ssh.c b/ssh.c
index 0019281..182c7c3 100644
--- a/ssh.c
+++ b/ssh.c
@@ -649,6 +649,8 @@ valid_ruser(const char *s)
 	if (*s == '-')
 		return 0;
 	for (i = 0; s[i] != 0; i++) {
+		if (iscntrl((u_char)s[i]))
+			return 0;
 		if (strchr("'`\";&<>|(){}", s[i]) != NULL)
 			return 0;
 		/* Disallow '-' after whitespace */
-- 
2.43.0

