From 5d8f932168191013c310a4e81fe401d0d9bd5682 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Mon, 9 Feb 2026 08:32:04 +0000
Subject: [PATCH] Backport: Always validate header values from untrusted
 sources; add trusted_value to append/replace_common and update call sites
 (partial)

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://gitlab.gnome.org/GNOME/libsoup/-/merge_requests/498.patch
---
 libsoup/auth/soup-auth-manager.c              |  2 +-
 libsoup/auth/soup-auth-ntlm.c                 |  2 +-
 .../content-decoder/soup-content-decoder.c    |  2 +-
 libsoup/server/soup-server-message.c          |  4 +-
 libsoup/soup-message-headers-private.h        |  8 ++--
 libsoup/soup-message-headers.c                | 41 ++++++++++++++++---
 6 files changed, 45 insertions(+), 14 deletions(-)

diff --git a/libsoup/auth/soup-auth-manager.c b/libsoup/auth/soup-auth-manager.c
index 402967d..1800190 100644
--- a/libsoup/auth/soup-auth-manager.c
+++ b/libsoup/auth/soup-auth-manager.c
@@ -441,7 +441,7 @@ update_authorization_header (SoupMessage *msg, SoupAuth *auth, gboolean is_proxy
 	if (!token)
 		return;
 
-	soup_message_headers_replace_common (soup_message_get_request_headers (msg), authorization_header, token);
+	soup_message_headers_replace_common (soup_message_get_request_headers (msg), authorization_header, token, TRUE);
 	g_free (token);
 }
 
diff --git a/libsoup/auth/soup-auth-ntlm.c b/libsoup/auth/soup-auth-ntlm.c
index 7108a32..b4fc1d1 100644
--- a/libsoup/auth/soup-auth-ntlm.c
+++ b/libsoup/auth/soup-auth-ntlm.c
@@ -328,7 +328,7 @@ soup_auth_ntlm_update_connection (SoupConnectionAuth *auth, SoupMessage *msg,
 			conn->state = SOUP_NTLM_FAILED;
 			if (soup_message_is_keepalive (msg)) {
 				soup_message_headers_append_common (soup_message_get_response_headers (msg),
-                                                                    SOUP_HEADER_CONNECTION, "close");
+                                                                    SOUP_HEADER_CONNECTION, "close", TRUE);
 			}
 			return TRUE;
 		}
diff --git a/libsoup/content-decoder/soup-content-decoder.c b/libsoup/content-decoder/soup-content-decoder.c
index f75ebce..2fdad66 100644
--- a/libsoup/content-decoder/soup-content-decoder.c
+++ b/libsoup/content-decoder/soup-content-decoder.c
@@ -249,7 +249,7 @@ soup_content_decoder_request_queued (SoupSessionFeature *feature,
 #endif
 
 		soup_message_headers_append_common (soup_message_get_request_headers (msg),
-                                                    SOUP_HEADER_ACCEPT_ENCODING, header);
+                                                    SOUP_HEADER_ACCEPT_ENCODING, header, TRUE);
 	}
 }
 
diff --git a/libsoup/server/soup-server-message.c b/libsoup/server/soup-server-message.c
index 1450b04..1d372a4 100644
--- a/libsoup/server/soup-server-message.c
+++ b/libsoup/server/soup-server-message.c
@@ -939,7 +939,7 @@ soup_server_message_set_response (SoupServerMessage *msg,
 
                 soup_message_headers_replace_common (msg->response_headers,
                                                      SOUP_HEADER_CONTENT_TYPE,
-                                                     content_type);
+                                                     content_type, FALSE);
                 soup_message_body_append (msg->response_body, resp_use,
                                           resp_body, resp_length);
         } else {
@@ -980,7 +980,7 @@ soup_server_message_set_redirect (SoupServerMessage *msg,
 	soup_server_message_set_status (msg, status_code, NULL);
 	location_str = g_uri_to_string (location);
 	soup_message_headers_replace_common (msg->response_headers, SOUP_HEADER_LOCATION,
-                                             location_str);
+                                             location_str, FALSE);
 	g_free (location_str);
 	g_uri_unref (location);
 }
diff --git a/libsoup/soup-message-headers-private.h b/libsoup/soup-message-headers-private.h
index 9815464..ae7932a 100644
--- a/libsoup/soup-message-headers-private.h
+++ b/libsoup/soup-message-headers-private.h
@@ -13,9 +13,10 @@ G_BEGIN_DECLS
 void        soup_message_headers_append_untrusted_data  (SoupMessageHeaders *hdrs,
                                                          const char         *name,
                                                          const char         *value);
-void        soup_message_headers_append_common          (SoupMessageHeaders *hdrs,
+gboolean    soup_message_headers_append_common          (SoupMessageHeaders *hdrs,
                                                          SoupHeaderName      name,
-                                                         const char         *value);
+                                                         const char         *value,
+                                                         gboolean            trusted_value);
 const char *soup_message_headers_get_one_common         (SoupMessageHeaders *hdrs,
                                                          SoupHeaderName      name);
 const char *soup_message_headers_get_list_common        (SoupMessageHeaders *hdrs,
@@ -24,7 +25,8 @@ void        soup_message_headers_remove_common          (SoupMessageHeaders *hdr
                                                          SoupHeaderName      name);
 void        soup_message_headers_replace_common         (SoupMessageHeaders *hdrs,
                                                          SoupHeaderName      name,
-                                                         const char         *value);
+                                                         const char         *value,
+                                                         gboolean            trusted_value);
 gboolean    soup_message_headers_header_contains_common (SoupMessageHeaders *hdrs,
                                                          SoupHeaderName      name,
                                                          const char         *token);
diff --git a/libsoup/soup-message-headers.c b/libsoup/soup-message-headers.c
index b7e7a23..b7815a8 100644
--- a/libsoup/soup-message-headers.c
+++ b/libsoup/soup-message-headers.c
@@ -241,12 +241,34 @@ soup_message_headers_clean_connection_headers (SoupMessageHeaders *hdrs)
 	soup_header_free_list (tokens);
 }
 
-void
+static inline gboolean is_valid_header_name (const char *name)
+{
+        return name && *name && strpbrk (name, " 	\r\n:") == NULL;
+}
+
+static inline gboolean is_valid_header_value (const char *value)
+{
+        return value && strpbrk (value, "\r\n") == NULL;
+}
+
+
+gboolean
 soup_message_headers_append_common (SoupMessageHeaders *hdrs,
                                     SoupHeaderName      name,
-                                    const char         *value)
+                                    const char         *value,
+                                    gboolean            trusted_value)
 {
         SoupCommonHeader header;
+        if (name == SOUP_HEADER_HOST && soup_message_headers_get_one (hdrs, "Host")) {
+                /* Replace host instead of appending it. */
+                soup_message_headers_replace_common (hdrs, SOUP_HEADER_HOST, value, trusted_value);
+                return FALSE;
+        }
+
+        if (!trusted_value && !is_valid_header_value (value)) {
+                g_warning ("soup_message_headers_append: Rejecting bad value '%s'", value);
+                return FALSE;
+        }
 
         if (!hdrs->common_headers)
                 hdrs->common_headers = g_array_sized_new (FALSE, FALSE, sizeof (SoupCommonHeader), 6);
@@ -258,6 +280,7 @@ soup_message_headers_append_common (SoupMessageHeaders *hdrs,
                 g_hash_table_remove (hdrs->common_concat, GUINT_TO_POINTER (header.name));
 
         soup_message_headers_set (hdrs, name, value);
+        return TRUE;
 }
 
 /**
@@ -306,7 +329,12 @@ soup_message_headers_append (SoupMessageHeaders *hdrs,
 
         header_name = soup_header_name_from_string (name);
         if (header_name != SOUP_HEADER_UNKNOWN) {
-                soup_message_headers_append_common (hdrs, header_name, value);
+                soup_message_headers_append_common (hdrs, header_name, value, FALSE);
+                return;
+        }
+
+        if (!is_valid_header_value (value)) {
+                g_warning ("soup_message_headers_append: Ignoring bad value '%s'", value);
                 return;
         }
 
@@ -338,10 +366,11 @@ soup_message_headers_append_untrusted_data (SoupMessageHeaders *hdrs,
 void
 soup_message_headers_replace_common (SoupMessageHeaders *hdrs,
                                      SoupHeaderName      name,
-                                     const char         *value)
+                                     const char         *value,
+                                     gboolean            trusted_value)
 {
         soup_message_headers_remove_common (hdrs, name);
-        soup_message_headers_append_common (hdrs, name, value);
+        soup_message_headers_append_common (hdrs, name, value, trusted_value);
 }
 
 /**
@@ -975,7 +1004,7 @@ soup_message_headers_set_encoding (SoupMessageHeaders *hdrs,
 
 	case SOUP_ENCODING_CHUNKED:
 		soup_message_headers_remove_common (hdrs, SOUP_HEADER_CONTENT_LENGTH);
-		soup_message_headers_replace_common (hdrs, SOUP_HEADER_TRANSFER_ENCODING, "chunked");
+		soup_message_headers_replace_common (hdrs, SOUP_HEADER_TRANSFER_ENCODING, "chunked", TRUE);
 		break;
 
 	default:
-- 
2.45.4

