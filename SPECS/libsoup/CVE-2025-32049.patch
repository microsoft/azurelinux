From db87805ab565d67533dfed2cb409dbfd63c7fdce Mon Sep 17 00:00:00 2001
From: Ignacio Casal Quinteiro <qignacio@amazon.com>
Date: Wed, 24 Jul 2024 15:20:35 +0200
Subject: [PATCH 1/4] websocket: add a way to restrict the total message size

Otherwise a client could send small packages smaller than
total-incoming-payload-size but still to break the server
with a big allocation

Fixes: #390
Upstream Patch Reference: https://gitlab.gnome.org/GNOME/libsoup/-/merge_requests/408.patch
---
 libsoup/server/soup-server.c                  |  24 +-
 libsoup/websocket/soup-websocket-connection.c | 136 +++++++++--
 libsoup/websocket/soup-websocket-connection.h |   7 +
 tests/websocket-test.c                        | 212 ++++++++++++++++--
 4 files changed, 347 insertions(+), 32 deletions(-)

diff --git a/libsoup/server/soup-server.c b/libsoup/server/soup-server.c
index 80e6712..efdf7f2 100644
--- a/libsoup/server/soup-server.c
+++ b/libsoup/server/soup-server.c
@@ -197,6 +197,16 @@ static GParamSpec *properties[LAST_PROPERTY] = { NULL, };
 
 G_DEFINE_TYPE_WITH_PRIVATE (SoupServer, soup_server, G_TYPE_OBJECT)
 
+/* SoupWebsocketConnection by default limits only maximum packet size. But a
+ * message may consist of multiple packets, so SoupServer additionally restricts
+ * total message size to mitigate denial of service attacks on the server.
+ * SoupWebsocketConnection does not do this by default because I don't know
+ * whether that would or would not cause compatibility problems for websites.
+ *
+ * This size is in bytes and it is arbitrary.
+ */
+#define MAX_TOTAL_MESSAGE_SIZE_DEFAULT   128 * 1024
+
 static void start_request (SoupServer        *server,
 			   SoupServerMessage *msg);
 static void
@@ -931,11 +941,15 @@ complete_websocket_upgrade (SoupServer        *server,
 
 	g_object_ref (msg);
 	stream = soup_server_message_steal_connection (msg);
-	conn = soup_websocket_connection_new (stream, uri,
-					      SOUP_WEBSOCKET_CONNECTION_SERVER,
-					      soup_message_headers_get_one_common (soup_server_message_get_request_headers (msg), SOUP_HEADER_ORIGIN),
-					      soup_message_headers_get_one_common (soup_server_message_get_response_headers (msg), SOUP_HEADER_SEC_WEBSOCKET_PROTOCOL),
-					      handler->websocket_extensions);
+	conn = conn = SOUP_WEBSOCKET_CONNECTION (g_object_new (SOUP_TYPE_WEBSOCKET_CONNECTION,
+					  "io-stream", stream,
+					  "uri", uri,
+					  "connection-type", SOUP_WEBSOCKET_CONNECTION_SERVER,
+					  "origin", soup_message_headers_get_one_common (soup_server_message_get_request_headers (msg), SOUP_HEADER_ORIGIN),
+					  "protocol", soup_message_headers_get_one_common (soup_server_message_get_response_headers (msg), SOUP_HEADER_SEC_WEBSOCKET_PROTOCOL),
+					  "extensions", handler->websocket_extensions,
+					  "max-total-message-size", (guint64)MAX_TOTAL_MESSAGE_SIZE_DEFAULT,
+					  NULL));
 	handler->websocket_extensions = NULL;
 	g_object_unref (stream);
 
diff --git a/libsoup/websocket/soup-websocket-connection.c b/libsoup/websocket/soup-websocket-connection.c
index 5eb8150..ef54ab6 100644
--- a/libsoup/websocket/soup-websocket-connection.c
+++ b/libsoup/websocket/soup-websocket-connection.c
@@ -84,6 +84,7 @@ enum {
 	PROP_MAX_INCOMING_PAYLOAD_SIZE,
 	PROP_KEEPALIVE_INTERVAL,
 	PROP_EXTENSIONS,
+	PROP_MAX_TOTAL_MESSAGE_SIZE,
 
         LAST_PROPERTY
 };
@@ -127,6 +128,7 @@ typedef struct {
 	char *protocol;
 	guint64 max_incoming_payload_size;
 	guint keepalive_interval;
+	guint64 max_total_message_size;
 
 	gushort peer_close_code;
 	char *peer_close_data;
@@ -670,20 +672,38 @@ bad_data_error_and_close (SoupWebsocketConnection *self)
 }
 
 static void
-too_big_error_and_close (SoupWebsocketConnection *self,
-                         guint64 payload_len)
+too_big_incoming_payload_error_and_close (SoupWebsocketConnection *self,
+                                          guint64 payload_len)
 {
-        SoupWebsocketConnectionPrivate *priv = soup_websocket_connection_get_instance_private (self);
+	SoupWebsocketConnectionPrivate *priv = soup_websocket_connection_get_instance_private (self);
+	GError *error;
+
+	error = g_error_new_literal (SOUP_WEBSOCKET_ERROR,
+				     SOUP_WEBSOCKET_CLOSE_TOO_BIG,
+				     priv->connection_type == SOUP_WEBSOCKET_CONNECTION_SERVER ?
+				     "Received WebSocket payload from the client larger than configured max-total-message-size" :
+				     "Received WebSocket payload from the server larger than configured max-total-message-size");
+	g_debug ("%s received message of size %" G_GUINT64_FORMAT " or greater, but max supported size is %" G_GUINT64_FORMAT,
+	         priv->connection_type == SOUP_WEBSOCKET_CONNECTION_SERVER ? "server" : "client",
+	         payload_len, priv->max_total_message_size);
+	emit_error_and_close (self, error, TRUE);
+}
+
+static void
+too_big_message_error_and_close (SoupWebsocketConnection *self,
+                                 guint64 len)
+{
+	SoupWebsocketConnectionPrivate *priv = soup_websocket_connection_get_instance_private (self);
 	GError *error;
 
 	error = g_error_new_literal (SOUP_WEBSOCKET_ERROR,
 				     SOUP_WEBSOCKET_CLOSE_TOO_BIG,
 				     priv->connection_type == SOUP_WEBSOCKET_CONNECTION_SERVER ?
-				     "Received WebSocket payload from the client larger than configured max-incoming-payload-size" :
-				     "Received WebSocket payload from the server larger than configured max-incoming-payload-size");
-	g_debug ("%s is trying to frame of size %" G_GUINT64_FORMAT " or greater, but max supported size is %" G_GUINT64_FORMAT,
-		 priv->connection_type == SOUP_WEBSOCKET_CONNECTION_SERVER ? "server" : "client",
-	         payload_len, priv->max_incoming_payload_size);
+				     "Received WebSocket payload from the client larger than configured max-total-message-size" :
+				     "Received WebSocket payload from the server larger than configured max-total-message-size");
+	g_debug ("%s received message of size %" G_GUINT64_FORMAT " or greater, but max supported size is %" G_GUINT64_FORMAT,
+	         priv->connection_type == SOUP_WEBSOCKET_CONNECTION_SERVER ? "server" : "client",
+	         len, priv->max_total_message_size);
 	emit_error_and_close (self, error, TRUE);
 }
 
@@ -918,6 +938,12 @@ process_contents (SoupWebsocketConnection *self,
 		switch (priv->message_opcode) {
 		case 0x01:
 		case 0x02:
+		        /* Safety valve */
+			if (priv->max_total_message_size > 0 &&
+			    (priv->message_data->len + payload_len) > priv->max_total_message_size) {
+				too_big_message_error_and_close (self, (priv->message_data->len + payload_len));
+				return;
+			}
 			g_byte_array_append (priv->message_data, payload, payload_len);
 			break;
 		default:
@@ -1056,7 +1082,7 @@ process_frame (SoupWebsocketConnection *self)
 	/* Safety valve */
 	if (priv->max_incoming_payload_size > 0 &&
 	    payload_len > priv->max_incoming_payload_size) {
-		too_big_error_and_close (self, payload_len);
+		too_big_incoming_payload_error_and_close (self, payload_len);
 		return FALSE;
 	}
 
@@ -1363,6 +1389,10 @@ soup_websocket_connection_get_property (GObject *object,
 		g_value_set_pointer (value, priv->extensions);
 		break;
 
+	case PROP_MAX_TOTAL_MESSAGE_SIZE:
+		g_value_set_uint64 (value, priv->max_total_message_size);
+		break;
+
 	default:
 		G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
 		break;
@@ -1416,6 +1446,10 @@ soup_websocket_connection_set_property (GObject *object,
 		priv->extensions = g_value_get_pointer (value);
 		break;
 
+	case PROP_MAX_TOTAL_MESSAGE_SIZE:
+		priv->max_total_message_size = g_value_get_uint64 (value);
+		break;
+
 	default:
 		G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
 		break;
@@ -1580,10 +1614,11 @@ soup_websocket_connection_class_init (SoupWebsocketConnectionClass *klass)
 	/**
 	 * SoupWebsocketConnection:max-incoming-payload-size:
 	 *
-	 * The maximum payload size for incoming packets the protocol expects
-	 * or 0 to not limit it.
+         * The maximum payload size for incoming packets, or 0 to not limit it.                 
 	 *
-	 */
+         * * Each message may consist of multiple packets, so also refer to             
+	 * [property@WebSocketConnection:max-total-message-size].
+         */ 
         properties[PROP_MAX_INCOMING_PAYLOAD_SIZE] =
                 g_param_spec_uint64 ("max-incoming-payload-size",
                                      "Max incoming payload size",
@@ -1627,8 +1662,38 @@ soup_websocket_connection_class_init (SoupWebsocketConnectionClass *klass)
                                       G_PARAM_READWRITE |
                                       G_PARAM_CONSTRUCT_ONLY |
                                       G_PARAM_STATIC_STRINGS);
+ 
+	/**
+	 * SoupWebsocketConnection:max-total-message-size:
+	 *
+	 * The maximum size for incoming messages.
+	 *
+	 * Set to a value to limit the total message size, or 0 to not
+	 * limit it.
+	 *
+	 * [method@Server.add_websocket_handler] will set this to a nonzero
+	 * default value to mitigate denial of service attacks. Clients must
+	 * choose their own default if they need to mitigate denial of service
+	 * attacks. You also need to set your own default if creating your own
+	 * server SoupWebsocketConnection without using SoupServer.
+	 *
+	 * Each message may consist of multiple packets, so also refer to
+	 * [property@WebSocketConnection:max-incoming-payload-size].
+	 *
+	 * Since: 3.8
+	 */
+        properties[PROP_MAX_TOTAL_MESSAGE_SIZE] =
+                g_param_spec_uint64 ("max-total-message-size",
+                                     "Max total message size",
+                                     "Max total message size ",
+                                     0,
+                                     G_MAXUINT64,
+                                     0,
+                                     G_PARAM_READWRITE |
+                                     G_PARAM_CONSTRUCT |
+                                     G_PARAM_STATIC_STRINGS);
 
-        g_object_class_install_properties (gobject_class, LAST_PROPERTY, properties);
+	 g_object_class_install_properties (gobject_class, LAST_PROPERTY, properties);
 
 	/**
 	 * SoupWebsocketConnection::message:
@@ -2111,6 +2176,51 @@ soup_websocket_connection_set_max_incoming_payload_size (SoupWebsocketConnection
 	}
 }
 
+/**
+ * soup_websocket_connection_get_max_total_message_size:
+ * @self: the WebSocket
+ *
+ * Gets the maximum total message size allowed for packets.
+ *
+ * Returns: the maximum total message size.
+ *
+ * Since: 3.8
+ */
+guint64
+soup_websocket_connection_get_max_total_message_size (SoupWebsocketConnection *self)
+{
+	SoupWebsocketConnectionPrivate *priv = soup_websocket_connection_get_instance_private (self);
+
+	g_return_val_if_fail (SOUP_IS_WEBSOCKET_CONNECTION (self), 0);
+
+	return priv->max_total_message_size;
+}
+
+/**
+ * soup_websocket_connection_set_max_total_message_size:
+ * @self: the WebSocket
+ * @max_total_message_size: the maximum total message size
+ *
+ * Sets the maximum total message size allowed for packets.
+ *
+ * It does not limit the outgoing packet size.
+ *
+ * Since: 3.8
+ */
+void
+soup_websocket_connection_set_max_total_message_size (SoupWebsocketConnection *self,
+                                                      guint64                  max_total_message_size)
+{
+	SoupWebsocketConnectionPrivate *priv = soup_websocket_connection_get_instance_private (self);
+
+	g_return_if_fail (SOUP_IS_WEBSOCKET_CONNECTION (self));
+
+	if (priv->max_total_message_size != max_total_message_size) {
+		priv->max_total_message_size = max_total_message_size;
+		g_object_notify_by_pspec (G_OBJECT (self), properties[PROP_MAX_TOTAL_MESSAGE_SIZE]);
+	}
+}
+
 /**
  * soup_websocket_connection_get_keepalive_interval:
  * @self: the WebSocket
diff --git a/libsoup/websocket/soup-websocket-connection.h b/libsoup/websocket/soup-websocket-connection.h
index eeb093d..81fa142 100644
--- a/libsoup/websocket/soup-websocket-connection.h
+++ b/libsoup/websocket/soup-websocket-connection.h
@@ -88,6 +88,13 @@ SOUP_AVAILABLE_IN_ALL
 void                soup_websocket_connection_set_max_incoming_payload_size (SoupWebsocketConnection *self,
                                                                              guint64                  max_incoming_payload_size);
 
+SOUP_AVAILABLE_IN_3_0
+guint64             soup_websocket_connection_get_max_total_message_size    (SoupWebsocketConnection *self);
+
+SOUP_AVAILABLE_IN_3_0
+void                soup_websocket_connection_set_max_total_message_size    (SoupWebsocketConnection *self,
+                                                                             guint64                  max_total_message_size);
+
 SOUP_AVAILABLE_IN_ALL
 guint               soup_websocket_connection_get_keepalive_interval (SoupWebsocketConnection *self);
 
diff --git a/tests/websocket-test.c b/tests/websocket-test.c
index a0b8334..a7fc7e9 100644
--- a/tests/websocket-test.c
+++ b/tests/websocket-test.c
@@ -543,10 +543,11 @@ test_send_big_packets (Test *test,
 {
 	GBytes *sent = NULL;
 	GBytes *received = NULL;
+	gulong signal_id;
 
-	g_signal_connect (test->client, "message", G_CALLBACK (on_text_message), &received);
+	signal_id = g_signal_connect (test->client, "message", G_CALLBACK (on_text_message), &received);
 
-	sent = g_bytes_new_take (g_strnfill (400, '!'), 400);
+	sent = g_bytes_new_take (g_strnfill (100 * 1000, '?'), 100 * 1000);
 	soup_websocket_connection_send_text (test->server, g_bytes_get_data (sent, NULL));
 	WAIT_UNTIL (received != NULL);
 	g_assert (g_bytes_equal (sent, received));
@@ -554,27 +555,174 @@ test_send_big_packets (Test *test,
 	g_bytes_unref (received);
 	received = NULL;
 
-	sent = g_bytes_new_take (g_strnfill (100 * 1000, '?'), 100 * 1000);
+	soup_websocket_connection_set_max_incoming_payload_size (test->client, 1000 * 1000 + 1);
+	g_assert_cmpuint (soup_websocket_connection_get_max_incoming_payload_size (test->client), ==, 1000 * 1000 + 1);
+	soup_websocket_connection_set_max_incoming_payload_size (test->server, 1000 * 1000 + 1);
+	g_assert_cmpuint (soup_websocket_connection_get_max_incoming_payload_size (test->server), ==, 1000 * 1000 + 1);
+
+	soup_websocket_connection_set_max_total_message_size (test->client, 1000 * 1000 + 1);
+	g_assert_cmpuint (soup_websocket_connection_get_max_total_message_size (test->client), ==, 1000 * 1000 + 1);
+	soup_websocket_connection_set_max_total_message_size (test->server, 1000 * 1000 + 1);
+	g_assert_cmpuint (soup_websocket_connection_get_max_total_message_size (test->server), ==, 1000 * 1000 + 1);
+
+	sent = g_bytes_new_take (g_strnfill (1000 * 1000, '?'), 1000 * 1000);
 	soup_websocket_connection_send_text (test->server, g_bytes_get_data (sent, NULL));
 	WAIT_UNTIL (received != NULL);
 	g_assert (g_bytes_equal (sent, received));
-	g_bytes_unref (sent);
 	g_bytes_unref (received);
 	received = NULL;
 
-	soup_websocket_connection_set_max_incoming_payload_size (test->client, 1000 * 1000 + 1);
-	g_assert (soup_websocket_connection_get_max_incoming_payload_size (test->client) == (1000 * 1000 + 1));
-	soup_websocket_connection_set_max_incoming_payload_size (test->server, 1000 * 1000 + 1);
-	g_assert (soup_websocket_connection_get_max_incoming_payload_size (test->server) == (1000 * 1000 + 1));
+        /* Reverse the test and send the big message to the server. */
+	g_signal_handler_disconnect (test->client, signal_id);
+	g_signal_connect (test->server, "message", G_CALLBACK (on_text_message), &received);
 
-	sent = g_bytes_new_take (g_strnfill (1000 * 1000, '?'), 1000 * 1000);
-	soup_websocket_connection_send_text (test->server, g_bytes_get_data (sent, NULL));
+	soup_websocket_connection_send_text (test->client, g_bytes_get_data (sent, NULL));
 	WAIT_UNTIL (received != NULL);
 	g_assert (g_bytes_equal (sent, received));
 	g_bytes_unref (sent);
 	g_bytes_unref (received);
 }
 
+static void
+test_send_big_packets_direct (Test *test,
+                              gconstpointer data)
+{
+	g_assert_cmpuint (soup_websocket_connection_get_max_incoming_payload_size (test->client), ==, 128 * 1024);
+	g_assert_cmpuint (soup_websocket_connection_get_max_total_message_size (test->client), ==, 0);
+
+	g_assert_cmpuint (soup_websocket_connection_get_max_incoming_payload_size (test->server), ==, 128 * 1024);
+	g_assert_cmpuint (soup_websocket_connection_get_max_total_message_size (test->server), ==, 0);
+
+	test_send_big_packets (test, data);
+}
+
+static void
+test_send_big_packets_soup (Test *test,
+                            gconstpointer data)
+{
+	g_assert_cmpuint (soup_websocket_connection_get_max_incoming_payload_size (test->client), ==, 128 * 1024);
+	g_assert_cmpuint (soup_websocket_connection_get_max_total_message_size (test->client), ==, 0);
+
+	/* Max total message size defaults to 0 (unlimited), but SoupServer applies its own limit by default. */
+	g_assert_cmpuint (soup_websocket_connection_get_max_incoming_payload_size (test->server), ==, 128 * 1024);
+	g_assert_cmpuint (soup_websocket_connection_get_max_total_message_size (test->server), ==, 128 * 1024);
+
+	test_send_big_packets (test, data);
+}
+
+static void
+test_send_exceeding_client_max_payload_size (Test *test,
+                                             gconstpointer data)
+{
+	GBytes *sent = NULL;
+	GBytes *received = NULL;
+	gboolean close_event = FALSE;
+	GError *error = NULL;
+
+	g_signal_connect (test->server, "error", G_CALLBACK (on_error_copy), &error);
+	g_signal_connect (test->client, "closed", G_CALLBACK (on_close_set_flag), &close_event);
+
+	g_assert_cmpuint (soup_websocket_connection_get_max_incoming_payload_size (test->client), ==, 128 * 1024);
+
+	soup_websocket_connection_set_max_incoming_payload_size (test->server, 0);
+	g_assert_cmpuint (soup_websocket_connection_get_max_incoming_payload_size (test->server), ==, 0);
+
+	/* The message to the client is dropped due to the client's limit. */
+	sent = g_bytes_new_take (g_strnfill (1000 * 1000, '?'), 1000 * 1000);
+	soup_websocket_connection_send_text (test->server, g_bytes_get_data (sent, NULL));
+	g_bytes_unref (sent);
+	WAIT_UNTIL (close_event);
+	g_assert_null (received);
+	g_assert_error (error, G_IO_ERROR, G_IO_ERROR_CONNECTION_CLOSED);
+	g_assert_no_error (test->client_error);
+}
+
+static void
+test_send_exceeding_server_max_payload_size (Test *test,
+                                             gconstpointer data)
+{
+	GBytes *sent = NULL;
+	GBytes *received = NULL;
+	gboolean close_event = FALSE;
+	GError *error = NULL;
+
+	g_signal_connect (test->client, "error", G_CALLBACK (on_error_copy), &error);
+	g_signal_connect (test->server, "closed", G_CALLBACK (on_close_set_flag), &close_event);
+
+	soup_websocket_connection_set_max_incoming_payload_size (test->client, 0);
+	g_assert_cmpuint (soup_websocket_connection_get_max_incoming_payload_size (test->client), ==, 0);
+
+	g_assert_cmpuint (soup_websocket_connection_get_max_incoming_payload_size (test->server), ==, 128 * 1024);
+
+	/* The message to the server is dropped due to the server's limit. */
+	sent = g_bytes_new_take (g_strnfill (1000 * 1000, '?'), 1000 * 1000);
+	soup_websocket_connection_send_text (test->client, g_bytes_get_data (sent, NULL));
+	g_bytes_unref (sent);
+	WAIT_UNTIL (close_event);
+	g_assert_null (received);
+	g_assert_error (error, G_IO_ERROR, G_IO_ERROR_CONNECTION_CLOSED);
+	g_assert_no_error (test->client_error);
+}
+
+static void
+test_send_exceeding_client_max_message_size (Test *test,
+                                             gconstpointer data)
+{
+	GBytes *sent = NULL;
+	GBytes *received = NULL;
+	gboolean close_event = FALSE;
+	GError *error = NULL;
+
+	g_signal_connect (test->server, "error", G_CALLBACK (on_error_copy), &error);
+	g_signal_connect (test->client, "closed", G_CALLBACK (on_close_set_flag), &close_event);
+
+	soup_websocket_connection_set_max_total_message_size (test->client, 128 * 1024);
+	g_assert_cmpuint (soup_websocket_connection_get_max_total_message_size (test->client), ==, 128 * 1024);
+
+	soup_websocket_connection_set_max_total_message_size (test->server, 0);
+	g_assert_cmpuint (soup_websocket_connection_get_max_total_message_size (test->server), ==, 0);
+
+	/* The message to the client is dropped due to the client's limit. */
+	sent = g_bytes_new_take (g_strnfill (1000 * 1000, '?'), 1000 * 1000);
+	soup_websocket_connection_send_text (test->server, g_bytes_get_data (sent, NULL));
+	g_bytes_unref (sent);
+	WAIT_UNTIL (close_event);
+	g_assert_null (received);
+	g_assert_error (error, G_IO_ERROR, G_IO_ERROR_CONNECTION_CLOSED);
+	g_assert_no_error (test->client_error);
+}
+
+static void
+test_send_exceeding_server_max_message_size (Test *test,
+                                             gconstpointer data)
+{
+	GBytes *sent = NULL;
+	GBytes *received = NULL;
+	gboolean close_event = FALSE;
+	GError *error = NULL;
+
+	g_signal_connect (test->client, "error", G_CALLBACK (on_error_copy), &error);
+	g_signal_connect (test->server, "closed", G_CALLBACK (on_close_set_flag), &close_event);
+
+	soup_websocket_connection_set_max_total_message_size (test->client, 0);
+	g_assert_cmpuint (soup_websocket_connection_get_max_total_message_size (test->client), ==, 0);
+
+	/* Set the server message total message size manually, because its
+	 * default is different for direct connection vs. soup connection.
+	 */
+	soup_websocket_connection_set_max_total_message_size (test->server, 128 * 1024);
+	g_assert_cmpuint (soup_websocket_connection_get_max_total_message_size (test->server), ==, 128 * 1024);
+
+	/* The message to the server is dropped due to the server's limit. */
+	sent = g_bytes_new_take (g_strnfill (1000 * 1000, '?'), 1000 * 1000);
+	soup_websocket_connection_send_text (test->client, g_bytes_get_data (sent, NULL));
+	g_bytes_unref (sent);
+	WAIT_UNTIL (close_event);
+	g_assert_null (received);
+	g_assert_error (error, G_IO_ERROR, G_IO_ERROR_CONNECTION_CLOSED);
+	g_assert_no_error (test->client_error);
+}
+
 static void
 test_send_empty_packets (Test *test,
 			 gconstpointer data)
@@ -2059,11 +2207,47 @@ main (int argc,
 
 	g_test_add ("/websocket/direct/send-big-packets", Test, NULL,
 		    setup_direct_connection,
-		    test_send_big_packets,
+		    test_send_big_packets_direct,
 		    teardown_direct_connection);
 	g_test_add ("/websocket/soup/send-big-packets", Test, NULL,
 		    setup_soup_connection,
-		    test_send_big_packets,
+		    test_send_big_packets_soup,
+		    teardown_soup_connection);
+
+	g_test_add ("/websocket/direct/send-exceeding-client-max-payload-size", Test, NULL,
+		    setup_direct_connection,
+		    test_send_exceeding_client_max_payload_size,
+		    teardown_direct_connection);
+	g_test_add ("/websocket/soup/send-exceeding-client-max-payload-size", Test, NULL,
+		    setup_soup_connection,
+		    test_send_exceeding_client_max_payload_size,
+		    teardown_soup_connection);
+
+	g_test_add ("/websocket/direct/send-exceeding-server-max-payload-size", Test, NULL,
+		    setup_direct_connection,
+		    test_send_exceeding_server_max_payload_size,
+		    teardown_direct_connection);
+	g_test_add ("/websocket/soup/send-exceeding-server-max-payload-size", Test, NULL,
+		    setup_soup_connection,
+		    test_send_exceeding_server_max_payload_size,
+		    teardown_soup_connection);
+
+	g_test_add ("/websocket/direct/send-exceeding-client-max-message-size", Test, NULL,
+		    setup_direct_connection,
+		    test_send_exceeding_client_max_message_size,
+		    teardown_direct_connection);
+	g_test_add ("/websocket/soup/send-exceeding-client-max-message-size", Test, NULL,
+		    setup_soup_connection,
+		    test_send_exceeding_client_max_message_size,
+		    teardown_soup_connection);
+
+	g_test_add ("/websocket/direct/send-exceeding-server-max-message-size", Test, NULL,
+		    setup_direct_connection,
+		    test_send_exceeding_server_max_message_size,
+		    teardown_direct_connection);
+	g_test_add ("/websocket/soup/send-exceeding-server-max-message-size", Test, NULL,
+		    setup_soup_connection,
+		    test_send_exceeding_server_max_message_size,
 		    teardown_soup_connection);
 
 	g_test_add ("/websocket/direct/send-empty-packets", Test, NULL,
@@ -2212,11 +2396,11 @@ main (int argc,
 
 	g_test_add ("/websocket/direct/deflate-send-big-packets", Test, NULL,
 		    setup_direct_connection_with_extensions,
-		    test_send_big_packets,
+		    test_send_big_packets_direct,
 		    teardown_direct_connection);
 	g_test_add ("/websocket/soup/deflate-send-big-packets", Test, NULL,
 		    setup_soup_connection_with_extensions,
-		    test_send_big_packets,
+		    test_send_big_packets_soup,
 		    teardown_soup_connection);
 
 	g_test_add ("/websocket/direct/deflate-send-empty-packets", Test, NULL,
-- 
2.45.4

