From 225bf4a406f949dc9f175a071a71686de016c466 Mon Sep 17 00:00:00 2001
From: Ignacio Casal Quinteiro <qignacio@amazon.com>
Date: Wed, 24 Jul 2024 15:20:35 +0200
Subject: [PATCH 1/4] websocket: add a way to restrict the total message size

Otherwise a client could send small packages smaller than
total-incoming-payload-size but still to break the server
with a big allocation

Fixes: #390
---
 libsoup/websocket/soup-websocket-connection.c | 106 +++++++++++++++++-
 libsoup/websocket/soup-websocket-connection.h |   7 ++
 2 files changed, 110 insertions(+), 3 deletions(-)

diff --git a/libsoup/websocket/soup-websocket-connection.c b/libsoup/websocket/soup-websocket-connection.c
index df8f67d..51971db 100644
--- a/libsoup/websocket/soup-websocket-connection.c
+++ b/libsoup/websocket/soup-websocket-connection.c
@@ -76,6 +76,7 @@ enum {
 	PROP_MAX_INCOMING_PAYLOAD_SIZE,
 	PROP_KEEPALIVE_INTERVAL,
 	PROP_EXTENSIONS,
+	PROP_MAX_TOTAL_MESSAGE_SIZE,
 
         LAST_PROPERTY
 };
@@ -118,6 +119,7 @@ typedef struct {
 	char *origin;
 	char *protocol;
 	guint64 max_incoming_payload_size;
+	guint64 max_total_message_size;
 	guint keepalive_interval;
 
 	gushort peer_close_code;
@@ -148,6 +150,7 @@ typedef struct {
 } SoupWebsocketConnectionPrivate;
 
 #define MAX_INCOMING_PAYLOAD_SIZE_DEFAULT   128 * 1024
+#define MAX_TOTAL_MESSAGE_SIZE_DEFAULT   128 * 1024
 #define READ_BUFFER_SIZE 1024
 #define MASK_LENGTH 4
 
@@ -677,8 +680,8 @@ bad_data_error_and_close (SoupWebsocketConnection *self)
 }
 
 static void
-too_big_error_and_close (SoupWebsocketConnection *self,
-                         guint64 payload_len)
+too_big_incoming_payload_error_and_close (SoupWebsocketConnection *self,
+                                          guint64 payload_len)
 {
         SoupWebsocketConnectionPrivate *priv = soup_websocket_connection_get_instance_private (self);
 	GError *error;
@@ -694,6 +697,24 @@ too_big_error_and_close (SoupWebsocketConnection *self,
 	emit_error_and_close (self, error, TRUE);
 }
 
+static void
+too_big_message_error_and_close (SoupWebsocketConnection *self,
+                                 guint64 len)
+{
+	SoupWebsocketConnectionPrivate *priv = soup_websocket_connection_get_instance_private (self);
+	GError *error;
+
+	error = g_error_new_literal (SOUP_WEBSOCKET_ERROR,
+				     SOUP_WEBSOCKET_CLOSE_TOO_BIG,
+				     priv->connection_type == SOUP_WEBSOCKET_CONNECTION_SERVER ?
+				     "Received WebSocket payload from the client larger than configured max-total-message-size" :
+				     "Received WebSocket payload from the server larger than configured max-total-message-size");
+	g_debug ("%s received message of size %" G_GUINT64_FORMAT " or greater, but max supported size is %" G_GUINT64_FORMAT,
+	         priv->connection_type == SOUP_WEBSOCKET_CONNECTION_SERVER ? "server" : "client",
+	         len, priv->max_total_message_size);
+	emit_error_and_close (self, error, TRUE);
+}
+
 static void
 close_connection (SoupWebsocketConnection *self,
                   gushort                  code,
@@ -937,6 +958,12 @@ process_contents (SoupWebsocketConnection *self,
 		switch (priv->message_opcode) {
 		case 0x01:
 		case 0x02:
+			/* Safety valve */
+			if (priv->max_total_message_size > 0 &&
+			    (priv->message_data->len + payload_len) > priv->max_total_message_size) {
+				too_big_message_error_and_close (self, (priv->message_data->len + payload_len));
+				return;
+			}
 			g_byte_array_append (priv->message_data, payload, payload_len);
 			break;
 		default:
@@ -1075,7 +1102,7 @@ process_frame (SoupWebsocketConnection *self)
 	/* Safety valve */
 	if (priv->max_incoming_payload_size > 0 &&
 	    payload_len > priv->max_incoming_payload_size) {
-		too_big_error_and_close (self, payload_len);
+		too_big_incoming_payload_error_and_close (self, payload_len);
 		return FALSE;
 	}
 
@@ -1382,6 +1409,10 @@ soup_websocket_connection_get_property (GObject *object,
 		g_value_set_pointer (value, priv->extensions);
 		break;
 
+        case PROP_MAX_TOTAL_MESSAGE_SIZE:
+		g_value_set_uint64 (value, priv->max_total_message_size);
+		break;
+
 	default:
 		G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
 		break;
@@ -1435,6 +1466,10 @@ soup_websocket_connection_set_property (GObject *object,
 		priv->extensions = g_value_get_pointer (value);
 		break;
 
+	case PROP_MAX_TOTAL_MESSAGE_SIZE:
+		priv->max_total_message_size = g_value_get_uint64 (value);
+		break;
+
 	default:
 		G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
 		break;
@@ -1640,6 +1675,26 @@ soup_websocket_connection_class_init (SoupWebsocketConnectionClass *klass)
                                       G_PARAM_CONSTRUCT_ONLY |
                                       G_PARAM_STATIC_STRINGS);
 
+	/**
+	 * SoupWebsocketConnection:max-total-message-size:
+	 *
+	 * The total message size for incoming packets.
+	 *
+	 * The protocol expects or 0 to not limit it.
+	 *
+	 * Since: 3.8
+	 */
+        properties[PROP_MAX_TOTAL_MESSAGE_SIZE] =
+                g_param_spec_uint64 ("max-total-message-size",
+                                     "Max total message size",
+                                     "Max total message size ",
+                                     0,
+                                     G_MAXUINT64,
+                                     MAX_TOTAL_MESSAGE_SIZE_DEFAULT,
+                                     G_PARAM_READWRITE |
+                                     G_PARAM_CONSTRUCT |
+                                     G_PARAM_STATIC_STRINGS);
+
         g_object_class_install_properties (gobject_class, LAST_PROPERTY, properties);
 
 	/**
@@ -2110,6 +2165,51 @@ soup_websocket_connection_set_max_incoming_payload_size (SoupWebsocketConnection
 	}
 }
 
+/**
+ * soup_websocket_connection_get_max_total_message_size:
+ * @self: the WebSocket
+ *
+ * Gets the maximum total message size allowed for packets.
+ *
+ * Returns: the maximum total message size.
+ *
+ * Since: 3.8
+ */
+guint64
+soup_websocket_connection_get_max_total_message_size (SoupWebsocketConnection *self)
+{
+	SoupWebsocketConnectionPrivate *priv = soup_websocket_connection_get_instance_private (self);
+
+	g_return_val_if_fail (SOUP_IS_WEBSOCKET_CONNECTION (self), MAX_TOTAL_MESSAGE_SIZE_DEFAULT);
+
+	return priv->max_total_message_size;
+}
+
+/**
+ * soup_websocket_connection_set_max_total_message_size:
+ * @self: the WebSocket
+ * @max_total_message_size: the maximum total message size
+ *
+ * Sets the maximum total message size allowed for packets.
+ *
+ * It does not limit the outgoing packet size.
+ *
+ * Since: 3.8
+ */
+void
+soup_websocket_connection_set_max_total_message_size (SoupWebsocketConnection *self,
+                                                      guint64                  max_total_message_size)
+{
+	SoupWebsocketConnectionPrivate *priv = soup_websocket_connection_get_instance_private (self);
+
+	g_return_if_fail (SOUP_IS_WEBSOCKET_CONNECTION (self));
+
+	if (priv->max_total_message_size != max_total_message_size) {
+		priv->max_total_message_size = max_total_message_size;
+		g_object_notify_by_pspec (G_OBJECT (self), properties[PROP_MAX_TOTAL_MESSAGE_SIZE]);
+	}
+}
+
 /**
  * soup_websocket_connection_get_keepalive_interval:
  * @self: the WebSocket
diff --git a/libsoup/websocket/soup-websocket-connection.h b/libsoup/websocket/soup-websocket-connection.h
index eeb093d..922de56 100644
--- a/libsoup/websocket/soup-websocket-connection.h
+++ b/libsoup/websocket/soup-websocket-connection.h
@@ -88,6 +88,13 @@ SOUP_AVAILABLE_IN_ALL
 void                soup_websocket_connection_set_max_incoming_payload_size (SoupWebsocketConnection *self,
                                                                              guint64                  max_incoming_payload_size);
 
+SOUP_AVAILABLE_IN_3_8
+guint64             soup_websocket_connection_get_max_total_message_size    (SoupWebsocketConnection *self);
+
+SOUP_AVAILABLE_IN_3_8
+void                soup_websocket_connection_set_max_total_message_size    (SoupWebsocketConnection *self,
+                                                                             guint64                  max_total_message_size);
+
 SOUP_AVAILABLE_IN_ALL
 guint               soup_websocket_connection_get_keepalive_interval (SoupWebsocketConnection *self);
 
-- 
2.45.4


From 5780411bc181d9af5f15f6f3d078857af74dabeb Mon Sep 17 00:00:00 2001
From: Ignacio Casal Quinteiro <qignacio@amazon.com>
Date: Fri, 20 Sep 2024 12:12:38 +0200
Subject: [PATCH 2/4] websocket-test: set the total message size

This is required when sending a big amount of data
-- 
2.45.4


From 9422d1770b2fc9154f95649c50d6590ab7ee34e6 Mon Sep 17 00:00:00 2001
From: Michael Catanzaro <mcatanzaro@redhat.com>
Date: Thu, 8 May 2025 16:16:25 -0500
Subject: [PATCH 3/4] Set message size limit in SoupServer rather than
 SoupWebsocketConnection

We're not sure about the compatibility implications of having a default
size limit for clients.

Also not sure whether the server limit is actually set appropriately,
but there is probably very little server usage of
SoupWebsocketConnection in the wild, so it's not so likely to break
things.
---
 libsoup/server/soup-server.c                  | 24 +++++++++++++++----
 libsoup/websocket/soup-websocket-connection.c | 24 +++++++++++++------
 2 files changed, 36 insertions(+), 12 deletions(-)

diff --git a/libsoup/server/soup-server.c b/libsoup/server/soup-server.c
index 1ea81fc..10eb8cd 100644
--- a/libsoup/server/soup-server.c
+++ b/libsoup/server/soup-server.c
@@ -186,6 +186,16 @@ static GParamSpec *properties[LAST_PROPERTY] = { NULL, };
 
 G_DEFINE_TYPE_WITH_PRIVATE (SoupServer, soup_server, G_TYPE_OBJECT)
 
+/* SoupWebsocketConnection by default limits only maximum packet size. But a
+ * message may consist of multiple packets, so SoupServer additionally restricts
+ * total message size to mitigate denial of service attacks on the server.
+ * SoupWebsocketConnection does not do this by default because I don't know
+ * whether that would or would not cause compatibility problems for websites.
+ *
+ * This size is in bytes and it is arbitrary.
+ */
+#define MAX_TOTAL_MESSAGE_SIZE_DEFAULT   128 * 1024
+
 static void request_finished (SoupServerMessage      *msg,
                               SoupMessageIOCompletion completion,
                               SoupServer             *server);
@@ -945,11 +955,15 @@ complete_websocket_upgrade (SoupServer        *server,
 
 	g_object_ref (msg);
 	stream = soup_server_message_steal_connection (msg);
-	conn = soup_websocket_connection_new (stream, uri,
-					      SOUP_WEBSOCKET_CONNECTION_SERVER,
-					      soup_message_headers_get_one_common (soup_server_message_get_request_headers (msg), SOUP_HEADER_ORIGIN),
-					      soup_message_headers_get_one_common (soup_server_message_get_response_headers (msg), SOUP_HEADER_SEC_WEBSOCKET_PROTOCOL),
-					      handler->websocket_extensions);
+	conn = SOUP_WEBSOCKET_CONNECTION (g_object_new (SOUP_TYPE_WEBSOCKET_CONNECTION,
+					  "io-stream", stream,
+					  "uri", uri,
+					  "connection-type", SOUP_WEBSOCKET_CONNECTION_SERVER,
+					  "origin", soup_message_headers_get_one_common (soup_server_message_get_request_headers (msg), SOUP_HEADER_ORIGIN),
+					  "protocol", soup_message_headers_get_one_common (soup_server_message_get_response_headers (msg), SOUP_HEADER_SEC_WEBSOCKET_PROTOCOL),
+					  "extensions", handler->websocket_extensions,
+					  "max-total-message-size", (guint64)MAX_TOTAL_MESSAGE_SIZE_DEFAULT,
+					  NULL));
 	handler->websocket_extensions = NULL;
 	g_object_unref (stream);
 
diff --git a/libsoup/websocket/soup-websocket-connection.c b/libsoup/websocket/soup-websocket-connection.c
index 51971db..5896f38 100644
--- a/libsoup/websocket/soup-websocket-connection.c
+++ b/libsoup/websocket/soup-websocket-connection.c
@@ -150,7 +150,6 @@ typedef struct {
 } SoupWebsocketConnectionPrivate;
 
 #define MAX_INCOMING_PAYLOAD_SIZE_DEFAULT   128 * 1024
-#define MAX_TOTAL_MESSAGE_SIZE_DEFAULT   128 * 1024
 #define READ_BUFFER_SIZE 1024
 #define MASK_LENGTH 4
 
@@ -1628,9 +1627,10 @@ soup_websocket_connection_class_init (SoupWebsocketConnectionClass *klass)
 	/**
 	 * SoupWebsocketConnection:max-incoming-payload-size:
 	 *
-	 * The maximum payload size for incoming packets.
+	 * The maximum payload size for incoming packets, or 0 to not limit it.
 	 *
-	 * The protocol expects or 0 to not limit it.
+	 * Each message may consist of multiple packets, so also refer to
+	 * [property@WebSocketConnection:max-total-message-size].
 	 */
         properties[PROP_MAX_INCOMING_PAYLOAD_SIZE] =
                 g_param_spec_uint64 ("max-incoming-payload-size",
@@ -1678,9 +1678,19 @@ soup_websocket_connection_class_init (SoupWebsocketConnectionClass *klass)
 	/**
 	 * SoupWebsocketConnection:max-total-message-size:
 	 *
-	 * The total message size for incoming packets.
+	 * The maximum size for incoming messages.
 	 *
-	 * The protocol expects or 0 to not limit it.
+	 * Set to a value to limit the total message size, or 0 to not
+	 * limit it.
+	 *
+	 * [method@Server.add_websocket_handler] will set this to a nonzero
+	 * default value to mitigate denial of service attacks. Clients must
+	 * choose their own default if they need to mitigate denial of service
+	 * attacks. You also need to set your own default if creating your own
+	 * server SoupWebsocketConnection without using SoupServer.
+	 *
+	 * Each message may consist of multiple packets, so also refer to
+	 * [property@WebSocketConnection:max-incoming-payload-size].
 	 *
 	 * Since: 3.8
 	 */
@@ -1690,7 +1700,7 @@ soup_websocket_connection_class_init (SoupWebsocketConnectionClass *klass)
                                      "Max total message size ",
                                      0,
                                      G_MAXUINT64,
-                                     MAX_TOTAL_MESSAGE_SIZE_DEFAULT,
+                                     0,
                                      G_PARAM_READWRITE |
                                      G_PARAM_CONSTRUCT |
                                      G_PARAM_STATIC_STRINGS);
@@ -2180,7 +2190,7 @@ soup_websocket_connection_get_max_total_message_size (SoupWebsocketConnection *s
 {
 	SoupWebsocketConnectionPrivate *priv = soup_websocket_connection_get_instance_private (self);
 
-	g_return_val_if_fail (SOUP_IS_WEBSOCKET_CONNECTION (self), MAX_TOTAL_MESSAGE_SIZE_DEFAULT);
+	g_return_val_if_fail (SOUP_IS_WEBSOCKET_CONNECTION (self), 0);
 
 	return priv->max_total_message_size;
 }
-- 
2.45.4


From 792650b373541ee31e97c78fc82a275c99f2bf01 Mon Sep 17 00:00:00 2001
From: Michael Catanzaro <mcatanzaro@redhat.com>
Date: Fri, 16 May 2025 16:55:40 -0500
Subject: [PATCH 4/4] Add tests for max-incoming-packet-size and
 max-total-message-size

An even better test would verify that it's possible to send big messages
containing small packets, but libsoup doesn't offer control over packet
size, and I don't want to take the time to learn how WebSockets work to
figure out how to do that manually. Instead, I just check that both
limits work, for both client and server.

I didn't add deflate variants of these tests because I doubt that would
add valuable coverage.
-- 
2.45.4

