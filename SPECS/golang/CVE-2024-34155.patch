From 5d26749e30c14254dabd04cb2b408d1484de2c14 Mon Sep 17 00:00:00 2001
From: archana25-ms <v-shettigara@microsoft.com>
Date: Wed, 7 May 2025 07:27:13 +0000
Subject: [PATCH] Address CVE-2024-34155
Upstream Patch Reference: https://github.com/golang/go/commit/b232596139dbe96a62edbe3a2a203e856bf556eb

---
 src/go/parser/parser.go      | 2 ++
 src/go/parser/parser_test.go | 9 +++++----
 2 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/src/go/parser/parser.go b/src/go/parser/parser.go
index c34ccea..ea81cfc 100644
--- a/src/go/parser/parser.go
+++ b/src/go/parser/parser.go
@@ -1685,6 +1685,8 @@ func (p *parser) checkExprOrType(x ast.Expr) ast.Expr {
 }
 
 func (p *parser) parsePrimaryExpr(x ast.Expr) ast.Expr {
+	defer decNestLev(incNestLev(p))
+
 	if p.trace {
 		defer un(trace(p, "PrimaryExpr"))
 	}
diff --git a/src/go/parser/parser_test.go b/src/go/parser/parser_test.go
index 1a46c87..9e4ce35 100644
--- a/src/go/parser/parser_test.go
+++ b/src/go/parser/parser_test.go
@@ -607,10 +607,11 @@ var parseDepthTests = []struct {
 	{name: "chan2", format: "package main; var x «<-chan »int"},
 	{name: "interface", format: "package main; var x «interface { M() «int» }»", scope: true, scopeMultiplier: 2}, // Scopes: InterfaceType, FuncType
 	{name: "map", format: "package main; var x «map[int]»int"},
-	{name: "slicelit", format: "package main; var x = «[]any{«»}»", parseMultiplier: 2},             // Parser nodes: UnaryExpr, CompositeLit
-	{name: "arraylit", format: "package main; var x = «[1]any{«nil»}»", parseMultiplier: 2},         // Parser nodes: UnaryExpr, CompositeLit
-	{name: "structlit", format: "package main; var x = «struct{x any}{«nil»}»", parseMultiplier: 2}, // Parser nodes: UnaryExpr, CompositeLit
-	{name: "maplit", format: "package main; var x = «map[int]any{1:«nil»}»", parseMultiplier: 2},    // Parser nodes: CompositeLit, KeyValueExpr
+	{name: "slicelit", format: "package main; var x = []any{«[]any{«»}»}", parseMultiplier: 3},      // Parser nodes: UnaryExpr, CompositeLit
+	{name: "arraylit", format: "package main; var x = «[1]any{«nil»}»", parseMultiplier: 3},         // Parser nodes: UnaryExpr, CompositeLit
+	{name: "structlit", format: "package main; var x = «struct{x any}{«nil»}»", parseMultiplier: 3}, // Parser nodes: UnaryExpr, CompositeLit
+	{name: "maplit", format: "package main; var x = «map[int]any{1:«nil»}»", parseMultiplier: 3},    // Parser nodes: CompositeLit, KeyValueExpr
+	{name: "element", format: "package main; var x = struct{x any}{x: «{«»}»}"},
 	{name: "dot", format: "package main; var x = «x.»x"},
 	{name: "index", format: "package main; var x = x«[1]»"},
 	{name: "slice", format: "package main; var x = x«[1:2]»"},
-- 
2.45.3

