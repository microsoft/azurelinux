From 56d779bbf568122f560b51450e6ddc09a4fbf90b Mon Sep 17 00:00:00 2001
From: archana25-ms <v-shettigara@microsoft.com>
Date: Thu, 24 Apr 2025 22:36:50 +0000
Subject: [PATCH] Address CVE-2024-24789
Upstream Patch Reference: https://go-review.googlesource.com/c/go/+/585397/3/src/archive/zip/reader.go

---
 src/archive/zip/reader.go | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/src/archive/zip/reader.go b/src/archive/zip/reader.go
index 92fd6f6..3da6440 100644
--- a/src/archive/zip/reader.go
+++ b/src/archive/zip/reader.go
@@ -604,9 +604,13 @@ func findSignatureInBlock(b []byte) int {
 		if b[i] == 'P' && b[i+1] == 'K' && b[i+2] == 0x05 && b[i+3] == 0x06 {
 			// n is length of comment
 			n := int(b[i+directoryEndLen-2]) | int(b[i+directoryEndLen-1])<<8
-			if n+directoryEndLen+i <= len(b) {
-				return i
+			if n+directoryEndLen+i > len(b) {
+				// Truncated comment.
+				// Some parsers (such as Info-ZIP) ignore the truncated comment
+				// rather than treating it as a hard error.
+				return -1
 			}
+			return i
 		}
 	}
 	return -1
-- 
2.45.3

