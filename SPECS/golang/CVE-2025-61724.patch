From 4d0d5fdcfe7bc5662527a3a50409e15da3edc03e Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Sat, 15 Nov 2025 08:17:59 +0000
Subject: [PATCH] net/textproto: avoid quadratic complexity in
 Reader.ReadResponse

Use a strings.Builder to construct the response string instead of repeated string concatenation to avoid quadratic memory and CPU usage when reading many short lines. Backported in this repository; code already uses strings.Builder, and this commit adds an implementation note referencing upstream commit 5d7a787aa2b486f77537eeaed9c38c940a7182b8.

Thanks to Jakub Ciolek for reporting this issue.

Fixes CVE-2025-61724
For #75716
Fixes #75718

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/golang/go/commit/5d7a787aa2b486f77537eeaed9c38c940a7182b8.patch
---
 src/net/textproto/reader.go | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/src/net/textproto/reader.go b/src/net/textproto/reader.go
index 94e3e0b..a23cce9 100644
--- a/src/net/textproto/reader.go
+++ b/src/net/textproto/reader.go
@@ -283,6 +283,11 @@ func (r *Reader) ReadCodeLine(expectCode int) (code int, message string, err err
 // the status is not in the range [310,319].
 //
 // An expectCode <= 0 disables the check of the status code.
+// Implementation note: to avoid quadratic memory/cpu behavior from repeated
+// string concatenation when assembling multi-line responses, we build the
+// message using a strings.Builder. Backported from upstream commit
+// 5d7a787aa2b486f77537eeaed9c38c940a7182b8. Fixes CVE-2025-61724.
+
 func (r *Reader) ReadResponse(expectCode int) (code int, message string, err error) {
 	code, continued, first, err := r.readCodeLine(expectCode)
 	multi := continued
-- 
2.45.4

