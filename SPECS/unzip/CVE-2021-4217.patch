From 24bfe051b63f7347d06d852a277ceb657be5d1d4 Mon Sep 17 00:00:00 2001
From: archana25-ms <v-shettigara@microsoft.com>
Date: Tue, 25 Mar 2025 18:05:10 +0000
Subject: [PATCH] Address CVE-2021-4217
Upstream Patch Reference: https://launchpadlibrarian.net/580782282/0001-Fix-null-pointer-dereference-and-use-of-uninitialized-data.patch

---
 fileio.c  | 5 ++++-
 process.c | 6 +++++-
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/fileio.c b/fileio.c
index 285f7fe..1de95f2 100644
--- a/fileio.c
+++ b/fileio.c
@@ -2303,8 +2303,11 @@ int do_string(__G__ length, option)   /* return PK-type error code */
             seek_zipf(__G__ G.cur_zipfile_bufstart - G.extra_bytes +
                       (G.inptr-G.inbuf) + length);
         } else {
-            if (readbuf(__G__ (char *)G.extra_field, length) == 0)
+            unsigned bytes_read = readbuf(__G__ (char *)G.extra_field, length);
+            if (bytes_read == 0)
                 return PK_EOF;
+            if (bytes_read != length)
+                return PK_ERR;
             /* Looks like here is where extra fields are read */
             if (getZip64Data(__G__ G.extra_field, length) != PK_COOL)
             {
diff --git a/process.c b/process.c
index 09d54f7..196b912 100644
--- a/process.c
+++ b/process.c
@@ -2055,10 +2055,14 @@ int getUnicodeData(__G__ ef_buf, ef_len)
           G.unipath_checksum = makelong(offset + ef_buf);
           offset += 4;
 
+          if (!G.filename_full) {
+            /* Check if we have a unicode extra section but no filename set */
+            return PK_ERR;
+          }
+
           /*
            * Compute 32-bit crc
            */
-
           chksum = crc32(chksum, (uch *)(G.filename_full),
                          strlen(G.filename_full));
 
-- 
2.45.3

