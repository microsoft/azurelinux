From 8ec738305201d9e14ad0d8ec9076d7b0040e7c6c Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Thu, 27 Nov 2025 06:49:36 +0000
Subject: [PATCH] Backport note: Upstream libpng fix for png_write_image_8bit
 condition not applicable to Qt PNG plugin; add comment for traceability

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/pnggroup/libpng/pull/757/commits/baa0413c0f64248cfd6a3a2ae5bddd2e9f12c0cc.patch
---
 src/gui/image/qpnghandler.cpp | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/src/gui/image/qpnghandler.cpp b/src/gui/image/qpnghandler.cpp
index 615a36fa..85688bf1 100644
--- a/src/gui/image/qpnghandler.cpp
+++ b/src/gui/image/qpnghandler.cpp
@@ -838,6 +838,18 @@ static void set_text(const QImage &image, png_structp png_ptr, png_infop info_pt
         delete [] text_ptr[i].lang_key;
 #endif
     }
+// NOTE [Backport notice 2025-11-07]:
+// Upstream libpng patch "Fix a heap buffer overflow in png_write_image_8bit"
+// adjusts a condition in pngwrite.c (png_image_write_main) to ensure that
+// the pre-transform path only triggers for 16-bit (linear) input:
+//     linear != 0 && (alpha != 0 || display->convert_to_8bit != 0)
+// Qt's PNG plugin does not use libpng's simplified API (png_image_write_main)
+// nor the png_write_image_8bit pre-transform path. Instead, it drives libpng
+// through the standard write interface, selecting 8-bit or 16-bit output based
+// on the QImage format. Therefore, the vulnerability does not apply here and
+// no functional change is required. This comment documents the backport
+// assessment for traceability.
+
     delete [] text_ptr;
 }
 
-- 
2.45.4

