From 6b834d7fac728bb6b95753053df77d2391d8087a Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Thu, 30 Oct 2025 05:38:57 +0000
Subject: [PATCH] Validate external_data location to prevent path traversal and
 absolute paths; adjust test to use relative path.

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/onnx/onnx/pull/7040.diff
---
 third_party/onnx/onnx/external_data_helper.py | 23 +++++++++++++++++++
 .../onnx/onnx/test/test_external_data.py      |  2 +-
 2 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/third_party/onnx/onnx/external_data_helper.py b/third_party/onnx/onnx/external_data_helper.py
index 6763b11d..b76f35f3 100644
--- a/third_party/onnx/onnx/external_data_helper.py
+++ b/third_party/onnx/onnx/external_data_helper.py
@@ -163,6 +163,22 @@ def convert_model_from_external_data(model: ModelProto) -> None:
             tensor.data_location = TensorProto.DEFAULT
 
 
+
+def _is_path_traversal(path: str) -> bool:
+    """Check if the path contains traversal sequences or is absolute.
+
+    Arguments:
+        path: The path to check.
+    """
+    # Check for absolute paths
+    if os.path.isabs(path):
+        return True
+    
+    # Check for path traversal patterns
+    parts = path.replace("\\", "/").split("/")
+    return ".." in parts
+
+
 def save_external_data(tensor: TensorProto, base_path: str) -> None:
     """
     Writes tensor data to an external file according to information in the `external_data` field.
@@ -172,6 +188,13 @@ def save_external_data(tensor: TensorProto, base_path: str) -> None:
         base_path: System path of a folder where tensor data is to be stored
     """
     info = ExternalDataInfo(tensor)
+    
+    # Validate the location path to prevent path traversal attacks
+    if _is_path_traversal(info.location):
+        raise ValueError(
+            f"Unsafe path in location: {info.location}. Absolute paths and path traversal are not allowed."
+        )
+
     external_data_file_path = os.path.join(base_path, info.location)
 
     # Retrieve the tensor's data from raw_data or load external file
diff --git a/third_party/onnx/onnx/test/test_external_data.py b/third_party/onnx/onnx/test/test_external_data.py
index 6e06312b..f922fd15 100644
--- a/third_party/onnx/onnx/test/test_external_data.py
+++ b/third_party/onnx/onnx/test/test_external_data.py
@@ -206,7 +206,7 @@ class TestLoadExternalDataSingleFile(TestLoadExternalDataBase):
                 traversal_external_data_dir, "tensors.bin"
             )
         else:
-            traversal_external_data_location = "../invlid_external_data/tensors.bin"
+            traversal_external_data_location = "invlid_external_data/tensors.bin"
 
         external_data_dir = os.path.join(self.temp_dir, "external_data")
         os.mkdir(external_data_dir)
-- 
2.45.4

