From 096aefddc82c29e1965c02d54bee7f2b52366913 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Mon, 29 Sep 2025 19:18:03 +0000
Subject: [PATCH] openssl: check return values and handle BIO allocation
 failures; guard g_tls_bio_alloc results; avoid deref on NULL BIO; use
 g_clear_pointer for BIO_free_all; adjust types for certificate_pem

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://gitlab.gnome.org/GNOME/glib-networking/-/merge_requests/263.patch
---
 tls/openssl/gtlsbio.c                 |  6 ++--
 tls/openssl/gtlscertificate-openssl.c | 42 ++++++++++++++++++---------
 2 files changed, 33 insertions(+), 15 deletions(-)

diff --git a/tls/openssl/gtlsbio.c b/tls/openssl/gtlsbio.c
index 4e138e7..93f930a 100644
--- a/tls/openssl/gtlsbio.c
+++ b/tls/openssl/gtlsbio.c
@@ -355,7 +355,8 @@ g_tls_bio_new_from_iostream (GIOStream *io_stream)
   GTlsBio *gbio;
 
   ret = g_tls_bio_alloc (&gbio);
-  gbio->io_stream = g_object_ref (io_stream);
+  if (ret)
+    gbio->io_stream = g_object_ref (io_stream);
 
   return ret;
 }
@@ -367,7 +368,8 @@ g_tls_bio_new_from_datagram_based (GDatagramBased *socket)
   GTlsBio *gbio;
 
   ret = g_tls_bio_alloc (&gbio);
-  gbio->socket = g_object_ref (socket);
+  if (ret)
+    gbio->socket = g_object_ref (socket);
 
   return ret;
 }
diff --git a/tls/openssl/gtlscertificate-openssl.c b/tls/openssl/gtlscertificate-openssl.c
index 01ed177..290cb13 100644
--- a/tls/openssl/gtlscertificate-openssl.c
+++ b/tls/openssl/gtlscertificate-openssl.c
@@ -156,6 +156,9 @@ export_privkey_to_der (GTlsCertificateOpenssl  *openssl,
     goto err;
 
   bio = BIO_new (BIO_s_mem ());
+  if (!bio)
+    goto err;
+
   if (i2d_PKCS8_PRIV_KEY_INFO_bio (bio, pkcs8) == 0)
     goto err;
 
@@ -189,6 +192,9 @@ export_privkey_to_pem (GTlsCertificateOpenssl *openssl)
     return NULL;
 
   bio = BIO_new (BIO_s_mem ());
+  if (!bio)
+    goto out;
+
   ret = PEM_write_bio_PKCS8PrivateKey (bio, openssl->key, NULL, NULL, 0, NULL, NULL);
   if (ret == 0)
     goto out;
@@ -201,7 +207,7 @@ export_privkey_to_pem (GTlsCertificateOpenssl *openssl)
   result = g_strdup (data);
 
 out:
-  BIO_free_all (bio);
+  g_clear_pointer (&bio, BIO_free_all);
   return result;
 }
 
@@ -216,7 +222,7 @@ g_tls_certificate_openssl_get_property (GObject    *object,
   guint8 *data;
   BIO *bio;
   GByteArray *byte_array;
-  char *certificate_pem;
+  const char *certificate_pem;
   long size;
 
   const ASN1_TIME *time_asn1;
@@ -251,15 +257,12 @@ g_tls_certificate_openssl_get_property (GObject    *object,
     case PROP_CERTIFICATE_PEM:
       bio = BIO_new (BIO_s_mem ());
 
-      if (!PEM_write_bio_X509 (bio, openssl->cert) || !BIO_write (bio, "\0", 1))
-        certificate_pem = NULL;
-      else
+      if (bio && PEM_write_bio_X509 (bio, openssl->cert) && BIO_write (bio, "\0", 1))
         {
           BIO_get_mem_data (bio, &certificate_pem);
           g_value_set_string (value, certificate_pem);
-
-          BIO_free_all (bio);
         }
+      g_clear_pointer (&bio, BIO_free_all);
       break;
 
     case PROP_PRIVATE_KEY:
@@ -299,6 +302,8 @@ g_tls_certificate_openssl_get_property (GObject    *object,
 
     case PROP_SUBJECT_NAME:
       bio = BIO_new (BIO_s_mem ());
+      if (!bio)
+        break;
       name = X509_get_subject_name (openssl->cert);
       X509_NAME_print_ex (bio, name, 0, XN_FLAG_SEP_COMMA_PLUS);
       BIO_write (bio, "\0", 1);
@@ -309,6 +314,8 @@ g_tls_certificate_openssl_get_property (GObject    *object,
 
     case PROP_ISSUER_NAME:
       bio = BIO_new (BIO_s_mem ());
+      if (!bio)
+        break;
       name = X509_get_issuer_name (openssl->cert);
       X509_NAME_print_ex (bio, name, 0, XN_FLAG_SEP_COMMA_PLUS);
       BIO_write (bio, "\0", 1);
@@ -370,8 +377,11 @@ g_tls_certificate_openssl_set_property (GObject      *object,
         break;
       g_return_if_fail (openssl->have_cert == FALSE);
       bio = BIO_new_mem_buf ((gpointer)string, -1);
-      openssl->cert = PEM_read_bio_X509 (bio, NULL, NULL, NULL);
-      BIO_free (bio);
+      if (bio)
+        {
+          openssl->cert = PEM_read_bio_X509 (bio, NULL, NULL, NULL);
+          BIO_free (bio);
+        }
       if (openssl->cert)
         openssl->have_cert = TRUE;
       else if (!openssl->construct_error)
@@ -389,8 +399,11 @@ g_tls_certificate_openssl_set_property (GObject      *object,
         break;
       g_return_if_fail (openssl->have_key == FALSE);
       bio = BIO_new_mem_buf (bytes->data, bytes->len);
-      openssl->key = d2i_PrivateKey_bio (bio, NULL);
-      BIO_free (bio);
+      if (bio)
+        {
+          openssl->key = d2i_PrivateKey_bio (bio, NULL);
+          BIO_free (bio);
+        }
       if (openssl->key)
         openssl->have_key = TRUE;
       else if (!openssl->construct_error)
@@ -408,8 +421,11 @@ g_tls_certificate_openssl_set_property (GObject      *object,
         break;
       g_return_if_fail (openssl->have_key == FALSE);
       bio = BIO_new_mem_buf ((gpointer)string, -1);
-      openssl->key = PEM_read_bio_PrivateKey (bio, NULL, NULL, NULL);
-      BIO_free (bio);
+      if (bio)
+        {
+          openssl->key = PEM_read_bio_PrivateKey (bio, NULL, NULL, NULL);
+          BIO_free (bio);
+        }
       if (openssl->key)
         openssl->have_key = TRUE;
       else if (!openssl->construct_error)
-- 
2.45.4

