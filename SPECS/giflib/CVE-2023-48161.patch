From e9ed0342ff3da16c646e355c1bb8a37ab0c93240 Mon Sep 17 00:00:00 2001
From: Bogdan Codres <bogdan.codres@windriver.com>
Date: Fri, 8 Mar 2024 01:30:45 +0800
Subject: [PATCH] Free Buffers from DumpScreen2RGB in error case

==581==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000002bfc at pc 0x557cbdc9b28d bp 0x7ffde35804b0 sp 0x7ffde35804a0
READ of size 1 at 0x602000002bfc thread T0
    #0 0x557cbdc9b28c in DumpScreen2RGB ../../giflib-5.1.4/util/gif2rgb.c:323
    #1 0x557cbdc9b28c in GIF2RGB ../../giflib-5.1.4/util/gif2rgb.c:480
    #2 0x557cbdc9b28c in main ../../giflib-5.1.4/util/gif2rgb.c:538
    #3 0x7fb09ad8214a in __libc_start_main (/lib64/libc.so.6+0x391602414a)
    #4 0x557cbdc9bb19 in _start (/usr/bin/gif2rgb+0x5b19)

0x602000002bfc is located 0 bytes to the right of 12-byte region [0x602000002bf0,0x602000002bfc)
allocated by thread T0 here:
    #0 0x7fb09b021138 in __interceptor_calloc (/usr/lib64/libasan.so.5+0xee138)
    #1 0x7fb09af2ab1e in GifMakeMapObject ../../giflib-5.1.4/lib/gifalloc.c:55

SUMMARY: AddressSanitizer: heap-buffer-overflow ../../giflib-5.1.4/util/gif2rgb.c:323 in DumpScreen2RGB

Signed-off-by: Bogdan Codres <bogdan.codres@windriver.com>
---
 util/gif2rgb.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/gif2rgb.c b/gif2rgb.c
index bdc861f..9916fde 100644
--- a/gif2rgb.c
+++ b/gif2rgb.c
@@ -327,6 +327,9 @@ static void DumpScreen2RGB(char *FileName, int OneFileFlag,
             if (fwrite(Buffers[0], ScreenWidth, 1, rgbfp[0]) != 1 ||
                 fwrite(Buffers[1], ScreenWidth, 1, rgbfp[1]) != 1 ||
                 fwrite(Buffers[2], ScreenWidth, 1, rgbfp[2]) != 1)
+		free((char *) Buffers[0]);
+		free((char *) Buffers[1]);
+		free((char *) Buffers[2]);
                 GIF_EXIT("Write to file(s) failed.");
         }
 
-- 
2.26.1


