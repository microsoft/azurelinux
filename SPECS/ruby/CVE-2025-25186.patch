From 4b3f68e2cf28fb206ede3afb400f199901afce38 Mon Sep 17 00:00:00 2001
From: Sreenivasulu Malavathula <v-smalavathu@microsoft.com>
Date: Mon, 17 Feb 2025 13:54:22 -0600
Subject: [PATCH] Address CVE-2025-25186

---
 .../lib/net/imap/response_parser.rb           | 26 ++++++++++++++++---
 1 file changed, 23 insertions(+), 3 deletions(-)

diff --git a/.bundle/gems/net-imap-0.4.9.1/lib/net/imap/response_parser.rb b/.bundle/gems/net-imap-0.4.9.1/lib/net/imap/response_parser.rb
index 1aab798..abb834c 100644
--- a/.bundle/gems/net-imap-0.4.9.1/lib/net/imap/response_parser.rb
+++ b/.bundle/gems/net-imap-0.4.9.1/lib/net/imap/response_parser.rb
@@ -8,6 +8,8 @@ module Net

     # Parses an \IMAP server response.
     class ResponseParser
+      MAX_UID_SET_SIZE = 10_000
+
       include ParserUtils
       extend  ParserUtils::Generator

@@ -2002,11 +2004,29 @@ module Net
         case token.symbol
         when T_NUMBER then [Integer(token.value)]
         when T_ATOM
-          token.value.split(",").flat_map {|range|
-            range = range.split(":").map {|uniqueid| Integer(uniqueid) }
-            range.size == 1 ? range : Range.new(range.min, range.max).to_a
+          entries = uid_set__ranges(token.value)
+          if (count = entries.sum(&:count)) > MAX_UID_SET_SIZE
+            parse_error("uid-set is too large: %d > 10k", count)
+          end
+          entries.flat_map(&:to_a)
+        end
+      end
+
+      # returns an array of ranges
+      def uid_set__ranges(uidset)
+        entries = []
+        uidset.split(",") do |entry|
+          uids = entry.split(":", 2).map {|uid|
+            unless uid =~ /\A[1-9][0-9]*\z/
+              parse_error("invalid uid-set uid: %p", uid)
+            end
+            uid = Integer(uid)
+            NumValidator.ensure_nz_number(uid)
+            uid
           }
+          entries << Range.new(*uids.minmax)
         end
+        entries
       end

       def nil_atom
--
2.45.2

