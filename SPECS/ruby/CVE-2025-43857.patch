From 88a2dc090b611fc0db3291a4bcb4f934e1e1ab5f Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Tue, 25 Nov 2025 04:34:26 +0000
Subject: [PATCH] Net::IMAP: add ResponseReadError and ResponseTooLargeError
 for response size limiting support

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/ruby/net-imap/pull/445.patch
---
 lib/rubygems/errors.rb | 39 +++++++++++++++++++++++++++++++++++++++
 1 file changed, 39 insertions(+)

diff --git a/lib/rubygems/errors.rb b/lib/rubygems/errors.rb
index be6c34d..e51e72d 100644
--- a/lib/rubygems/errors.rb
+++ b/lib/rubygems/errors.rb
@@ -174,3 +174,42 @@ module Gem
     alias_method :exception, :error
   end
 end
+
+# Added for Net::IMAP response size limiting support
+module Net
+  module IMAP
+    # Error raised when the socket cannot be read, due to a Config limit.
+    class ResponseReadError < StandardError
+    end
+
+    # Error raised when a response is larger than IMAP#max_response_size.
+    class ResponseTooLargeError < ResponseReadError
+      attr_reader :bytes_read, :literal_size
+      attr_reader :max_response_size
+
+      def initialize(msg = nil, *args,
+                     bytes_read:        nil,
+                     literal_size:      nil,
+                     max_response_size: nil,
+                     **kwargs)
+        @bytes_read        = bytes_read
+        @literal_size      = literal_size
+        @max_response_size = max_response_size
+        msg ||= [
+          "Response size", response_size_msg, "exceeds max_response_size",
+          max_response_size && "(#{max_response_size}B)",
+        ].compact.join(" ")
+        super(msg, *args, **kwargs)
+      end
+
+      private
+
+      def response_size_msg
+        if bytes_read && literal_size
+          "(#{bytes_read}B read + #{literal_size}B literal)"
+        end
+      end
+    end
+  end
+end
+
-- 
2.45.4

