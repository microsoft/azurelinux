From 73e4f2971e74282d723e8963a30d0a4b35509e39 Mon Sep 17 00:00:00 2001
From: kavyasree <kkaitepalli@microsoft.com>
Date: Mon, 7 Apr 2025 11:46:42 +0530
Subject: [PATCH] Error handling in __archive_read_ahead

---
 .../archive_read_support_format_tar.c           | 17 +++++++----------
 1 file changed, 7 insertions(+), 10 deletions(-)

diff --git a/Utilities/cmlibarchive/libarchive/archive_read_support_format_tar.c b/Utilities/cmlibarchive/libarchive/archive_read_support_format_tar.c
index c63d46fc..3e0af9f8 100644
--- a/Utilities/cmlibarchive/libarchive/archive_read_support_format_tar.c
+++ b/Utilities/cmlibarchive/libarchive/archive_read_support_format_tar.c
@@ -621,8 +621,6 @@ archive_read_format_tar_read_data(struct archive_read *a,
 		}
 
 		*buff = __archive_read_ahead(a, 1, &bytes_read);
-		if (bytes_read < 0)
-			return (ARCHIVE_FATAL);
 		if (*buff == NULL) {
 			archive_set_error(&a->archive, ARCHIVE_ERRNO_MISC,
 			    "Truncated tar archive");
@@ -707,13 +705,11 @@ tar_read_header(struct archive_read *a, struct tar *tar,
 
 		/* Read 512-byte header record */
 		h = __archive_read_ahead(a, 512, &bytes);
-		if (bytes < 0)
-			return ((int)bytes);
 		if (bytes == 0) { /* EOF at a block boundary. */
 			/* Some writers do omit the block of nulls. <sigh> */
 			return (ARCHIVE_EOF);
 		}
-		if (bytes < 512) {  /* Short block at EOF; this is bad. */
+		if (h == NULL) {  /* Short block at EOF; this is bad. */
 			archive_set_error(&a->archive,
 			    ARCHIVE_ERRNO_FILE_FORMAT,
 			    "Truncated tar archive");
@@ -1449,6 +1445,9 @@ read_mac_metadata_blob(struct archive_read *a, struct tar *tar,
 	 */
 	data = __archive_read_ahead(a, (size_t)size, NULL);
 	if (data == NULL) {
+		archive_set_error(&a->archive, EINVAL,
+ 		    "Truncated archive"
+ 		    " detected while reading macOS metadata");
 		*unconsumed = 0;
 		return (ARCHIVE_FATAL);
 	}
@@ -2317,9 +2316,7 @@ gnu_sparse_old_read(struct archive_read *a, struct tar *tar,
 	do {
 		tar_flush_unconsumed(a, unconsumed);
 		data = __archive_read_ahead(a, 512, &bytes_read);
-		if (bytes_read < 0)
-			return (ARCHIVE_FATAL);
-		if (bytes_read < 512) {
+		if (data == NULL) {
 			archive_set_error(&a->archive, ARCHIVE_ERRNO_FILE_FORMAT,
 			    "Truncated tar archive "
 			    "detected while reading sparse file data");
@@ -2727,7 +2724,7 @@ readline(struct archive_read *a, struct tar *tar, const char **start,
 	tar_flush_unconsumed(a, unconsumed);
 
 	t = __archive_read_ahead(a, 1, &bytes_read);
-	if (bytes_read <= 0)
+	if (bytes_read <= 0 || t == NULL)
 		return (ARCHIVE_FATAL);
 	s = t;  /* Start of line? */
 	p = memchr(t, '\n', bytes_read);
@@ -2768,7 +2765,7 @@ readline(struct archive_read *a, struct tar *tar, const char **start,
 		}
 		/* Read some more. */
 		t = __archive_read_ahead(a, 1, &bytes_read);
-		if (bytes_read <= 0)
+		if (bytes_read <= 0 || t == NULL)
 			return (ARCHIVE_FATAL);
 		s = t;  /* Start of line? */
 		p = memchr(t, '\n', bytes_read);
-- 
2.34.1

