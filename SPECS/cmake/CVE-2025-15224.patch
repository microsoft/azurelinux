From 1decc01293e498c6d2dfebaf30be34bedcb13c7a Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Thu, 22 Jan 2026 05:28:46 +0000
Subject: [PATCH] libssh: require private key or user-agent for public key auth

Closes #20110

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/curl/curl/commit/16d5f2a5660c61cc27bd5f1c7f512391d1c92.patch
---
 Utilities/cmcurl/lib/vssh/libssh.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/Utilities/cmcurl/lib/vssh/libssh.c b/Utilities/cmcurl/lib/vssh/libssh.c
index f437e36e..108efde1 100644
--- a/Utilities/cmcurl/lib/vssh/libssh.c
+++ b/Utilities/cmcurl/lib/vssh/libssh.c
@@ -742,7 +742,11 @@ static CURLcode myssh_statemach_act(struct Curl_easy *data, bool *block)
         }
 
         sshc->auth_methods = ssh_userauth_list(sshc->ssh_session, NULL);
-        if(sshc->auth_methods & SSH_AUTH_METHOD_PUBLICKEY) {
+        /* For public key auth we need either the private key or
+           CURLSSH_AUTH_AGENT. */
+        if((sshc->auth_methods & SSH_AUTH_METHOD_PUBLICKEY) &&
+          (data->set.str[STRING_SSH_PRIVATE_KEY] ||
+           (data->set.ssh_auth_types & CURLSSH_AUTH_AGENT))) {
           state(data, SSH_AUTH_PKEY_INIT);
           infof(data, "Authentication using SSH public key file\n");
         }
-- 
2.45.4

