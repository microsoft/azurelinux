From 6583a436fce5c0cf77d272a65386598fb44ecfd2 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Wed, 21 Jan 2026 13:48:09 +0000
Subject: [PATCH] libssh: require private key or user-agent for public key auth

Closes #20110

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/curl/curl/commit/b011e3fcfb06d6c0278595ee2ee297036fbe9793.patch
---
 Utilities/cmcurl/lib/vssh/libssh.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/Utilities/cmcurl/lib/vssh/libssh.c b/Utilities/cmcurl/lib/vssh/libssh.c
index d6ba987f..1ae325c0 100644
--- a/Utilities/cmcurl/lib/vssh/libssh.c
+++ b/Utilities/cmcurl/lib/vssh/libssh.c
@@ -753,7 +753,11 @@ static CURLcode myssh_statemach_act(struct Curl_easy *data, bool *block)
                 "keyboard-interactive, " : "",
                 sshc->auth_methods & SSH_AUTH_METHOD_PASSWORD ?
                 "password": "");
-        if(sshc->auth_methods & SSH_AUTH_METHOD_PUBLICKEY) {
+        /* For public key auth we need either the private key or
+           CURLSSH_AUTH_AGENT. */
+        if((sshc->auth_methods & SSH_AUTH_METHOD_PUBLICKEY) &&
+          (data->set.str[STRING_SSH_PRIVATE_KEY] ||
+           (data->set.ssh_auth_types & CURLSSH_AUTH_AGENT))) {
           state(data, SSH_AUTH_PKEY_INIT);
           infof(data, "Authentication using SSH public key file");
         }
-- 
2.45.4

