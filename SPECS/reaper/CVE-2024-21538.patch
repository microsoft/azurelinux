From 49c632b77f14d180f8357eac29ad87d9fe9e55df Mon Sep 17 00:00:00 2001
From: Sudipta Pandit <sudpandit@microsoft.com>
Date: Fri, 15 Nov 2024 17:47:25 +0530
Subject: [PATCH] Fix CVE-2024-21538

Reference: https://patch-diff.githubusercontent.com/raw/moxystudio/node-cross-spawn/pull/160
---
 execa/node_modules/cross-spawn/lib/util/escape.js       | 6 ++++--
 webpack-cli/node_modules/cross-spawn/lib/util/escape.js | 6 ++++--
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/src/ui/node_modules/execa/node_modules/cross-spawn/lib/util/escape.js b/src/ui/node_modules/execa/node_modules/cross-spawn/lib/util/escape.js
index b0bb84c3..e4804b99 100644
--- a/src/ui/node_modules/execa/node_modules/cross-spawn/lib/util/escape.js
+++ b/src/ui/node_modules/execa/node_modules/cross-spawn/lib/util/escape.js
@@ -15,15 +15,17 @@ function escapeArgument(arg, doubleEscapeMetaChars) {
     arg = `${arg}`;
 
     // Algorithm below is based on https://qntm.org/cmd
+    // It's slightly altered to disable JS backtracking to avoid hanging on specially crafted input
+    // Please see https://github.com/moxystudio/node-cross-spawn/pull/160 for more information
 
     // Sequence of backslashes followed by a double quote:
     // double up all the backslashes and escape the double quote
-    arg = arg.replace(/(\\*)"/g, '$1$1\\"');
+    arg = arg.replace(/(?=\\*?)"/g, '$1$1\\"');
 
     // Sequence of backslashes followed by the end of the string
     // (which will become a double quote later):
     // double up all the backslashes
-    arg = arg.replace(/(\\*)$/, '$1$1');
+    arg = arg.replace(/(?=\\*?)$/, '$1$1');
 
     // All other backslashes occur literally
 
diff --git a/src/ui/node_modules/webpack-cli/node_modules/cross-spawn/lib/util/escape.js b/src/ui/node_modules/webpack-cli/node_modules/cross-spawn/lib/util/escape.js
index b0bb84c3..e4804b99 100644
--- a/src/ui/node_modules/webpack-cli/node_modules/cross-spawn/lib/util/escape.js
+++ b/src/ui/node_modules/webpack-cli/node_modules/cross-spawn/lib/util/escape.js
@@ -15,15 +15,17 @@ function escapeArgument(arg, doubleEscapeMetaChars) {
     arg = `${arg}`;
 
     // Algorithm below is based on https://qntm.org/cmd
+    // It's slightly altered to disable JS backtracking to avoid hanging on specially crafted input
+    // Please see https://github.com/moxystudio/node-cross-spawn/pull/160 for more information
 
     // Sequence of backslashes followed by a double quote:
     // double up all the backslashes and escape the double quote
-    arg = arg.replace(/(\\*)"/g, '$1$1\\"');
+    arg = arg.replace(/(?=\\*?)"/g, '$1$1\\"');
 
     // Sequence of backslashes followed by the end of the string
     // (which will become a double quote later):
     // double up all the backslashes
-    arg = arg.replace(/(\\*)$/, '$1$1');
+    arg = arg.replace(/(?=\\*?)$/, '$1$1');
 
     // All other backslashes occur literally
 
-- 
2.34.1

