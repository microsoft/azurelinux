From 5f56167b5c866aa8f9fd19cca43621776c99c98e Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Mon, 27 Oct 2025 09:31:02 +0000
Subject: [PATCH] vendor/quic-go: drop initial packets when the handshake is
 confirmed

Drop Initial keys at handshake confirmation. On the client side, this should have happened when sending the first Handshake packet, but this is not guaranteed if the server misbehaves. See CVE-2025-59530 for more details.

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/quic-go/quic-go/pull/5354.patch
---
 vendor/github.com/quic-go/quic-go/connection.go | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/vendor/github.com/quic-go/quic-go/connection.go b/vendor/github.com/quic-go/quic-go/connection.go
index abae204..4e95dad 100644
--- a/vendor/github.com/quic-go/quic-go/connection.go
+++ b/vendor/github.com/quic-go/quic-go/connection.go
@@ -761,6 +761,13 @@ func (s *connection) handleHandshakeComplete() error {
 }
 
 func (s *connection) handleHandshakeConfirmed() error {
+	// Drop initial keys.
+	// On the client side, this should have happened when sending the first Handshake packet,
+	// but this is not guaranteed if the server misbehaves.
+	// See CVE-2025-59530 for more details.
+	if err := s.dropEncryptionLevel(protocol.EncryptionInitial); err != nil {
+		return err
+	}
 	if err := s.dropEncryptionLevel(protocol.EncryptionHandshake); err != nil {
 		return err
 	}
-- 
2.45.4

