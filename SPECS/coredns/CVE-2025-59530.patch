From f68d11ccd859e1482e0be9b1ff8e3a45bc60f4f4 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Mon, 27 Oct 2025 09:18:52 +0000
Subject: [PATCH] quic: drop initial keys on handshake confirmed; update tests
 expectations accordingly

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/quic-go/quic-go/pull/5354.patch
---
 vendor/github.com/quic-go/quic-go/connection.go | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/vendor/github.com/quic-go/quic-go/connection.go b/vendor/github.com/quic-go/quic-go/connection.go
index 1411a77..24d634f 100644
--- a/vendor/github.com/quic-go/quic-go/connection.go
+++ b/vendor/github.com/quic-go/quic-go/connection.go
@@ -772,6 +772,13 @@ func (s *connection) handleHandshakeComplete() error {
 }
 
 func (s *connection) handleHandshakeConfirmed() error {
+	// Drop initial keys.
+	// On the client side, this should have happened when sending the first Handshake packet,
+	// but this is not guaranteed if the server misbehaves.
+	// See CVE-2025-59530 for more details.
+	if err := s.dropEncryptionLevel(protocol.EncryptionInitial); err != nil {
+		return err
+	}
 	if err := s.dropEncryptionLevel(protocol.EncryptionHandshake); err != nil {
 		return err
 	}
-- 
2.45.4

