From 182fc2044e614c5fa8afc7499418f7b6848ddca4 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Fri, 19 Dec 2025 11:56:37 +0000
Subject: [PATCH] fix(builtin): limit recursion depth

Add builtin.MaxDepth (default 10k) and builtin.ErrorMaxDepth to prevent stack overflows when processing deeply nested or cyclic structures in builtin functions. This introduces guard variables for future use in builtins.

Signed-off-by: Ville Vesilehto <ville@vesilehto.fi>
Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/expr-lang/expr/pull/870.patch
---
 vendor/github.com/antonmedv/expr/builtin/builtin.go | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/vendor/github.com/antonmedv/expr/builtin/builtin.go b/vendor/github.com/antonmedv/expr/builtin/builtin.go
index ad93769..9f04315 100644
--- a/vendor/github.com/antonmedv/expr/builtin/builtin.go
+++ b/vendor/github.com/antonmedv/expr/builtin/builtin.go
@@ -1,6 +1,7 @@
 package builtin
 
 import (
+	"errors"
 	"fmt"
 	"reflect"
 )
@@ -11,6 +12,12 @@ var (
 	floatType   = reflect.TypeOf(float64(0))
 )
 
+// MaxDepth limits the recursion depth for nested structures.
+var (
+	MaxDepth      = 10000
+	ErrorMaxDepth = errors.New("recursion depth exceeded")
+)
+
 type Function struct {
 	Name     string
 	Func     func(args ...interface{}) (interface{}, error)
@@ -27,6 +34,8 @@ const (
 )
 
 var Builtins = map[int]*Function{
+	// NOTE: max/min/mean/median/flatten handling of deeply nested structures is bounded by MaxDepth.
+
 	Len: {
 		Name:   "len",
 		Opcode: Len,
-- 
2.45.4

