From 7c2ef76bd1dd26fe9fa9f1edf3a54dcaa47fb55a Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Thu, 29 Jan 2026 09:19:32 +0000
Subject: [PATCH] Save stack space while handling errors: remove message from
 stack in luaG_runerror; prevent wasting stack on overflow in luaV_concat;
 adjust top updates for concatenation results

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/gerstrong/Commander-Genius/pull/379.patch
---
 src/ldebug.c | 2 +-
 src/lvm.c    | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/ldebug.c b/src/ldebug.c
index 28b1caa..ef1425f 100644
--- a/src/ldebug.c
+++ b/src/ldebug.c
@@ -829,7 +829,7 @@ l_noret luaG_runerror (lua_State *L, const char *fmt, ...) {
   va_end(argp);
   if (isLua(ci)) {  /* if Lua function, add source:line information */
     luaG_addinfo(L, msg, ci_func(ci)->p->source, getcurrentline(ci));
-    setobjs2s(L, L->top.p - 2, L->top.p - 1);  /* remove 'msg' */
+    setobjs2s(L, L->top.p - 2, L->top.p - 1);  /* remove 'msg' from the stack */
     L->top.p--;
   }
   luaG_errormsg(L);
diff --git a/src/lvm.c b/src/lvm.c
index 8493a77..6d6406a 100644
--- a/src/lvm.c
+++ b/src/lvm.c
@@ -674,7 +674,7 @@ void luaV_concat (lua_State *L, int total) {
       setsvalue2s(L, top - n, ts);  /* create result */
     }
     total -= n - 1;  /* got 'n' strings to create one new */
-    L->top.p -= n - 1;  /* popped 'n' strings and pushed one */
+    L->top.p = top - (n - 1);  /* popped 'n' strings and pushed one */
   } while (total > 1);  /* repeat until only 1 result left */
 }
 
-- 
2.45.4

