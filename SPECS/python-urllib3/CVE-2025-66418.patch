From 7e14f44d968b74730747e32ffaf8ea651f77f5ad Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Wed, 10 Dec 2025 17:03:21 +0000
Subject: [PATCH] Limit number of chained HTTP content encodings to 5 and add
 corresponding tests and changelog entry

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/urllib3/urllib3/commit/c19571de34c47de3a766541b041637ba5f716ed7.patch
---
 changelog/GHSA-gm62-xv2j-4w53.security.rst |  4 ++++
 src/urllib3/response.py                    | 12 +++++++++++-
 test/test_response.py                      | 13 +++++++++++++
 3 files changed, 28 insertions(+), 1 deletion(-)
 create mode 100644 changelog/GHSA-gm62-xv2j-4w53.security.rst

diff --git a/changelog/GHSA-gm62-xv2j-4w53.security.rst b/changelog/GHSA-gm62-xv2j-4w53.security.rst
new file mode 100644
index 0000000..b45c5d5
--- /dev/null
+++ b/changelog/GHSA-gm62-xv2j-4w53.security.rst
@@ -0,0 +1,4 @@
+Fixed a security issue where an attacker could compose an HTTP response with
+virtually unlimited links in the Content-Encoding header, potentially
+leading to a denial of service (DoS) attack by exhausting system resources
+during decoding. The number of allowed chained encodings is now limited to 5.
diff --git a/src/urllib3/response.py b/src/urllib3/response.py
index 0bd13d4..bcb1d80 100644
--- a/src/urllib3/response.py
+++ b/src/urllib3/response.py
@@ -134,9 +134,19 @@ class MultiDecoder(object):
         header field that lists the content codings in the order in which
         they were applied.
     """
+    # Maximum allowed number of chained HTTP encodings in the
+    # Content-Encoding header.
+    max_decode_links = 5
+
 
     def __init__(self, modes):
-        self._decoders = [_get_decoder(m.strip()) for m in modes.split(",")]
+        encodings = [m.strip() for m in modes.split(",")]
+        if len(encodings) > self.max_decode_links:
+            raise DecodeError(
+                "Too many content encodings in the chain: %d > %d"
+                % (len(encodings), self.max_decode_links)
+            )
+        self._decoders = [_get_decoder(e) for e in encodings]
 
     def flush(self):
         return self._decoders[0].flush()
diff --git a/test/test_response.py b/test/test_response.py
index e09e385..345c3e8 100644
--- a/test/test_response.py
+++ b/test/test_response.py
@@ -295,6 +295,19 @@ class TestResponse(object):
 
         assert r.data == b"foo"
 
+    def test_read_multi_decoding_too_many_links(self):
+        fp = BytesIO(b"foo")
+        with pytest.raises(
+            DecodeError, match=r"Too many content encodings in the chain: 6 > 5"
+        ):
+            HTTPResponse(
+                fp,
+                headers={
+                    "content-encoding": "gzip, deflate, br, zstd, gzip, deflate"
+                },
+            )
+
+
     def test_body_blob(self):
         resp = HTTPResponse(b"foo")
         assert resp.data == b"foo"
-- 
2.45.4

