From 0d0602199974d88b1a2cfcf2c359716cb211309c Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Fri, 9 Jan 2026 03:39:21 +0000
Subject: [PATCH] Backport: avoid decoding redirect response bodies in
 drain_conn and add test; dummyserver support for compressed redirect; update
 CHANGES

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/urllib3/urllib3/commit/8864ac407bba8607950025e0979c4c69bc7abc7b.patch
---
 dummyserver/handlers.py     |  9 ++++++++-
 src/urllib3/response.py     |  4 +++-
 test/test_connectionpool.py | 17 +++++++++++++++++
 3 files changed, 28 insertions(+), 2 deletions(-)

diff --git a/dummyserver/handlers.py b/dummyserver/handlers.py
index acd181d..ae12cc1 100644
--- a/dummyserver/handlers.py
+++ b/dummyserver/handlers.py
@@ -190,7 +190,14 @@ class TestingApp(RequestHandler):
             status = status.decode("latin-1")
 
         headers = [("Location", target)]
-        return Response(status=status, headers=headers)
+        compressed = request.params.get("compressed", b"false") == b"true"
+        if compressed:
+            headers.append(("Content-Encoding", "gzip"))
+            data = gzip.compress(b"foo")
+        else:
+            data = b""
+
+        return Response(data, status=status, headers=headers)
 
     def not_found(self, request):
         return Response("Not found", status="404 Not Found")
diff --git a/src/urllib3/response.py b/src/urllib3/response.py
index 0bd13d4..b57146d 100644
--- a/src/urllib3/response.py
+++ b/src/urllib3/response.py
@@ -292,7 +292,9 @@ class HTTPResponse(io.IOBase):
         Unread data in the HTTPResponse connection blocks the connection from being released back to the pool.
         """
         try:
-            self.read()
+            # Do not spend resources decoding the content unless decoding has already been initiated.
+            # In this backport we don't track that state, so we avoid decoding here.
+            self.read(decode_content=False)
         except (HTTPError, SocketError, BaseSSLError, HTTPException):
             pass
 
diff --git a/test/test_connectionpool.py b/test/test_connectionpool.py
index 872d01c..05cf771 100644
--- a/test/test_connectionpool.py
+++ b/test/test_connectionpool.py
@@ -507,3 +507,20 @@ class TestConnectionPool(object):
                 "GET", "/", retries=False, chunked=True, preload_content=False
             )
             assert isinstance(response, CustomHTTPResponse)
+
+    @mock.patch("urllib3.response.GzipDecoder.decompress")
+    def test_no_decoding_with_redirect_when_preload_disabled(self, gzip_decompress):
+        """
+        Test that urllib3 does not attempt to decode a gzipped redirect
+        response when `preload_content` is set to `False`.
+        """
+        with HTTPConnectionPool(host="localhost") as pool:
+            response = pool.request(
+                "GET",
+                "/redirect", 
+                fields={"target": "/redirect?compressed=true", "compressed": "true"},
+                preload_content=False,
+            )
+        assert response.status == 200
+        gzip_decompress.assert_not_called()
+
-- 
2.45.4

