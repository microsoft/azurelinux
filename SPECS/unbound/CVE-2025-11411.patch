From 066e5f6820fc762b664bd2f0bc8b1347a7c7c2e3 Mon Sep 17 00:00:00 2001
From: Azure Linux Security Servicing Account
 <azurelinux-security@microsoft.com>
Date: Mon, 27 Oct 2025 09:14:10 +0000
Subject: [PATCH] Fix for CVE-2025-11411

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: https://nlnetlabs.nl/downloads/unbound/patch_CVE-2025-11411.diff
---
 iterator/iter_scrub.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/iterator/iter_scrub.c b/iterator/iter_scrub.c
index 5f2e303..47dc40a 100644
--- a/iterator/iter_scrub.c
+++ b/iterator/iter_scrub.c
@@ -570,6 +570,22 @@ scrub_normalize(sldns_buffer* pkt, struct msg_parse* msg,
 					"RRset:", pkt, msg, prev, &rrset);
 				continue;
 			}
+			/* If the NS set is a promiscuous NS set, scrub that
+			 * to remove potential for poisonous contents that
+			 * affects other names in the same zone. Remove
+			 * promiscuous NS sets in positive answers, that
+			 * thus have records in the answer section. Nodata
+			 * and nxdomain promiscuous NS sets have been removed
+			 * already. Since the NS rrset is scrubbed, its
+			 * address records are also not marked to be allowed
+			 * and are removed later. */
+			if(FLAGS_GET_RCODE(msg->flags) == LDNS_RCODE_NOERROR &&
+				msg->an_rrsets != 0 &&
+				1 /* env->cfg->iter_scrub_promiscuous */) {
+				remove_rrset("normalize: removing promiscuous "
+					"RRset:", pkt, msg, prev, &rrset);
+				continue;
+			}
 			if(nsset == NULL) {
 				nsset = rrset;
 			} else {
-- 
2.45.4

