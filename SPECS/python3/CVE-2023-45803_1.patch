From 49d96b44fbc27ecca525bd99b79f39b373669a96 Mon Sep 17 00:00:00 2001
From: Sreenivasulu Malavathula <v-smalavathu@microsoft.com>
Date: Thu, 12 Jun 2025 11:52.18 -0500
Subject: [PATCH] Address CVE-2023-45803
Upstream Patch Reference: https://github.com/urllib3/urllib3/commit/4e98d57809dacab1cbe625fddeec1a290c478ea9

---
 .../pip/_vendor/urllib3/_collections.py       | 20 +++++++++++++++++++
 1 file changed, 30 insertions(+), 2 deletions(-)

diff --git a/pip/_vendor/urllib3/_collections.py b/pip/_vendor/urllib3/_collections.py
index da9857e..0acf4da 100644
--- a/pip/_vendor/urllib3/_collections.py
--- b/pip/_vendor/urllib3/_collections.py
@@ -22,6 +22,8 @@ from .exceptions import InvalidHeader
 from .packages import six
 from .packages.six import iterkeys, itervalues
 
+from typing_extensions import Self
+
 __all__ = ["RecentlyUsedContainer", "HTTPHeaderDict"]
 
 
@@ -268,6 +270,24 @@ class HTTPHeaderDict(MutableMapping):
         else:
             return vals[1:]
 
+    def _prepare_for_method_change(self) -> Self:
+        """
+        Remove content-specific header fields before changing the request
+        method to GET or HEAD according to RFC 9110, Section 15.4.
+        """
+        content_specific_headers = [
+            "Content-Encoding",
+            "Content-Language",
+            "Content-Location",
+            "Content-Type",
+            "Content-Length",
+            "Digest",
+            "Last-Modified",
+        ]
+        for header in content_specific_headers:
+            self.discard(header)
+        return self
+
     # Backwards compatibility for httplib
     getheaders = getlist
     getallmatchingheaders = getlist
-- 
2.45.2

