From 1a09ad6433f9f8fd70c515cde7792ae12e3ce61a Mon Sep 17 00:00:00 2001
From: Matthew Fernandez <matthew.fernandez@gmail.com>
Date: Thu, 2 Oct 2025 17:15:15 -0700
Subject: [PATCH 1/3] lib: Make a doubling more readable

Suggested-by: Sebastian Pipping <sebastian@pipping.org>
---
 lib/xmlparse.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lib/xmlparse.c b/lib/xmlparse.c
index d804753..a48acd2 100644
--- a/lib/xmlparse.c
+++ b/lib/xmlparse.c
@@ -3492,7 +3492,7 @@ doContent(XML_Parser parser, int startTagLevel, const ENCODING *enc,
             tag->name.strLen = convLen;
             break;
           }
-          bufSize = (int)(tag->bufEnd - tag->buf) << 1;
+          bufSize = (int)(tag->bufEnd - tag->buf) * 2;
           {
             char *temp = (char *)REALLOC(parser, tag->buf, bufSize);
             if (temp == NULL)
-- 
2.45.4


From b74fa4400eb8a3a177a95ffbc9c27e61fdd3db6d Mon Sep 17 00:00:00 2001
From: Matthew Fernandez <matthew.fernandez@gmail.com>
Date: Thu, 2 Oct 2025 17:15:15 -0700
Subject: [PATCH 2/3] lib: Realign a size with the `REALLOC` type signature it
 is passed into

Note that this implicitly assumes `tag->bufEnd >= tag->buf`, which should
already be guaranteed true.
---
 lib/xmlparse.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/lib/xmlparse.c b/lib/xmlparse.c
index a48acd2..ed505b7 100644
--- a/lib/xmlparse.c
+++ b/lib/xmlparse.c
@@ -3481,7 +3481,6 @@ doContent(XML_Parser parser, int startTagLevel, const ENCODING *enc,
         const char *fromPtr = tag->rawName;
         toPtr = (XML_Char *)tag->buf;
         for (;;) {
-          int bufSize;
           int convLen;
           const enum XML_Convert_Result convert_res
               = XmlConvert(enc, &fromPtr, rawNameEnd, (ICHAR **)&toPtr,
@@ -3492,7 +3491,7 @@ doContent(XML_Parser parser, int startTagLevel, const ENCODING *enc,
             tag->name.strLen = convLen;
             break;
           }
-          bufSize = (int)(tag->bufEnd - tag->buf) * 2;
+          const size_t bufSize = (size_t)(tag->bufEnd - tag->buf) * 2;
           {
             char *temp = (char *)REALLOC(parser, tag->buf, bufSize);
             if (temp == NULL)
-- 
2.45.4


From 73d9f24f8815d46005bd3c5334f668a53c8957a2 Mon Sep 17 00:00:00 2001
From: Matthew Fernandez <matthew.fernandez@gmail.com>
Date: Thu, 2 Oct 2025 17:15:15 -0700
Subject: [PATCH 3/3] lib: Introduce an integer overflow check for tag buffer
 reallocation

Suggested-by: Sebastian Pipping <sebastian@pipping.org>
Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: https://github.com/libexpat/libexpat/pull/1075.patch
---
 lib/xmlparse.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/lib/xmlparse.c b/lib/xmlparse.c
index ed505b7..0bf913c 100644
--- a/lib/xmlparse.c
+++ b/lib/xmlparse.c
@@ -3491,6 +3491,8 @@ doContent(XML_Parser parser, int startTagLevel, const ENCODING *enc,
             tag->name.strLen = convLen;
             break;
           }
+          if (SIZE_MAX / 2 < (size_t)(tag->bufEnd - tag->buf))
+            return XML_ERROR_NO_MEMORY;
           const size_t bufSize = (size_t)(tag->bufEnd - tag->buf) * 2;
           {
             char *temp = (char *)REALLOC(parser, tag->buf, bufSize);
-- 
2.45.4

