From 3aa80b06043ea1161548cd7cd11b59ab52abefd6 Mon Sep 17 00:00:00 2001
From: rpm-build <rpm-build>
Date: Wed, 23 Jul 2025 15:54:51 +0000
Subject: [PATCH] AZL3 -- disable small rsa keys in fips mode

---
 apps/speed.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/apps/speed.c b/apps/speed.c
index a0a5da1..a3d3ca8 100644
--- a/apps/speed.c
+++ b/apps/speed.c
@@ -46,6 +46,7 @@
 #if !defined(OPENSSL_SYS_MSDOS)
 # include <unistd.h>
 #endif
+#include <openssl/fips.h>
 
 #if defined(_WIN32)
 # include <windows.h>
@@ -2549,6 +2550,15 @@ int speed_main(int argc, char **argv)
         memset(sigs_doit, 1, sizeof(sigs_doit));
         do_sigs = 1;
     }
+
+    // TOBIASB: Disable RSA sizes that aren't supported by FIPS
+    if (FIPS_mode()) {
+        for (i = 0; i < RSA_NUM; i++) {
+            if (rsa_keys[i].bits < 2048)
+                rsa_doit[i] = 0;
+        }
+    }
+
     for (i = 0; i < ALGOR_NUM; i++)
         if (doit[i])
             pr_header++;
-- 
2.45.4

