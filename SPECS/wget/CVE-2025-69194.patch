From 123ff418b984d84bdabb7fb7002719d4ebe19d72 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Tim=20R=C3=BChsen?= <tim.ruehsen@gmx.de>
Date: Fri, 26 Dec 2025 19:03:35 +0100
Subject: [PATCH] Fix file overwrite issue with metalink
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fix a remotely triggered arbitrary file write/overwrite abusing
metalink <file name="â€¦"> path traversal.

Reported-by: Arkadi <arkadva8@gmail.com>
Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: https://gitlab.com/gnuwget/wget2/-/commit/684be4785280fbe6b8666080bbdd87e7e5299ac5.patch
---
 libwget/metalink.c | 23 +++++++++++++++++++++--
 src/wget.c         | 25 ++++++++++++++++++-------
 2 files changed, 39 insertions(+), 9 deletions(-)

diff --git a/libwget/metalink.c b/libwget/metalink.c
index ecac46c..8d35065 100644
--- a/libwget/metalink.c
+++ b/libwget/metalink.c
@@ -167,6 +167,25 @@ static void add_mirror(metalink_context *ctx, const char *value)
 	ctx->priority = 999999;
 }
 
+static const char *sanitized_filename(const char *in)
+{
+	// RFC 5854:
+	//   The path MUST NOT contain any directory traversal
+	//   directives or information.  The path MUST be relative.  The path
+	//   MUST NOT begin with a "/", "./", or "../"; contain "/../"; or end
+	//   with "/..".
+	if (*in == '/'
+	    || !strncmp(in, "./", 2)
+	    || !strncmp(in, "../", 3)
+	    || strstr(in, "/../")
+	    || wget_match_tail(in, "/../"))
+	{
+		return NULL;
+	}
+
+	return wget_strdup(in);
+}
+
 static void metalink_parse(void *context, int flags, const char *dir, const char *attr, const char *val, size_t len, size_t pos WGET_GCC_UNUSED)
 {
 	metalink_context *ctx = context;
@@ -192,7 +211,7 @@ static void metalink_parse(void *context, int flags, const char *dir, const char
 		if (attr) {
 			if (*dir == 0) { // /metalink/file
 				if (!ctx->metalink->name && !wget_strcasecmp_ascii(attr, "name")) {
-					ctx->metalink->name = wget_strdup(value);
+					ctx->metalink->name = sanitized_filename(value);
 				}
 			} else if (!wget_strcasecmp_ascii(dir, "/verification/pieces")) {
 				if (!wget_strcasecmp_ascii(attr, "type")) {
@@ -237,7 +256,7 @@ static void metalink_parse(void *context, int flags, const char *dir, const char
 		if (attr) {
 			if (*dir == 0) { // /metalink/file
 				if (!ctx->metalink->name && !wget_strcasecmp_ascii(attr, "name")) {
-					ctx->metalink->name = wget_strdup(value);
+					ctx->metalink->name = sanitized_filename(value);
 				}
 			} else if (!wget_strcasecmp_ascii(dir, "/pieces")) {
 				if (!wget_strcasecmp_ascii(attr, "type")) {
diff --git a/src/wget.c b/src/wget.c
index b5e0f14..bbf9583 100644
--- a/src/wget.c
+++ b/src/wget.c
@@ -2085,18 +2085,26 @@ static void process_response(wget_http_response *resp)
 				error_printf(_("File length %llu - remove job\n"), (unsigned long long)job->metalink->size);
 			} else if (!job->metalink->mirrors) {
 				error_printf(_("No download mirrors found - remove job\n"));
+			} else if (!job->metalink->name || !*job->metalink->name) {
+				error_printf(_("Metalink file name is invalid, missing or empty - remove job\n"));
 			} else {
 				// just loaded a metalink description, create parts and sort mirrors
 
 				// start or resume downloading
 				if (!job_validate_file(job)) {
-					// sort mirrors by priority to download from highest priority first
-					wget_metalink_sort_mirrors(job->metalink);
-
-					// wake up sleeping workers
-					wget_thread_cond_signal(worker_cond);
-
-					job->done = 0; // do not remove this job from queue yet
+					// Account for retries
+					if (config.tries && ++job->failures > config.tries) {
+						error_printf(_("Metalink validation failed: max tries reached - remove job\n"));
+						job->done = 1;
+					} else {
+						// sort mirrors by priority to download from highest priority first
+						wget_metalink_sort_mirrors(job->metalink);
+
+						// wake up sleeping workers
+						wget_thread_cond_signal(worker_cond);
+
+						job->done = 0; // do not remove this job from queue yet
+					}
 				} // else file already downloaded and checksum ok
 			}
 			return;
@@ -2981,6 +2989,9 @@ void metalink_parse_localfile(const char *fname)
 		} else if (!metalink->mirrors) {
 			error_printf(_("No download mirrors found\n"));
 			wget_metalink_free(&metalink);
+		} else if (!metalink->name || !*metalink->name) {
+			error_printf(_("Metalink file name is missing or empty\n"));
+			wget_metalink_free(&metalink);
 		} else {
 			// create parts and sort mirrors
 			JOB job = { .metalink = metalink };
-- 
2.45.4

