From 0b49beb33a0f870b3677a5a4cff772f4428e867d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Tim=20R=C3=BChsen?= <tim.ruehsen@gmx.de>
Date: Fri, 26 Dec 2025 18:27:24 +0100
Subject: [PATCH] Fix remote buffer overflow in get_local_filename_real()

In src/blacklist.c:get_local_filename_real(), the stack/heap selection for
fname_esc was inverted, so the code used `char tmp[1024]` exactly when the
required size is >1024, leading to stack corruption when
wget_restrict_file_name() writes into it.

This was introduced by commit 3dc30f5f0c6f8feae97f866c537324f821ea05d.

Reported-by: Arkadi <arkadva8@gmail.com>
Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: https://gitlab.com/gnuwget/wget2/-/commit/fc7fcbc00e0a2c8606d44ab216195afb3f08cc98.patch
---
 src/blacklist.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/blacklist.c b/src/blacklist.c
index ca8d18e..71a74c3 100644
--- a/src/blacklist.c
+++ b/src/blacklist.c
@@ -135,8 +135,8 @@ static char * get_local_filename_real(const wget_iri *iri)
 		char tmp[1024];
 
 		char *fname_esc = (sizeof(tmp) < buf.length * 3 + 1)
-			? tmp
-			: wget_malloc(buf.length * 3 + 1);
+			? wget_malloc(buf.length * 3 + 1)
+			: tmp;
 
 		if (wget_restrict_file_name(fname, fname_esc, config.restrict_file_names) != fname) {
 			// escaping was really done, replace fname
-- 
2.45.4

