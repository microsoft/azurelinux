From 240706018d473566623f9175160a3ef0a8342d28 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Sat, 27 Dec 2025 06:27:39 +0000
Subject: [PATCH] tree: Guard against atype corruption; remove IDs based on
 actual ID value lookup instead of atype checks in xmlFreeProp, xmlSetTreeDoc,
 xmlSetNsProp, and before changing atype in validation (backport)

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://gitlab.gnome.org/GNOME/libxml2/-/commit/9de92ed78d8495527c5d7a4d0cc76c1f83768195.patch
---
 tree.c  | 33 ++++++++++++++++++++++++++-------
 valid.c |  9 +++++++++
 2 files changed, 35 insertions(+), 7 deletions(-)

diff --git a/tree.c b/tree.c
index 7172c46..daf1a05 100644
--- a/tree.c
+++ b/tree.c
@@ -2128,8 +2128,14 @@ xmlFreeProp(xmlAttrPtr cur) {
 	xmlDeregisterNodeDefaultValue((xmlNodePtr)cur);
 
     /* Check for ID removal -> leading to invalid references ! */
-    if ((cur->doc != NULL) && (cur->atype == XML_ATTRIBUTE_ID)) {
-	    xmlRemoveID(cur->doc, cur);
+    if (cur->doc != NULL) {
+        xmlChar *idval = xmlNodeListGetString(cur->doc, cur->children, 1);
+        if (idval != NULL) {
+            xmlAttrPtr idattr = xmlGetID(cur->doc, idval);
+            xmlFree(idval);
+            if (idattr == cur)
+                xmlRemoveID(cur->doc, cur);
+        }
     }
     if (cur->children != NULL) xmlFreeNodeList(cur->children);
     DICT_FREE(cur->name)
@@ -2877,8 +2883,14 @@ xmlSetTreeDoc(xmlNodePtr tree, xmlDocPtr doc) {
 	if(tree->type == XML_ELEMENT_NODE) {
 	    prop = tree->properties;
 	    while (prop != NULL) {
-                if (prop->atype == XML_ATTRIBUTE_ID) {
-                    xmlRemoveID(tree->doc, prop);
+                if (tree->doc != NULL) {
+                    xmlChar *idval = xmlNodeListGetString(tree->doc, prop->children, 1);
+                    if (idval != NULL) {
+                        xmlAttrPtr idattr = xmlGetID(tree->doc, idval);
+                        xmlFree(idval);
+                        if (idattr == prop)
+                            xmlRemoveID(tree->doc, prop);
+                    }
                 }
 
                 if (prop->doc != doc) {
@@ -7026,9 +7038,16 @@ xmlSetNsProp(xmlNodePtr node, xmlNsPtr ns, const xmlChar *name,
 	/*
 	* Modify the attribute's value.
 	*/
-	if (prop->atype == XML_ATTRIBUTE_ID) {
-	    xmlRemoveID(node->doc, prop);
-	    prop->atype = XML_ATTRIBUTE_ID;
+	if (node->doc != NULL) {
+	    xmlChar *idval = xmlNodeListGetString(node->doc, prop->children, 1);
+	    if (idval != NULL) {
+	        xmlAttrPtr idattr = xmlGetID(node->doc, idval);
+	        xmlFree(idval);
+	        if (idattr == prop) {
+	            xmlRemoveID(node->doc, prop);
+	            prop->atype = XML_ATTRIBUTE_ID;
+	        }
+	    }
 	}
 	if (prop->children != NULL)
 	    xmlFreeNodeList(prop->children);
diff --git a/valid.c b/valid.c
index 7eb2dd3..1389ade 100644
--- a/valid.c
+++ b/valid.c
@@ -4492,6 +4492,15 @@ xmlValidateOneAttribute(xmlValidCtxtPtr ctxt, xmlDocPtr doc,
 	       attr->name, elem->name, NULL);
 	return(0);
     }
+    if (doc != NULL) {
+        xmlChar *idval = xmlNodeListGetString(doc, attr->children, 1);
+        if (idval != NULL) {
+            xmlAttrPtr idattr = xmlGetID(doc, idval);
+            xmlFree(idval);
+            if (idattr == attr)
+                xmlRemoveID(doc, attr);
+        }
+    }
     attr->atype = attrDecl->atype;
 
     val = xmlValidateAttributeValueInternal(doc, attrDecl->atype, value);
-- 
2.45.4

