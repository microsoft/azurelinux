From 25a768556d7e7fcf29bc1e0f93bbfda698de5795 Mon Sep 17 00:00:00 2001
From: bala <balakumaran.kannan@microsoft.com>
Date: Tue, 19 Nov 2024 11:19:13 +0000
Subject: [PATCH] Vendor patch applied to fix CVE-2024-21538

---
 .../npm/_/node_modules/cross-spawn/lib/util/escape.js       | 6 ++++--
 .../node_modules/cross-spawn/lib/util/escape.js             | 6 ++++--
 2 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/tb_tmp/b069b9e9814ff76ffa6219506d1f1e79/external/npm/_/node_modules/cross-spawn/lib/util/escape.js b/tb_tmp/b069b9e9814ff76ffa6219506d1f1e79/external/npm/_/node_modules/cross-spawn/lib/util/escape.js
index b0bb84c..e4804b9 100644
--- a/tb_tmp/b069b9e9814ff76ffa6219506d1f1e79/external/npm/_/node_modules/cross-spawn/lib/util/escape.js
+++ b/tb_tmp/b069b9e9814ff76ffa6219506d1f1e79/external/npm/_/node_modules/cross-spawn/lib/util/escape.js
@@ -15,15 +15,17 @@ function escapeArgument(arg, doubleEscapeMetaChars) {
     arg = `${arg}`;
 
     // Algorithm below is based on https://qntm.org/cmd
+    // It's slightly altered to disable JS backtracking to avoid hanging on specially crafted input
+    // Please see https://github.com/moxystudio/node-cross-spawn/pull/160 for more information
 
     // Sequence of backslashes followed by a double quote:
     // double up all the backslashes and escape the double quote
-    arg = arg.replace(/(\\*)"/g, '$1$1\\"');
+    arg = arg.replace(/(?=\\*?)"/g, '$1$1\\"');
 
     // Sequence of backslashes followed by the end of the string
     // (which will become a double quote later):
     // double up all the backslashes
-    arg = arg.replace(/(\\*)$/, '$1$1');
+    arg = arg.replace(/(?=\\*?)$/, '$1$1');
 
     // All other backslashes occur literally
 
diff --git a/tb_tmp/b069b9e9814ff76ffa6219506d1f1e79/external/npm/_/node_modules/patch-package/node_modules/cross-spawn/lib/util/escape.js b/tb_tmp/b069b9e9814ff76ffa6219506d1f1e79/external/npm/_/node_modules/patch-package/node_modules/cross-spawn/lib/util/escape.js
index b0bb84c..e4804b9 100644
--- a/tb_tmp/b069b9e9814ff76ffa6219506d1f1e79/external/npm/_/node_modules/patch-package/node_modules/cross-spawn/lib/util/escape.js
+++ b/tb_tmp/b069b9e9814ff76ffa6219506d1f1e79/external/npm/_/node_modules/patch-package/node_modules/cross-spawn/lib/util/escape.js
@@ -15,15 +15,17 @@ function escapeArgument(arg, doubleEscapeMetaChars) {
     arg = `${arg}`;
 
     // Algorithm below is based on https://qntm.org/cmd
+    // It's slightly altered to disable JS backtracking to avoid hanging on specially crafted input
+    // Please see https://github.com/moxystudio/node-cross-spawn/pull/160 for more information
 
     // Sequence of backslashes followed by a double quote:
     // double up all the backslashes and escape the double quote
-    arg = arg.replace(/(\\*)"/g, '$1$1\\"');
+    arg = arg.replace(/(?=\\*?)"/g, '$1$1\\"');
 
     // Sequence of backslashes followed by the end of the string
     // (which will become a double quote later):
     // double up all the backslashes
-    arg = arg.replace(/(\\*)$/, '$1$1');
+    arg = arg.replace(/(?=\\*?)$/, '$1$1');
 
     // All other backslashes occur literally
 
-- 
2.39.4

