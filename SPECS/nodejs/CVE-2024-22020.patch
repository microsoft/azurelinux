From b2e718b4ce54713cd57207125cb02ff567a9bf04 Mon Sep 17 00:00:00 2001
From: Kanishk-Bansal <kbkanishk975@gmail.com>
Date: Tue, 11 Feb 2025 17:08:22 +0000
Subject: [PATCH] Fix CVE-2024-22020

---
 lib/internal/modules/esm/resolve.js | 17 +++++++++++++++--
 1 file changed, 15 insertions(+), 2 deletions(-)

diff --git a/lib/internal/modules/esm/resolve.js b/lib/internal/modules/esm/resolve.js
index 96dd20a8..de53b11f 100644
--- a/lib/internal/modules/esm/resolve.js
+++ b/lib/internal/modules/esm/resolve.js
@@ -1142,9 +1142,19 @@ function defaultResolve(specifier, context = {}) {
     } else {
       parsed = new URL(specifier);
     }
-
     // Avoid accessing the `protocol` property due to the lazy getters.
     const protocol = parsed.protocol;
+
+    if (protocol === 'data:' &&
+      parsedParentURL.protocol !== 'file:' &&
+      experimentalNetworkImports) {
+      throw new ERR_NETWORK_IMPORT_DISALLOWED(
+        specifier,
+        parsedParentURL,
+        'import data: from a non file: is not allowed',
+      );
+    }
+
     if (protocol === 'data:' ||
       (experimentalNetworkImports &&
         (
@@ -1155,7 +1165,10 @@ function defaultResolve(specifier, context = {}) {
     ) {
       return { __proto__: null, url: parsed.href };
     }
-  } catch {
+  } catch (e) {
+    if (e?.code === 'ERR_NETWORK_IMPORT_DISALLOWED') {
+      throw e;
+    }
     // Ignore exception
   }
 
-- 
2.45.2

