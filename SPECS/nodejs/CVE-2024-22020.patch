From 9defa3bb7532c1b7f3ea51aed9989954382ea5a9 Mon Sep 17 00:00:00 2001
From: Kanishk-Bansal <kbkanishk975@gmail.com>
Date: Tue, 11 Feb 2025 17:25:37 +0000
Subject: [PATCH] Fix CVE-2024-22020

---
 lib/internal/modules/esm/resolve.js | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/lib/internal/modules/esm/resolve.js b/lib/internal/modules/esm/resolve.js
index b56ad6cc..8cd08de8 100644
--- a/lib/internal/modules/esm/resolve.js
+++ b/lib/internal/modules/esm/resolve.js
@@ -1108,6 +1108,17 @@ function defaultResolve(specifier, context = {}) {
 
     // Avoid accessing the `protocol` property due to the lazy getters.
     protocol = parsed.protocol;
+
+    if (protocol === 'data:' &&
+      parsedParentURL.protocol !== 'file:' &&
+      experimentalNetworkImports) {
+      throw new ERR_NETWORK_IMPORT_DISALLOWED(
+        specifier,
+        parsedParentURL,
+        'import data: from a non file: is not allowed',
+      );
+    }
+
     if (protocol === 'data:' ||
       (experimentalNetworkImports &&
         (
@@ -1118,7 +1129,10 @@ function defaultResolve(specifier, context = {}) {
     ) {
       return { __proto__: null, url: parsed.href };
     }
-  } catch {
+  } catch (e) {
+    if (e?.code === 'ERR_NETWORK_IMPORT_DISALLOWED') {
+      throw e;
+    }
     // Ignore exception
   }
 
-- 
2.45.2

