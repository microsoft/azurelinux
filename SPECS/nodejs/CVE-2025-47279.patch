From 0df25374147ee336e08c3e5a67f98c3a0c9c74fb Mon Sep 17 00:00:00 2001
From: Aninda <v-anipradhan@microsoft.com>
Date: Wed, 21 May 2025 14:52:49 -0400
Subject: [PATCH] Address CVE-2025-47279
Upstream Patch Reference: https://github.com/nodejs/undici/commit/f317618ec28753a4218beccea048bcf89c36db25

---
 deps/undici/src/lib/pool.js | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/deps/undici/src/lib/pool.js b/deps/undici/src/lib/pool.js
index e3cd3399..86b29d44 100644
--- a/deps/undici/src/lib/pool.js
+++ b/deps/undici/src/lib/pool.js
@@ -73,6 +73,20 @@ class Pool extends PoolBase {
       ? { ...options.interceptors }
       : undefined
     this[kFactory] = factory
+
+    this.on('connectionError', (origin, targets, error) => {
+      // If a connection error occurs, we remove the client from the pool,
+      // and emit a connectionError event. They will not be re-used.
+      // Fixes https://github.com/nodejs/undici/issues/3895
+      for (const target of targets) {
+        // Do not use kRemoveClient here, as it will close the client,
+        // but the client cannot be closed in this state.
+        const idx = this[kClients].indexOf(target)
+        if (idx !== -1) {
+          this[kClients].splice(idx, 1)
+        }
+      }
+    })
   }
 
   [kGetDispatcher] () {
-- 
2.34.1

