From f10c803a9aad64d8a86abb10932a5aed6963c3bc Mon Sep 17 00:00:00 2001
From: rpm-build <rpm-build>
Date: Wed, 23 Jul 2025 15:54:51 +0000
Subject: [PATCH] AZL3 -- disable small rsa keys in fips mode

---
 apps/speed.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/apps/speed.c b/apps/speed.c
index d9055b5..079145f 100644
--- a/apps/speed.c
+++ b/apps/speed.c
@@ -40,6 +40,7 @@
 #if !defined(OPENSSL_SYS_MSDOS)
 # include <unistd.h>
 #endif
+#include <openssl/fips.h>
 
 #if defined(__TANDEM)
 # if defined(OPENSSL_TANDEM_FLOSS)
@@ -1907,6 +1908,15 @@ int speed_main(int argc, char **argv)
         memset(sm2_doit, 1, sizeof(sm2_doit));
 #endif
     }
+
+    // TOBIASB: Disable RSA sizes that aren't supported by FIPS
+    if (FIPS_mode()) {
+        for (i = 0; i < RSA_NUM; i++) {
+            if (rsa_keys[i].bits < 2048)
+                rsa_doit[i] = 0;
+        }
+    }
+
     for (i = 0; i < ALGOR_NUM; i++)
         if (doit[i])
             pr_header++;
-- 
2.45.4

