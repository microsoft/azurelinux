From 227d70de3e25cb0e20769a6d385bc0cadd96dfbb Mon Sep 17 00:00:00 2001
From: Ankita Pareek <ankitapareek@microsoft.com>
Date: Thu, 3 Jul 2025 20:40:50 +0000
Subject: [PATCH] kata-cc: Address CVE-2025-5791 in utarfs with a patch

Upstream reference: https://github.com/rustadopt/uzers-rs/commit/ac667c8bed3f171499ba67beb9d39dc0115636ff

Signed-off-by: Ankita Pareek <ankitapareek@microsoft.com>
---
 .../utarfs/vendor/users/src/base.rs | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/src/utarfs/vendor/users/src/base.rs b/src/utarfs/vendor/users/src/base.rs
index ece499ad..d0267599 100644
--- a/src/utarfs/vendor/users/src/base.rs
+++ b/src/utarfs/vendor/users/src/base.rs
@@ -749,10 +749,12 @@ pub fn group_access_list() -> io::Result<Vec<Group>> {
         Err(io::Error::last_os_error())
     }
     else {
-        let mut groups = buff.into_iter()
+        buff.truncate(res as usize);
+        buff.sort_unstable();
+        buff.dedup();
+        let groups = buff.into_iter()
                              .filter_map(get_group_by_gid)
                              .collect::<Vec<_>>();
-        groups.dedup_by_key(|i| i.gid());
         Ok(groups)
     }
 }
@@ -800,7 +802,11 @@ pub fn get_user_groups<S: AsRef<OsStr> + ?Sized>(username: &S, gid: gid_t) -> Op
         None
     }
     else {
+        buff.truncate(count as usize);
+        buff.sort_unstable();
         buff.dedup();
+        // allow trivial cast: on macos i is i32, on linux it's already gid_t
+        #[allow(trivial_numeric_casts)]
         buff.into_iter()
             .filter_map(|i| get_group_by_gid(i as gid_t))
             .collect::<Vec<_>>()
-- 
2.45.3

