From f744f3e169a35f39a2b79856c4a519fd36648784 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Sat, 15 Nov 2025 05:38:53 +0000
Subject: [PATCH] net/textproto: avoid quadratic complexity in
 Reader.ReadResponse

Reader.ReadResponse constructed a response string from repeated
string concatenation, permitting a malicious sender to cause excessive
memory allocation and CPU consumption by sending a response consisting
of many short lines.

Use a strings.Builder to construct the string instead.

Thanks to Jakub Ciolek for reporting this issue.

Fixes CVE-2025-61724
For #75716
Fixes #75718

Change-Id: I1a98ce85a21b830cb25799f9ac9333a67400d736
Reviewed-on: https://go-internal-review.googlesource.com/c/go/+/2940
Reviewed-by: Roland Shoemaker <bracewell@google.com>
Reviewed-by: Nicholas Husin <husin@google.com>
Reviewed-on: https://go-internal-review.googlesource.com/c/go/+/2960
Reviewed-by: Damien Neil <dneil@google.com>
Reviewed-on: https://go-review.googlesource.com/c/go/+/709846
Reviewed-by: Carlos Amedee <carlos@golang.org>
TryBot-Bypass: Michael Pratt <mpratt@google.com>
Auto-Submit: Michael Pratt <mpratt@google.com>
Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/golang/go/commit/5d7a787aa2b486f77537eeaed9c38c940a7182b8.patch
---
 src/net/textproto/reader.go | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/net/textproto/reader.go b/src/net/textproto/reader.go
index 2c926ca..77f4680 100644
--- a/src/net/textproto/reader.go
+++ b/src/net/textproto/reader.go
@@ -287,6 +287,8 @@ func (r *Reader) ReadResponse(expectCode int) (code int, message string, err err
 	code, continued, first, err := r.readCodeLine(expectCode)
 	multi := continued
 	var messageBuilder strings.Builder
+	// Use a strings.Builder to avoid quadratic complexity when constructing the message
+
 	messageBuilder.WriteString(first)
 	for continued {
 		line, err := r.ReadLine()
-- 
2.45.4

