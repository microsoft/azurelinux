From 073194de4c80bc8c6c010faa7d71ac9e3820e057 Mon Sep 17 00:00:00 2001
From: Glenn Song <gsong@hdfgroup.org>
Date: Wed, 27 Aug 2025 14:36:26 -0500
Subject: [PATCH 01/14] Move addr assert into if check

Upstream Patch Reference: https://patch-diff.githubusercontent.com/raw/HDFGroup/hdf5/pull/5746.patch
---
 hdf5-1.14.6/src/H5Faccum.c       | 3 +++
 hdf5-1.14.6/src/H5Ocache_image.c | 8 ++++++++
 2 files changed, 11 insertions(+)

diff --git a/hdf5-1.14.6/src/H5Faccum.c b/hdf5-1.14.6/src/H5Faccum.c
index 5fabf52..53f90fb 100644
--- a/hdf5-1.14.6/src/H5Faccum.c
+++ b/hdf5-1.14.6/src/H5Faccum.c
@@ -879,6 +879,9 @@ H5F__accum_free(H5F_shared_t *f_sh, H5FD_mem_t H5_ATTR_UNUSED type, haddr_t addr
 
                 /* Calculate the size of the overlap with the accumulator, etc. */
                 H5_CHECKED_ASSIGN(overlap_size, size_t, (addr + size) - accum->loc, haddr_t);
+                /* Sanity check */
+                /* Overlap size should not result in "negative" value after subtraction */
+                assert(overlap_size < accum->size);
                 new_accum_size = accum->size - overlap_size;
 
                 /* Move the accumulator buffer information to eliminate the freed block */
diff --git a/hdf5-1.14.6/src/H5Ocache_image.c b/hdf5-1.14.6/src/H5Ocache_image.c
index d91b463..07e44b7 100644
--- a/hdf5-1.14.6/src/H5Ocache_image.c
+++ b/hdf5-1.14.6/src/H5Ocache_image.c
@@ -116,6 +116,14 @@ H5O__mdci_decode(H5F_t *f, H5O_t H5_ATTR_UNUSED *open_oh, unsigned H5_ATTR_UNUSE
         HGOTO_ERROR(H5E_OHDR, H5E_OVERFLOW, NULL, "ran off end of input buffer while decoding");
     H5F_DECODE_LENGTH(f, p, mesg->size);
 
+    if (mesg->addr >= (HADDR_UNDEF - mesg->size))
+        HGOTO_ERROR(H5E_OHDR, H5E_OVERFLOW, NULL, "address plus size overflows");
+    if (mesg->addr == HADDR_UNDEF)
+        HGOTO_ERROR(H5E_OHDR, H5E_OVERFLOW, NULL, "address is undefined");
+    if ((mesg->addr + mesg->size) > H5F_get_eoa(f, H5FD_MEM_SUPER))
+        HGOTO_ERROR(H5E_OHDR, H5E_OVERFLOW, NULL, "address plus size exceeds file eoa");
+
+
     /* Set return value */
     ret_value = (void *)mesg;
 
-- 
2.45.4

