From 0e11a68b243d5f0b2f09def23cb7c67cbdf038cd Mon Sep 17 00:00:00 2001
From: fossedihelm <ffossemo@redhat.com>
Date: Mon, 15 Sep 2025 08:26:00 +0200
Subject: ctrl: Do not fallback using labels for getting ownerRef

Currently, in case the pods don't have the ownerRef, we
try to rely on pod labels to get the vmi owner ref.
This fallback should not be allowed because nowadays,
every pod created by KV have the ownerRef.

Signed-off-by: fossedihelm <ffossemo@redhat.com>

Upstream Patch Reference:
1. https://github.com/kubevirt/kubevirt/commit/0e11a68b243d5f0b2f09def23cb7c67cbdf038cd.patch
2. https://github.com/kubevirt/kubevirt/commit/2d6346ee45900dec7ae6178b599d12fd5f5c6a59.patch
---
 pkg/controller/controller_ref.go                  | 15 +--------------
 .../watch/drain/evacuation/evacuation_test.go     |  1 +
 .../watch/migration/migration_test.go             |  2 ++
 pkg/virt-controller/watch/node/node_test.go       |  1 +
 pkg/virt-controller/watch/vmi/vmi_test.go         |  3 +++
 .../workload-updater/workload-updater_test.go     |  1 +
 6 files changed, 9 insertions(+), 14 deletions(-)

diff --git a/pkg/controller/controller_ref.go b/pkg/controller/controller_ref.go
index 9a247de..8a672d2 100644
--- a/pkg/controller/controller_ref.go
+++ b/pkg/controller/controller_ref.go
@@ -20,26 +20,13 @@ package controller
 import (
 	k8sv1 "k8s.io/api/core/v1"
 	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
-	"k8s.io/apimachinery/pkg/types"
-
 	virtv1 "kubevirt.io/api/core/v1"
 )
 
 // GetControllerOf returns the controllerRef if controllee has a controller,
 // otherwise returns nil.
 func GetControllerOf(pod *k8sv1.Pod) *metav1.OwnerReference {
-	controllerRef := metav1.GetControllerOf(pod)
-	if controllerRef != nil {
-		return controllerRef
-	}
-	// We may find pods that are only using CreatedByLabel and not set with an OwnerReference
-	if createdBy := pod.Labels[virtv1.CreatedByLabel]; len(createdBy) > 0 {
-		name := pod.Annotations[virtv1.DomainAnnotation]
-		uid := types.UID(createdBy)
-		vmi := virtv1.NewVMI(name, uid)
-		return metav1.NewControllerRef(vmi, virtv1.VirtualMachineInstanceGroupVersionKind)
-	}
-	return nil
+	return metav1.GetControllerOf(pod)
 }
 
 func IsControlledBy(pod *k8sv1.Pod, vmi *virtv1.VirtualMachineInstance) bool {
diff --git a/pkg/virt-controller/watch/drain/evacuation/evacuation_test.go b/pkg/virt-controller/watch/drain/evacuation/evacuation_test.go
index a5dbfdd..4e6d131 100644
--- a/pkg/virt-controller/watch/drain/evacuation/evacuation_test.go
+++ b/pkg/virt-controller/watch/drain/evacuation/evacuation_test.go
@@ -601,6 +601,7 @@ func newPod(vmi *v1.VirtualMachineInstance, name string, phase k8sv1.PodPhase, o
 		pod.Annotations = map[string]string{
 			v1.DomainAnnotation: vmi.Name,
 		}
+		pod.OwnerReferences = []metav1.OwnerReference{*metav1.NewControllerRef(vmi, v1.VirtualMachineInstanceGroupVersionKind)}
 	}
 
 	return pod
diff --git a/pkg/virt-controller/watch/migration/migration_test.go b/pkg/virt-controller/watch/migration/migration_test.go
index 66c870e..9c5deb9 100644
--- a/pkg/virt-controller/watch/migration/migration_test.go
+++ b/pkg/virt-controller/watch/migration/migration_test.go
@@ -2412,6 +2412,7 @@ func newSourcePodForVirtualMachine(vmi *virtv1.VirtualMachineInstance) *k8sv1.Po
 			Annotations: map[string]string{
 				virtv1.DomainAnnotation: vmi.Name,
 			},
+			OwnerReferences: []metav1.OwnerReference{*metav1.NewControllerRef(vmi, virtv1.VirtualMachineInstanceGroupVersionKind)},
 		},
 		Status: k8sv1.PodStatus{
 			Phase: k8sv1.PodRunning,
@@ -2440,6 +2441,7 @@ func newTargetPodForVirtualMachine(vmi *virtv1.VirtualMachineInstance, migration
 				virtv1.DomainAnnotation:           vmi.Name,
 				virtv1.MigrationJobNameAnnotation: migration.Name,
 			},
+			OwnerReferences: []metav1.OwnerReference{*metav1.NewControllerRef(vmi, virtv1.VirtualMachineInstanceGroupVersionKind)},
 		},
 		Status: k8sv1.PodStatus{
 			Phase: phase,
diff --git a/pkg/virt-controller/watch/node/node_test.go b/pkg/virt-controller/watch/node/node_test.go
index ea1b930..cf2ef23 100644
--- a/pkg/virt-controller/watch/node/node_test.go
+++ b/pkg/virt-controller/watch/node/node_test.go
@@ -510,6 +510,7 @@ func NewHealthyPodForVirtualMachine(podName string, vmi *v1.VirtualMachineInstan
 				v1.CreatedByLabel: string(vmi.UID),
 				v1.AppLabel:       "virt-launcher",
 			},
+			OwnerReferences: []metav1.OwnerReference{*metav1.NewControllerRef(vmi, v1.VirtualMachineInstanceGroupVersionKind)},
 		},
 		Spec: k8sv1.PodSpec{NodeName: vmi.Status.NodeName},
 		Status: k8sv1.PodStatus{
diff --git a/pkg/virt-controller/watch/vmi/vmi_test.go b/pkg/virt-controller/watch/vmi/vmi_test.go
index 8a05cfd..35ee4e4 100644
--- a/pkg/virt-controller/watch/vmi/vmi_test.go
+++ b/pkg/virt-controller/watch/vmi/vmi_test.go
@@ -3909,6 +3909,9 @@ func newPodForVirtualMachine(vmi *virtv1.VirtualMachineInstance, phase k8sv1.Pod
 				virtv1.CreatedByLabel: string(vmi.UID),
 			},
 			Annotations: podAnnotations,
+			OwnerReferences: []metav1.OwnerReference{
+				*metav1.NewControllerRef(vmi, virtv1.VirtualMachineInstanceGroupVersionKind),
+			},
 		},
 		Status: k8sv1.PodStatus{
 			Phase: phase,
diff --git a/pkg/virt-controller/watch/workload-updater/workload-updater_test.go b/pkg/virt-controller/watch/workload-updater/workload-updater_test.go
index e320140..a7ae0df 100644
--- a/pkg/virt-controller/watch/workload-updater/workload-updater_test.go
+++ b/pkg/virt-controller/watch/workload-updater/workload-updater_test.go
@@ -715,6 +715,7 @@ func newLauncherPodForVMI(vmi *v1.VirtualMachineInstance) *k8sv1.Pod {
 			Annotations: map[string]string{
 				v1.DomainAnnotation: vmi.Name,
 			},
+			OwnerReferences: []metav1.OwnerReference{*metav1.NewControllerRef(vmi, v1.VirtualMachineInstanceGroupVersionKind)},
 		},
 		Status: k8sv1.PodStatus{
 			Phase: k8sv1.PodRunning,
-- 
2.45.4

