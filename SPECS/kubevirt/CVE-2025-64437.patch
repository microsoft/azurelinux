From 9a9f3ebab3f3e153b682e80b997dedf5ea7626f5 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Wed, 12 Nov 2025 11:00:50 +0000
Subject: [PATCH] isolation: ensure socket path is safe with no symlink
 following before extracting owner pid; import safepath package

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/kubevirt/kubevirt/commit/8644dbe0d04784b0bfa8395b91ecbd6001f88f6b.diff
---
 pkg/virt-handler/isolation/detector.go | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/pkg/virt-handler/isolation/detector.go b/pkg/virt-handler/isolation/detector.go
index 4dcc7bc..70885a4 100644
--- a/pkg/virt-handler/isolation/detector.go
+++ b/pkg/virt-handler/isolation/detector.go
@@ -35,6 +35,8 @@ import (
 
 	v1 "kubevirt.io/api/core/v1"
 	"kubevirt.io/client-go/log"
+	"kubevirt.io/kubevirt/pkg/safepath"
+
 
 	"kubevirt.io/kubevirt/pkg/util"
 	"kubevirt.io/kubevirt/pkg/virt-controller/services"
@@ -226,6 +228,11 @@ func (s *socketBasedIsolationDetector) getPid(socket string) (int, error) {
 		return -1, err
 	}
 	defer sock.Close()
+	_, err = safepath.NewPathNoFollow(socket)
+	if err != nil {
+		return -1, err
+	}
+
 
 	ufile, err := sock.(*net.UnixConn).File()
 	if err != nil {
-- 
2.45.4

