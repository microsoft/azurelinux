From 9b831f157651d6b6a45271536fdc9855aaf06873 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Wed, 12 Nov 2025 11:50:22 +0000
Subject: [PATCH] isolation: verify socket path with safepath.NewPathNoFollow
 before using UnixConn.File; add safepath import

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/kubevirt/kubevirt/commit/8644dbe0d04784b0bfa8395b91ecbd6001f88f6b.diff
---
 pkg/virt-handler/isolation/detector.go | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/pkg/virt-handler/isolation/detector.go b/pkg/virt-handler/isolation/detector.go
index 4dcc7bc..74fba5f 100644
--- a/pkg/virt-handler/isolation/detector.go
+++ b/pkg/virt-handler/isolation/detector.go
@@ -36,6 +36,7 @@ import (
 	v1 "kubevirt.io/api/core/v1"
 	"kubevirt.io/client-go/log"
 
+	"kubevirt.io/kubevirt/pkg/safepath"
 	"kubevirt.io/kubevirt/pkg/util"
 	"kubevirt.io/kubevirt/pkg/virt-controller/services"
 	cmdclient "kubevirt.io/kubevirt/pkg/virt-handler/cmd-client"
@@ -227,6 +228,12 @@ func (s *socketBasedIsolationDetector) getPid(socket string) (int, error) {
 	}
 	defer sock.Close()
 
+	_, err = safepath.NewPathNoFollow(socket)
+	if err != nil {
+		return -1, err
+	}
+
+
 	ufile, err := sock.(*net.UnixConn).File()
 	if err != nil {
 		return -1, err
-- 
2.45.4

