From e29ce49c89a9d3fd663c63e84173ada0d4b0247f Mon Sep 17 00:00:00 2001
From: Luboslav Pivarc <lpivarc@redhat.com>
Date: Tue, 22 Jul 2025 11:59:30 +0200
Subject: [PATCH] Detector: Use safepath

Signed-off-by: Luboslav Pivarc <lpivarc@redhat.com>
Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: https://github.com/kubevirt/kubevirt/commit/8644dbe0d04784b0bfa8395b91ecbd6001f88f6b.patch
---
 pkg/virt-handler/isolation/detector.go | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/pkg/virt-handler/isolation/detector.go b/pkg/virt-handler/isolation/detector.go
index 4dcc7bc..16db231 100644
--- a/pkg/virt-handler/isolation/detector.go
+++ b/pkg/virt-handler/isolation/detector.go
@@ -36,6 +36,7 @@ import (
 	v1 "kubevirt.io/api/core/v1"
 	"kubevirt.io/client-go/log"
 
+	"kubevirt.io/kubevirt/pkg/safepath"
 	"kubevirt.io/kubevirt/pkg/util"
 	"kubevirt.io/kubevirt/pkg/virt-controller/services"
 	cmdclient "kubevirt.io/kubevirt/pkg/virt-handler/cmd-client"
@@ -227,6 +228,10 @@ func (s *socketBasedIsolationDetector) getPid(socket string) (int, error) {
 	}
 	defer sock.Close()
 
+	_, err = safepath.NewPathNoFollow(socket)
+	if err != nil {
+		return -1, err
+	}
 	ufile, err := sock.(*net.UnixConn).File()
 	if err != nil {
 		return -1, err
-- 
2.45.4

