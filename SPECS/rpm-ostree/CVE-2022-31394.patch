From c0f0488db3d33caba1374ade3c7f8a3dfc5b3093 Mon Sep 17 00:00:00 2001
From: Nan Liu <liunan@microsoft.com>
Date: Thu, 9 Mar 2023 16:03:40 -0800
Subject: [PATCH] Address CVE-2022-31394

From 4f69d2193a0ccfd5d134f376fb490846c86aa0d7 Mon Sep 17 00:00:00 2001
From: silence <xxx@email.com>
Date: Sat, 7 May 2022 17:21:48 +0800
Subject: [PATCH 1/2] feat(h2): add max_header_list_size

From 2e149560809b60165dff5b548152a1f7dd8d8931 Mon Sep 17 00:00:00 2001
From: silence-coding <32766901+silence-coding@users.noreply.github.com>
Date: Fri, 13 May 2022 10:01:31 +0800
Subject: [PATCH 2/2] feat(h2): add max_header_list_size: rename
 max_header_list_size to http2_max_header_list_size

Co-authored-by: Sean McArthur <sean@seanmonstar.com>
---
---
 vendor/hyper/.cargo-checksum.json   |  2 +-
 vendor/hyper/src/proto/h2/server.rs |  7 ++++++-
 vendor/hyper/src/server/conn.rs     | 10 ++++++++++
 3 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/vendor/hyper/.cargo-checksum.json b/vendor/hyper/.cargo-checksum.json
index 3fbf2b6e..f374118a 100644
--- a/vendor/hyper/.cargo-checksum.json
+++ b/vendor/hyper/.cargo-checksum.json
@@ -1 +1 @@
-{"files":{"Cargo.lock":"121530b53be3586e43571d21d51c91d19d18e2f14c41d44966528f20ce8cd53e","Cargo.toml":"cd085dbc62f4898c8961a0bb5329c70776a89fe3e76518a3f6987493611e3155","LICENSE":"25dfd9ec24ebbee73dc93e687526cd4c26deae17bc2179ea0fe3e5dc96105b9b","src/body/aggregate.rs":"bcba09b9dd91deee04f17383cb0d7ac5d876f8d462e08031cd3dfca205f1d118","src/body/body.rs":"e407a7e7461aaa182b43090c072b34237e468d35806622dd009ea005772e87de","src/body/length.rs":"af3d145b9d23bd6a85a5877c3a20f4f55babd3630c741456604bd8362f6e20ff","src/body/mod.rs":"2870b04df5eef6a307a6f4699f99dbad54f5373bc95da4e6b29277efb645058f","src/body/to_bytes.rs":"48c2b5ab6e115d3ed4d5e31dfe1b40031e5e618abecda08454ff3cd36cab8c0d","src/cfg.rs":"32fea18ac8d861a69a7ebaa8cfb6a80f541efc18a9e2d9fde489cb9402fd6538","src/client/client.rs":"0ee3e03151a73ba771acffe9da59ac8fdc4b2076a19d60b65f06a3b3cedcf0a9","src/client/conn.rs":"396328c69c42b6293d78cc7ca8b7fccc9c6205b99b3cd2a3d99d539e0205dfa6","src/client/connect/dns.rs":"64613c0c02a1c464191dd4451c4e1b6ca9470a1589607539e122455be4ef1938","src/client/connect/http.rs":"4d7560a680e4eee3fd88336e6188abd4447cf0df084f735510961d4d7029ef7f","src/client/connect/mod.rs":"93f4c1230e2f667a19b05a1a6f428fd4cfae34a66a01361ad4f8c1538dd53d12","src/client/dispatch.rs":"597470446c0acc410ded2c282c8fa39c9d8b34fa972f4f28a058eb81b6a36eba","src/client/mod.rs":"bf00170b2a53eb433477e6cec1bc2ff83ad20814bc21186140d77575b7d77c7b","src/client/pool.rs":"a418271e9c5c2d06d9f9c7aa4e1ecd172c5a3505a23921caf48f424e02714ab7","src/client/service.rs":"54802c50753cc6f1cb19e92e284dcadd2bce667f9c72108ae7ff7ab173d73aa3","src/client/tests.rs":"ac9783128c74fe0369c9d03716b784940e70aca08288f806358adcc67a09fb43","src/common/buf.rs":"c762dc2688828ffc88f0549ceddeef65e57d404c245118bcacf3dd8d402bc9cc","src/common/date.rs":"f9a1a63aa7e8f5d6f5800cd56e7e6182cf07e781089930afb529263c1d8adf14","src/common/drain.rs":"262b64cc88e9146dfa3732a25ddb22dfef7cf801cebbd87fc1234b5e3e1d62bd","src/common/exec.rs":"a33a2018c9c0fed78590e7f05632f993aaf77d3f985a010c48eb3816696074ea","src/common/io/mod.rs":"6f8e4518df7f24d81fc59b46a2deb61557e8d92700bdc62539fe0f034066fc89","src/common/io/rewind.rs":"ba6704fe0b0f3d1af1184c680c97818962b1d8251e790cacfc9d56281cef23cd","src/common/lazy.rs":"f1a7ccad912492c23238f4c854e01b77e81db864455842cdc2890d76e464ff20","src/common/mod.rs":"effd3f5d6732864bf7ef18c783555bb41361030cb056aeb3087240ccd96eb750","src/common/never.rs":"b45b6a85f827081cdb7884907e7884c78540308102072dae563320acce8185fa","src/common/sync_wrapper.rs":"76206c2a52eeb62cdba279d620a4aef52134c6ac782a9f61e741edc8b653cb50","src/common/task.rs":"fd6444762d25ea6beb3b9f73bacf3b47c9f3f87e8e2037f58788b5d54767ce94","src/common/watch.rs":"eb6db13fbb266ec11200ffa1f5e7a9a132d7e6555373895efde1e2daea428e03","src/error.rs":"4c33fc4d1fa1791131f707bb0022141959f01e9cd05cefa0e9230c3088f89524","src/ext.rs":"0e7fc9911d4eb406c6b9ec4b8d05b7cc9acd3434bdd23fb094ac9620aa8205cf","src/ffi/body.rs":"b180f8ddaeeaacd1840dcb2b50ab7438b607114a9889aee0d78250e92c2126f6","src/ffi/client.rs":"f52081ca7a5a8f730f4202c53a1096f1e89526c9e72216da25049ad9b1692e45","src/ffi/error.rs":"63ce8238a3c59f2b7f03be52444419afadbf288d33cf598ba4deeec2c3b6b1d9","src/ffi/http_types.rs":"7eb8b4b8705feb87a2409e7bd5f8ce66c34b339f526890598ae9e92b402d3793","src/ffi/io.rs":"8bb6382a4c2ff0e05e479443387b3fb99c4ce9ae3693d22cdba2bc3b72e4ae0f","src/ffi/macros.rs":"6b7c2b9c0c39b3f7a1f773386fc7cb2c3d48317ae0a5e3a5ea55dab5c3f43197","src/ffi/mod.rs":"3897415949b4d975bbfd95be95c27d375eea113fad261624b2a158dc4d3b92f3","src/ffi/task.rs":"02a4d79d73666b03b008e90eec07172c7e97c915a02facf0d5d480991512dfa8","src/headers.rs":"8a69ad16e2b6ba65a5fb49a4c3c9d38f63c3010beb411d386db9899d2f5a72d9","src/lib.rs":"818b301c8aaeda96d86542e8d40c87a2ff46656ca2bd7dea68b69131f77be51d","src/mock.rs":"8b455312be74af6c4a27b3beba85a9493c86d43097947c5aad8a5e9dc0dcdbb3","src/proto/h1/conn.rs":"8e07557b9f40029add207ef2417c22aaf982c87bf6fa570105c7fc50f5d8c495","src/proto/h1/decode.rs":"c74800efde29ce54719258df3d081e3d368c7667aec97f58bc6e413665380e1c","src/proto/h1/dispatch.rs":"4d92123aeef7b18590cd3cf001fa26997c723aae0de2d1c35eace2507d66fc78","src/proto/h1/encode.rs":"1291851a8dc0ec62312a23ae0719ff706dd4b8bf8232cb1ac711f8cb9482b7f4","src/proto/h1/io.rs":"eaafe996edbc0e7f005252f2d164e2d86e83040a71deea86af9a38665eb9ad4e","src/proto/h1/mod.rs":"1ed23f47bdf145470cfd88a053276155df27a29cb43cd2b34d5765f6d6af135c","src/proto/h1/role.rs":"c6f7fb536d3d15c841ab7c0408910e0742c5de3a9857e7ec0dc2f4212a7da25b","src/proto/h2/client.rs":"bae89053348936e1b9fc140ed48fd5c93329cb5d31ffe7c66044bec3d4ae9928","src/proto/h2/mod.rs":"35a15ff91cd87ebc665f012dcfffef2b7cd276bcfadfac1632ca93a5fd7d73b1","src/proto/h2/ping.rs":"180814620245619b13379a9a8b652aceab9f7d503431edd4ef4ddcfc23940940","src/proto/h2/server.rs":"67f7f0082f6bab49306051496ac56922a1c3680b48fe53f3f26b0330da3d0d25","src/proto/mod.rs":"59d80eb673c0d518cfb11aadee60e42fd01ec63a80c968b9cace3d0612fea6be","src/rt.rs":"1ef7d4bb3ad6637c6f37189e30d740c061a3c98ca008d266a99f865130909427","src/server/accept.rs":"9a78398b0e9d8104248288b39cbcda8f9968a866214b7d793e548a5cf359752e","src/server/conn.rs":"c4371c82d4c44536ae2b2cdbf97a32f21d8e0da6849aa40609215440f7bef42a","src/server/mod.rs":"97b09fa3d5b88c574f4592e54ba72ec574d65373e9553f5c6af16fe6dc91de35","src/server/server.rs":"8a213840dd7735cedc8086461d30c28f29d6669056c34dea88e1d8f59526548b","src/server/shutdown.rs":"10abd9e2364728751985ec1f9956e2825b23d6148322e8fea4e0d1d03c6fefdd","src/server/tcp.rs":"ad089143989532ef8c3cae0b69ead6cbc5ae9f81d22087c554f92f14fff2ad3d","src/service/http.rs":"3e7c2c49e5710f9229d7b01f6f7a4e9f5c7c7360f14870f726aa470311998e65","src/service/make.rs":"7e3d956fd0602b47d3adc520f9a614cb047323d3d162faf9162066dccefe4d11","src/service/mod.rs":"92c05f08a175fb847868a02e7aca96176df1237458d40a17a7a6aa377476df90","src/service/oneshot.rs":"871b51c455d58dd3a6db85bd60e3a663d914ee748fe0c455c4523407533c8b1a","src/service/util.rs":"90452fc10c8316fdc1f0227c4fcef3cfb94e4b2d8fd52ef8c0e276cd3f1cadd5","src/upgrade.rs":"a866e77430de0fabc53e544eb8799e0380e146a59c53dd50aac23f70bea58380"},"package":"07d6baa1b441335f3ce5098ac421fb6547c46dda735ca1bc6d0153c838f9dd83"}
\ No newline at end of file
+{"files":{"Cargo.lock":"121530b53be3586e43571d21d51c91d19d18e2f14c41d44966528f20ce8cd53e","Cargo.toml":"cd085dbc62f4898c8961a0bb5329c70776a89fe3e76518a3f6987493611e3155","LICENSE":"25dfd9ec24ebbee73dc93e687526cd4c26deae17bc2179ea0fe3e5dc96105b9b","src/body/aggregate.rs":"bcba09b9dd91deee04f17383cb0d7ac5d876f8d462e08031cd3dfca205f1d118","src/body/body.rs":"e407a7e7461aaa182b43090c072b34237e468d35806622dd009ea005772e87de","src/body/length.rs":"af3d145b9d23bd6a85a5877c3a20f4f55babd3630c741456604bd8362f6e20ff","src/body/mod.rs":"2870b04df5eef6a307a6f4699f99dbad54f5373bc95da4e6b29277efb645058f","src/body/to_bytes.rs":"48c2b5ab6e115d3ed4d5e31dfe1b40031e5e618abecda08454ff3cd36cab8c0d","src/cfg.rs":"32fea18ac8d861a69a7ebaa8cfb6a80f541efc18a9e2d9fde489cb9402fd6538","src/client/client.rs":"0ee3e03151a73ba771acffe9da59ac8fdc4b2076a19d60b65f06a3b3cedcf0a9","src/client/conn.rs":"396328c69c42b6293d78cc7ca8b7fccc9c6205b99b3cd2a3d99d539e0205dfa6","src/client/connect/dns.rs":"64613c0c02a1c464191dd4451c4e1b6ca9470a1589607539e122455be4ef1938","src/client/connect/http.rs":"4d7560a680e4eee3fd88336e6188abd4447cf0df084f735510961d4d7029ef7f","src/client/connect/mod.rs":"93f4c1230e2f667a19b05a1a6f428fd4cfae34a66a01361ad4f8c1538dd53d12","src/client/dispatch.rs":"597470446c0acc410ded2c282c8fa39c9d8b34fa972f4f28a058eb81b6a36eba","src/client/mod.rs":"bf00170b2a53eb433477e6cec1bc2ff83ad20814bc21186140d77575b7d77c7b","src/client/pool.rs":"a418271e9c5c2d06d9f9c7aa4e1ecd172c5a3505a23921caf48f424e02714ab7","src/client/service.rs":"54802c50753cc6f1cb19e92e284dcadd2bce667f9c72108ae7ff7ab173d73aa3","src/client/tests.rs":"ac9783128c74fe0369c9d03716b784940e70aca08288f806358adcc67a09fb43","src/common/buf.rs":"c762dc2688828ffc88f0549ceddeef65e57d404c245118bcacf3dd8d402bc9cc","src/common/date.rs":"f9a1a63aa7e8f5d6f5800cd56e7e6182cf07e781089930afb529263c1d8adf14","src/common/drain.rs":"262b64cc88e9146dfa3732a25ddb22dfef7cf801cebbd87fc1234b5e3e1d62bd","src/common/exec.rs":"a33a2018c9c0fed78590e7f05632f993aaf77d3f985a010c48eb3816696074ea","src/common/io/mod.rs":"6f8e4518df7f24d81fc59b46a2deb61557e8d92700bdc62539fe0f034066fc89","src/common/io/rewind.rs":"ba6704fe0b0f3d1af1184c680c97818962b1d8251e790cacfc9d56281cef23cd","src/common/lazy.rs":"f1a7ccad912492c23238f4c854e01b77e81db864455842cdc2890d76e464ff20","src/common/mod.rs":"effd3f5d6732864bf7ef18c783555bb41361030cb056aeb3087240ccd96eb750","src/common/never.rs":"b45b6a85f827081cdb7884907e7884c78540308102072dae563320acce8185fa","src/common/sync_wrapper.rs":"76206c2a52eeb62cdba279d620a4aef52134c6ac782a9f61e741edc8b653cb50","src/common/task.rs":"fd6444762d25ea6beb3b9f73bacf3b47c9f3f87e8e2037f58788b5d54767ce94","src/common/watch.rs":"eb6db13fbb266ec11200ffa1f5e7a9a132d7e6555373895efde1e2daea428e03","src/error.rs":"4c33fc4d1fa1791131f707bb0022141959f01e9cd05cefa0e9230c3088f89524","src/ext.rs":"0e7fc9911d4eb406c6b9ec4b8d05b7cc9acd3434bdd23fb094ac9620aa8205cf","src/ffi/body.rs":"b180f8ddaeeaacd1840dcb2b50ab7438b607114a9889aee0d78250e92c2126f6","src/ffi/client.rs":"f52081ca7a5a8f730f4202c53a1096f1e89526c9e72216da25049ad9b1692e45","src/ffi/error.rs":"63ce8238a3c59f2b7f03be52444419afadbf288d33cf598ba4deeec2c3b6b1d9","src/ffi/http_types.rs":"7eb8b4b8705feb87a2409e7bd5f8ce66c34b339f526890598ae9e92b402d3793","src/ffi/io.rs":"8bb6382a4c2ff0e05e479443387b3fb99c4ce9ae3693d22cdba2bc3b72e4ae0f","src/ffi/macros.rs":"6b7c2b9c0c39b3f7a1f773386fc7cb2c3d48317ae0a5e3a5ea55dab5c3f43197","src/ffi/mod.rs":"3897415949b4d975bbfd95be95c27d375eea113fad261624b2a158dc4d3b92f3","src/ffi/task.rs":"02a4d79d73666b03b008e90eec07172c7e97c915a02facf0d5d480991512dfa8","src/headers.rs":"8a69ad16e2b6ba65a5fb49a4c3c9d38f63c3010beb411d386db9899d2f5a72d9","src/lib.rs":"818b301c8aaeda96d86542e8d40c87a2ff46656ca2bd7dea68b69131f77be51d","src/mock.rs":"8b455312be74af6c4a27b3beba85a9493c86d43097947c5aad8a5e9dc0dcdbb3","src/proto/h1/conn.rs":"8e07557b9f40029add207ef2417c22aaf982c87bf6fa570105c7fc50f5d8c495","src/proto/h1/decode.rs":"c74800efde29ce54719258df3d081e3d368c7667aec97f58bc6e413665380e1c","src/proto/h1/dispatch.rs":"4d92123aeef7b18590cd3cf001fa26997c723aae0de2d1c35eace2507d66fc78","src/proto/h1/encode.rs":"1291851a8dc0ec62312a23ae0719ff706dd4b8bf8232cb1ac711f8cb9482b7f4","src/proto/h1/io.rs":"eaafe996edbc0e7f005252f2d164e2d86e83040a71deea86af9a38665eb9ad4e","src/proto/h1/mod.rs":"1ed23f47bdf145470cfd88a053276155df27a29cb43cd2b34d5765f6d6af135c","src/proto/h1/role.rs":"c6f7fb536d3d15c841ab7c0408910e0742c5de3a9857e7ec0dc2f4212a7da25b","src/proto/h2/client.rs":"bae89053348936e1b9fc140ed48fd5c93329cb5d31ffe7c66044bec3d4ae9928","src/proto/h2/mod.rs":"35a15ff91cd87ebc665f012dcfffef2b7cd276bcfadfac1632ca93a5fd7d73b1","src/proto/h2/ping.rs":"180814620245619b13379a9a8b652aceab9f7d503431edd4ef4ddcfc23940940","src/proto/h2/server.rs":"113a8842be886090a1909e6363c5e3e0352f1cab88ada06af2496bdf8ec8ded7","src/proto/mod.rs":"59d80eb673c0d518cfb11aadee60e42fd01ec63a80c968b9cace3d0612fea6be","src/rt.rs":"1ef7d4bb3ad6637c6f37189e30d740c061a3c98ca008d266a99f865130909427","src/server/accept.rs":"9a78398b0e9d8104248288b39cbcda8f9968a866214b7d793e548a5cf359752e","src/server/conn.rs":"5191e8f6e97644eef46323bdbbff9f45d953ffa35eaeea5761f2ce902a0c8009","src/server/mod.rs":"97b09fa3d5b88c574f4592e54ba72ec574d65373e9553f5c6af16fe6dc91de35","src/server/server.rs":"8a213840dd7735cedc8086461d30c28f29d6669056c34dea88e1d8f59526548b","src/server/shutdown.rs":"10abd9e2364728751985ec1f9956e2825b23d6148322e8fea4e0d1d03c6fefdd","src/server/tcp.rs":"ad089143989532ef8c3cae0b69ead6cbc5ae9f81d22087c554f92f14fff2ad3d","src/service/http.rs":"3e7c2c49e5710f9229d7b01f6f7a4e9f5c7c7360f14870f726aa470311998e65","src/service/make.rs":"7e3d956fd0602b47d3adc520f9a614cb047323d3d162faf9162066dccefe4d11","src/service/mod.rs":"92c05f08a175fb847868a02e7aca96176df1237458d40a17a7a6aa377476df90","src/service/oneshot.rs":"871b51c455d58dd3a6db85bd60e3a663d914ee748fe0c455c4523407533c8b1a","src/service/util.rs":"90452fc10c8316fdc1f0227c4fcef3cfb94e4b2d8fd52ef8c0e276cd3f1cadd5","src/upgrade.rs":"a866e77430de0fabc53e544eb8799e0380e146a59c53dd50aac23f70bea58380"},"package":"07d6baa1b441335f3ce5098ac421fb6547c46dda735ca1bc6d0153c838f9dd83"}
\ No newline at end of file
diff --git a/vendor/hyper/src/proto/h2/server.rs b/vendor/hyper/src/proto/h2/server.rs
index 1222663d..7469f3bd 100644
--- a/vendor/hyper/src/proto/h2/server.rs
+++ b/vendor/hyper/src/proto/h2/server.rs
@@ -32,6 +32,8 @@ use crate::{Body, Response};
 const DEFAULT_CONN_WINDOW: u32 = 1024 * 1024; // 1mb
 const DEFAULT_STREAM_WINDOW: u32 = 1024 * 1024; // 1mb
 const DEFAULT_MAX_FRAME_SIZE: u32 = 1024 * 16; // 16kb
+// 16 MB "sane default" taken from golang http2
+const DEFAULT_SETTINGS_MAX_HEADER_LIST_SIZE: u32 = 16 << 20;
 
 #[derive(Clone, Debug)]
 pub(crate) struct Config {
@@ -44,6 +46,7 @@ pub(crate) struct Config {
     pub(crate) keep_alive_interval: Option<Duration>,
     #[cfg(feature = "runtime")]
     pub(crate) keep_alive_timeout: Duration,
+    pub(crate) max_header_list_size: u32,
 }
 
 impl Default for Config {
@@ -58,6 +61,7 @@ impl Default for Config {
             keep_alive_interval: None,
             #[cfg(feature = "runtime")]
             keep_alive_timeout: Duration::from_secs(20),
+            max_header_list_size: DEFAULT_SETTINGS_MAX_HEADER_LIST_SIZE,
         }
     }
 }
@@ -108,7 +112,8 @@ where
         builder
             .initial_window_size(config.initial_stream_window_size)
             .initial_connection_window_size(config.initial_conn_window_size)
-            .max_frame_size(config.max_frame_size);
+            .max_frame_size(config.max_frame_size)
+            .max_header_list_size(config.max_header_list_size);
         if let Some(max) = config.max_concurrent_streams {
             builder.max_concurrent_streams(max);
         }
diff --git a/vendor/hyper/src/server/conn.rs b/vendor/hyper/src/server/conn.rs
index 085f8901..6bbb2848 100644
--- a/vendor/hyper/src/server/conn.rs
+++ b/vendor/hyper/src/server/conn.rs
@@ -474,6 +474,16 @@ impl<E> Http<E> {
         self
     }
 
+    /// Sets the max size of received header frames.
+    ///
+    /// Default is currently ~16MB, but may change.
+    #[cfg(feature = "http2")]
+    #[cfg_attr(docsrs, doc(cfg(feature = "http2")))]
+    pub fn http2_max_header_list_size(&mut self, max: u32) -> &mut Self {
+        self.h2_builder.max_header_list_size = max;
+        self
+    }
+
     /// Set the maximum buffer size for the connection.
     ///
     /// Default is ~400kb.
-- 
2.25.1

