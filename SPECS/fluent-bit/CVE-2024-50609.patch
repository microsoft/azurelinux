From ce99c23a61cea708c2d5093031bdade0a620595a Mon Sep 17 00:00:00 2001
From: Eduardo Silva <eduardo@chronosphere.io>
Date: Sun, 23 Feb 2025 21:24:10 -0600
Subject: [PATCH 2/2] in_opentelemetry: fix handling of content-length
 (CVE-2024-50609)

Upstream Patch Reference:
https://github.com/fluent/fluent-bit/pull/9993

Signed-off-by: Eduardo Silva <eduardo@chronosphere.io>
---
 plugins/in_opentelemetry/opentelemetry_prot.c | 19 +++++++++++++++++++
 1 file changed, 19 insertions(+)

diff --git a/plugins/in_opentelemetry/opentelemetry_prot.c b/plugins/in_opentelemetry/opentelemetry_prot.c
index c1a45c4..2b40e09 100644
--- a/plugins/in_opentelemetry/opentelemetry_prot.c
+++ b/plugins/in_opentelemetry/opentelemetry_prot.c
@@ -1893,6 +1893,13 @@ int opentelemetry_prot_handle(struct flb_opentelemetry *ctx, struct http_conn *c
     original_data = request->data.data;
     original_data_size = request->data.len;
 
+    if (request->data.len <= 0) {
+        flb_sds_destroy(tag);
+        mk_mem_free(uri);
+        send_response(conn, 400, "error: no payload found\n");
+        return -1;
+    }
+
     ret = opentelemetry_prot_uncompress(session, request,
                                         &uncompressed_data,
                                         &uncompressed_data_size);
@@ -2462,6 +2469,18 @@ int opentelemetry_prot_handle_ng(struct flb_http_request *request,
         return -1;
     }
 
+    /* check content-length */
+    if (request->content_length <= 0) {
+        send_response_ng(response, 400, "error: invalid content-length\n");
+        return -1;
+    }
+
+    if (request->body == NULL) {
+        send_response_ng(response, 400, "error: invalid payload\n");
+        return -1;
+    }
+
+
     if (strcmp(request->path, "/v1/metrics") == 0 ||
         strcmp(request->path, "/opentelemetry.proto.collector.metric.v1.MetricService/Export") == 0 ||
         strcmp(request->path, "/opentelemetry.proto.collector.metrics.v1.MetricsService/Export") == 0) {
-- 
2.48.1.431.g5a526e5e18

