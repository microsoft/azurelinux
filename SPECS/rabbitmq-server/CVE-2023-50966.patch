# Fri Sep 20 2024 Archana Choudhary <archana1@microsoft.com>
# Patch for CVE-2023-50966, backported for jose 1.11.2 from 1.11.7
# Source: https://github.com/potatosalad/erlang-jose/commit/718d213f07b08056737923f8063d5df56dcb66ae
# Source2: https://github.com/potatosalad/erlang-jose/commit/a352bb579a98e5bdea4c72ac92b8923afea6dcec

diff --color -ruN a/deps/jose/src/jose.app.src b/deps/jose/src/jose.app.src
--- a/deps/jose/src/jose.app.src	2023-03-20 06:10:14.000000000 +0000
+++ b/deps/jose/src/jose.app.src	2024-09-20 10:07:36.441769560 +0000
@@ -10,4 +10,7 @@
               {licenses,["MIT"]},
               {links,[{"Github",
                        "https://github.com/potatosalad/erlang-jose"}]},
-              {env,[{crypto_fallback,true}]}]}.
+              {env, [
+              	{crypto_fallback, true},
+              	{pbes2_count_maximum, 10000}
+              ]}]}.
diff --color -ruN a/deps/jose/src/jose.erl b/deps/jose/src/jose.erl
--- a/deps/jose/src/jose.erl	2023-03-20 06:10:14.000000000 +0000
+++ b/deps/jose/src/jose.erl	2024-09-20 10:07:36.441769560 +0000
@@ -23,6 +23,8 @@
 -export([encode/1]).
 -export([json_module/0]).
 -export([json_module/1]).
+-export([pbes2_count_maximum/0]).
+-export([pbes2_count_maximum/1]).
 -export([sha3_module/0]).
 -export([sha3_module/1]).
 -export([unsecured_signing/0]).
@@ -84,17 +86,27 @@
 json_module(JSONModule) when is_atom(JSONModule) ->
 	?MAYBE_START_JOSE(jose_server:json_module(JSONModule)).
 
+-spec pbes2_count_maximum() -> non_neg_integer().
+pbes2_count_maximum() ->
+	?MAYBE_START_JOSE(ets:lookup_element(?TAB, pbes2_count_maximum, 2)).
+
+-spec pbes2_count_maximum(PBES2CountMaximum) -> ok when PBES2CountMaximum :: non_neg_integer().
+pbes2_count_maximum(PBES2CountMaximum) when is_integer(PBES2CountMaximum) andalso PBES2CountMaximum >= 0 ->
+	?MAYBE_START_JOSE(jose_server:pbes2_count_maximum(PBES2CountMaximum)).
+
 sha3_module() ->
 	?MAYBE_START_JOSE(ets:lookup_element(?TAB, sha3_module, 2)).
 
 sha3_module(SHA3Module) when is_atom(SHA3Module) ->
 	?MAYBE_START_JOSE(jose_server:sha3_module(SHA3Module)).
 
+-spec unsecured_signing() -> boolean().
 unsecured_signing() ->
-	jose_jwa:unsecured_signing().
+	?MAYBE_START_JOSE(ets:lookup_element(?TAB, unsecured_signing, 2)).
 
-unsecured_signing(Boolean) when is_boolean(Boolean) ->
-	jose_jwa:unsecured_signing(Boolean).
+-spec unsecured_signing(UnsecuredSigning) -> ok when UnsecuredSigning :: boolean().
+unsecured_signing(UnsecuredSigning) when is_boolean(UnsecuredSigning) ->
+	?MAYBE_START_JOSE(jose_server:unsecured_signing(UnsecuredSigning)).
 
 xchacha20_poly1305_module() ->
 	?MAYBE_START_JOSE(ets:lookup_element(?TAB, xchacha20_poly1305_module, 2)).
diff --color -ruN a/deps/jose/src/jose_server.erl b/deps/jose/src/jose_server.erl
--- a/deps/jose/src/jose_server.erl	2023-03-20 06:10:14.000000000 +0000
+++ b/deps/jose/src/jose_server.erl	2024-09-20 10:07:36.445769557 +0000
@@ -22,7 +22,9 @@
 -export([curve25519_module/1]).
 -export([curve448_module/1]).
 -export([json_module/1]).
+-export([pbes2_count_maximum/1]).
 -export([sha3_module/1]).
+-export([unsecured_signing/1]).
 -export([xchacha20_poly1305_module/1]).
 
 %% gen_server callbacks
@@ -72,9 +74,17 @@
 json_module(JSONModule) when is_atom(JSONModule) ->
 	gen_server:call(?SERVER, {json_module, JSONModule}).
 
+-spec pbes2_count_maximum(PBES2CountMaximum) -> ok when PBES2CountMaximum :: non_neg_integer().
+pbes2_count_maximum(PBES2CountMaximum) when is_integer(PBES2CountMaximum) andalso PBES2CountMaximum >= 0 ->
+	gen_server:call(?SERVER, {pbes2_count_maximum, PBES2CountMaximum}).
+
 sha3_module(SHA3Module) when is_atom(SHA3Module) ->
 	gen_server:call(?SERVER, {sha3_module, SHA3Module}).
 
+-spec unsecured_signing(UnsecuredSigning) -> ok when UnsecuredSigning :: boolean().
+unsecured_signing(UnsecuredSigning) when is_boolean(UnsecuredSigning) ->
+	gen_server:call(?SERVER, {unsecured_signing, UnsecuredSigning}).
+
 xchacha20_poly1305_module(XChaCha20Poly1305Module) when is_atom(XChaCha20Poly1305Module) ->
 	gen_server:call(?SERVER, {xchacha20_poly1305_module, XChaCha20Poly1305Module}).
 
@@ -114,10 +124,20 @@
 	JSONModule = check_json_module(M),
 	true = ets:insert(?TAB, {json_module, JSONModule}),
 	{reply, ok, State};
+handle_call({pbes2_count_maximum, PBES2CountMaximum}, _From, State) when is_integer(PBES2CountMaximum) andalso PBES2CountMaximum >= 0 ->
+	true = ets:insert(?TAB, {pbes2_count_maximum, PBES2CountMaximum}),
+	{reply, ok, State};
 handle_call({sha3_module, M}, _From, State) ->
 	SHA3Module = check_sha3_module(M),
 	true = ets:insert(?TAB, {sha3_module, SHA3Module}),
 	{reply, ok, State};
+handle_call({unsecured_signing, UnsecuredSigning}, _From, State) when is_boolean(UnsecuredSigning) ->
+	true = ets:insert(?TAB, {unsecured_signing, UnsecuredSigning}),
+	_ = spawn(fun() ->
+		_ = catch jose_jwa:unsecured_signing(UnsecuredSigning),
+		exit(normal)
+	end),
+	{reply, ok, State};
 handle_call({xchacha20_poly1305_module, M}, _From, State) ->
 	XChaCha20Poly1305Module = check_xchacha20_poly1305_module(M),
 	Entries = lists:flatten(check_crypto(?CRYPTO_FALLBACK, [{xchacha20_poly1305_module, XChaCha20Poly1305Module}])),
@@ -149,8 +169,18 @@
 
 %% @private
 support_check() ->
+	PBES2CountMaximum =
+		case application:get_env(jose, pbes2_count_maximum, 10000) of
+			V1 when is_integer(V1) andalso V1 >= 0 ->
+				V1
+		end,
+	UnsecuredSigning =
+		case application:get_env(jose, unsecured_signing, false) of
+			V2 when is_boolean(V2) ->
+				V2
+		end,
 	Fallback = ?CRYPTO_FALLBACK,
-	Entries = lists:flatten(lists:foldl(fun(Check, Acc) ->
+	Entries1 = lists:flatten(lists:foldl(fun(Check, Acc) ->
 		Check(Fallback, Acc)
 	end, [], [
 		fun check_ec_key_mode/2,
@@ -163,8 +193,13 @@
 		fun check_crypto/2,
 		fun check_public_key/2
 	])),
+	Entries2 = [
+		{pbes2_count_maximum, PBES2CountMaximum},
+		{unsecured_signing, UnsecuredSigning}
+		| Entries1
+	],
 	true = ets:delete_all_objects(?TAB),
-	true = ets:insert(?TAB, Entries),
+	true = ets:insert(?TAB, Entries2),
 	ok.
 
 %%%-------------------------------------------------------------------
diff --color -ruN a/deps/jose/src/jwa/jose_jwa.erl b/deps/jose/src/jwa/jose_jwa.erl
--- a/deps/jose/src/jwa/jose_jwa.erl	2023-03-20 06:10:14.000000000 +0000
+++ b/deps/jose/src/jwa/jose_jwa.erl	2024-09-20 10:07:36.445769557 +0000
@@ -368,7 +368,7 @@
 	].
 
 unsecured_signing() ->
-	application:get_env(jose, unsecured_signing, false).
+	jose:unsecured_signing().
 
 unsecured_signing(Boolean) when is_boolean(Boolean) ->
 	application:set_env(jose, unsecured_signing, Boolean),
diff --color -ruN a/deps/jose/src/jwe/jose_jwe_alg_pbes2.erl b/deps/jose/src/jwe/jose_jwe_alg_pbes2.erl
--- a/deps/jose/src/jwe/jose_jwe_alg_pbes2.erl	2023-03-20 06:10:14.000000000 +0000
+++ b/deps/jose/src/jwe/jose_jwe_alg_pbes2.erl	2024-09-20 10:07:36.445769557 +0000
@@ -23,6 +23,7 @@
 -export([key_encrypt/3]).
 -export([next_cek/3]).
 %% API
+-export([format_error/2]).
 -export([hmac_supported/0]).
 -export([wrap_supported/0]).
 
@@ -99,22 +100,22 @@
 		when is_binary(Password)
 		andalso is_binary(IV)
 		andalso is_binary(TAG) ->
-	{ok, DerivedKey} = jose_jwa_pkcs5:pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
+	{ok, DerivedKey} = pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
 	jose_jwa:block_decrypt({aes_gcm, Bits}, DerivedKey, IV, {<<>>, EncryptedKey, TAG});
 key_decrypt(Password, {_ENCModule, _ENC, EncryptedKey}, #jose_jwe_alg_pbes2{hmac=HMAC, salt=Salt, iter=Iterations, wrap=aes_kw, bits=Bits}) when is_binary(Password) ->
-	{ok, DerivedKey} = jose_jwa_pkcs5:pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
+	{ok, DerivedKey} = pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
 	jose_jwa_aes_kw:unwrap(EncryptedKey, DerivedKey);
 key_decrypt(Password, {_ENCModule, _ENC, EncryptedKey}, #jose_jwe_alg_pbes2{hmac=HMAC, salt=Salt, iter=Iterations, wrap=c20p_kw, bits=Bits, iv=IV, tag=TAG})
 		when is_binary(Password)
 		andalso is_binary(IV)
 		andalso is_binary(TAG) ->
-	{ok, DerivedKey} = jose_jwa_pkcs5:pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
+	{ok, DerivedKey} = pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
 	jose_jwa:block_decrypt({chacha20_poly1305, Bits}, DerivedKey, IV, {<<>>, EncryptedKey, TAG});
 key_decrypt(Password, {_ENCModule, _ENC, EncryptedKey}, #jose_jwe_alg_pbes2{hmac=HMAC, salt=Salt, iter=Iterations, wrap=xc20p_kw, bits=Bits, iv=IV, tag=TAG})
 		when is_binary(Password)
 		andalso is_binary(IV)
 		andalso is_binary(TAG) ->
-	{ok, DerivedKey} = jose_jwa_pkcs5:pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
+	{ok, DerivedKey} = pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
 	jose_jwa:block_decrypt({xchacha20_poly1305, Bits}, DerivedKey, IV, {<<>>, EncryptedKey, TAG});
 key_decrypt(#jose_jwk{kty={KTYModule, KTY}}, EncryptedKey, JWEPBES2=#jose_jwe_alg_pbes2{}) ->
 	key_decrypt(KTYModule:derive_key(KTY), EncryptedKey, JWEPBES2).
@@ -131,7 +132,7 @@
 		andalso is_binary(Salt)
 		andalso is_integer(Iterations)
 		andalso is_binary(IV) ->
-	{ok, DerivedKey} = jose_jwa_pkcs5:pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
+	{ok, DerivedKey} = pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
 	{CipherText, CipherTag} = jose_jwa:block_encrypt({aes_gcm, Bits}, DerivedKey, IV, {<<>>, DecryptedKey}),
 	{CipherText, JWEPBES2#jose_jwe_alg_pbes2{ tag = CipherTag }};
 key_encrypt(Password, DecryptedKey, JWEPBES2=#jose_jwe_alg_pbes2{hmac=HMAC, salt=Salt, iter=Iterations, wrap=aes_kw, bits=Bits})
@@ -139,7 +140,7 @@
 		andalso is_binary(DecryptedKey)
 		andalso is_binary(Salt)
 		andalso is_integer(Iterations) ->
-	{ok, DerivedKey} = jose_jwa_pkcs5:pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
+	{ok, DerivedKey} = pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
 	{jose_jwa_aes_kw:wrap(DecryptedKey, DerivedKey), JWEPBES2};
 key_encrypt(Password, DecryptedKey, JWEPBES2=#jose_jwe_alg_pbes2{hmac=HMAC, salt=Salt, iter=Iterations, wrap=c20p_kw, bits=Bits, iv=IV})
 		when is_binary(Password)
@@ -147,7 +148,7 @@
 		andalso is_binary(Salt)
 		andalso is_integer(Iterations)
 		andalso is_binary(IV) ->
-	{ok, DerivedKey} = jose_jwa_pkcs5:pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
+	{ok, DerivedKey} = pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
 	{CipherText, CipherTag} = jose_jwa:block_encrypt({chacha20_poly1305, Bits}, DerivedKey, IV, {<<>>, DecryptedKey}),
 	{CipherText, JWEPBES2#jose_jwe_alg_pbes2{ tag = CipherTag }};
 key_encrypt(Password, DecryptedKey, JWEPBES2=#jose_jwe_alg_pbes2{hmac=HMAC, salt=Salt, iter=Iterations, wrap=xc20p_kw, bits=Bits, iv=IV})
@@ -156,7 +157,7 @@
 		andalso is_binary(Salt)
 		andalso is_integer(Iterations)
 		andalso is_binary(IV) ->
-	{ok, DerivedKey} = jose_jwa_pkcs5:pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
+	{ok, DerivedKey} = pbkdf2({hmac, HMAC}, Password, Salt, Iterations, (Bits div 8) + (Bits rem 8)),
 	{CipherText, CipherTag} = jose_jwa:block_encrypt({xchacha20_poly1305, Bits}, DerivedKey, IV, {<<>>, DecryptedKey}),
 	{CipherText, JWEPBES2#jose_jwe_alg_pbes2{ tag = CipherTag }};
 key_encrypt(Password, DecryptedKey, JWEPBES2=#jose_jwe_alg_pbes2{wrap=aes_gcm_kw, iv=undefined}) when is_binary(Password) ->
@@ -175,6 +176,12 @@
 %% API functions
 %%====================================================================
 
+-spec format_error(term(), term()) -> term().
+format_error(_Reason, [{_M, _F, _As, Info} | _]) ->
+    ErrorInfo = proplists:get_value(error_info, Info, #{}),
+    ErrorDescription1 = maps:get(cause, ErrorInfo),
+    ErrorDescription1.
+
 hmac_supported() ->
 	[sha256, sha384, sha512].
 
@@ -198,6 +205,21 @@
 	{H, F}.
 
 %% @private
+pbkdf2(Mac, Password, Salt, Iterations, DerivedKeyLen) ->
+	PBES2CountMaximum = jose:pbes2_count_maximum(),
+	case PBES2CountMaximum < Iterations of
+		false ->
+			jose_jwa_pkcs5:pbkdf2(Mac, Password, Salt, Iterations, DerivedKeyLen);
+		true ->
+			erlang:error(badarg, [Mac, <<"REDACTED">>, Salt, Iterations, DerivedKeyLen], [
+				{error_info, #{
+					module => ?MODULE,
+					cause => #{4 => lists:flatten(io_lib:format("maximum PBES2 iterations is set to ~w, but ~w was attempted (see jose:pbes2_count_maximum/0)", [PBES2CountMaximum, Iterations]))}
+				}}
+			])
+	end.
+
+%% @private
 to_map_pbes2(F, H=#jose_jwe_alg_pbes2{ iter = P2C }) when is_integer(P2C) ->
 	to_map_pbes2(F#{ <<"p2c">> => P2C }, H#jose_jwe_alg_pbes2{ iter = undefined });
 to_map_pbes2(F, H=#jose_jwe_alg_pbes2{ salt = P2S }) when is_binary(P2S) ->
