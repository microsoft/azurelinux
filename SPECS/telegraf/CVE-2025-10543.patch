From dc05ddc627c4d247ffa5e401b3763b6465a3446c Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Mon, 8 Dec 2025 13:24:03 +0000
Subject: [PATCH] Fields over 65535 bytes noe encoded correctly

When encoding strings (1.5.3 in spec), and some other variable length fields, if the user passed in more then 65535 bytes the ouput would not be as expected (due to 16 byte header there is a hard limit). This change truncates output to 65535 bytes.

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/eclipse-paho/paho.mqtt.golang/commit/3162447fa892038e82256e918b681dc0c63a21ff.patch
---
 .../github.com/eclipse/paho.mqtt.golang/packets/packets.go  | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/vendor/github.com/eclipse/paho.mqtt.golang/packets/packets.go b/vendor/github.com/eclipse/paho.mqtt.golang/packets/packets.go
index b2d7ed1b..0f876c79 100644
--- a/vendor/github.com/eclipse/paho.mqtt.golang/packets/packets.go
+++ b/vendor/github.com/eclipse/paho.mqtt.golang/packets/packets.go
@@ -330,6 +330,12 @@ func decodeBytes(b io.Reader) ([]byte, error) {
 }
 
 func encodeBytes(field []byte) []byte {
+	// Attempting to encode more than 65,535 bytes would lead to an unexpected 16-bit length and extra data written
+	// (which would be parsed as later parts of the message). The safest option is to truncate.
+	if len(field) > 65535 {
+		field = field[0:65535]
+	}
+
 	fieldLength := make([]byte, 2)
 	binary.BigEndian.PutUint16(fieldLength, uint16(len(field)))
 	return append(fieldLength, field...)
-- 
2.45.4

