From 72848b9d706fd6e3e1ae4ab2dfbdcb898e705aac Mon Sep 17 00:00:00 2001
From: Kanishk-Bansal <kbkanishk975@gmail.com>
Date: Tue, 4 Mar 2025 17:26:49 +0000
Subject: [PATCH] CVE-2025-26594
Upstream Reference : https://gitlab.freedesktop.org/xorg/xserver/-/merge_requests/1828

---
 dix/dispatch.c | 4 ++++
 dix/main.c     | 4 ++++
 2 files changed, 8 insertions(+)

diff --git a/dix/dispatch.c b/dix/dispatch.c
index a33bfaa..9654c20 100644
--- a/dix/dispatch.c
+++ b/dix/dispatch.c
@@ -3039,6 +3039,10 @@ ProcFreeCursor(ClientPtr client)
     rc = dixLookupResourceByType((void **) &pCursor, stuff->id, RT_CURSOR,
                                  client, DixDestroyAccess);
     if (rc == Success) {
+        if (pCursor == rootCursor) {
+            client->errorValue = stuff->id;
+            return BadCursor;
+        }
         FreeResource(stuff->id, RT_NONE);
         return Success;
     }
diff --git a/dix/main.c b/dix/main.c
index b228d9c..f2606d3 100644
--- a/dix/main.c
+++ b/dix/main.c
@@ -235,6 +235,8 @@ dix_main(int argc, char *argv[], char *envp[])
                        defaultCursorFont);
         }
 
+        rootCursor = RefCursor(rootCursor);
+
 #ifdef PANORAMIX
         /*
          * Consolidate window and colourmap information for each screen
@@ -275,6 +277,8 @@ dix_main(int argc, char *argv[], char *envp[])
 
         Dispatch();
 
+        UnrefCursor(rootCursor);
+
         UndisplayDevices();
         DisableAllDevices();
 
-- 
2.45.2

