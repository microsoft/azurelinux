From dc2a01eaa17374992688d6b4f5b351863c1c19f5 Mon Sep 17 00:00:00 2001
From: Sreenivasulu Malavathula <v-smalavathu@microsoft.com>
Date: Mon, 23 Jun 2025 22:31:41 -0500
Subject: [PATCH] Address CVE-2025-49179
Upstream Patch Reference: https://gitlab.freedesktop.org/xorg/xserver/-/commit/2bde9ca49a8fd9a1e6697d5e7ef837870d66f5d4

---
 record/record.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/record/record.c b/record/record.c
index 05d751a..9851677 100644
--- a/record/record.c
+++ b/record/record.c
@@ -1289,6 +1289,7 @@ RecordPadAlign(int size, int align)
  *
  * Side Effects: none.
  */
+extern int LimitClients;
 static int
 RecordSanityCheckRegisterClients(RecordContextPtr pContext, ClientPtr client,
                                  xRecordRegisterClientsReq * stuff)
@@ -1298,6 +1299,13 @@ RecordSanityCheckRegisterClients(RecordContextPtr pContext, ClientPtr client,
     int i;
     XID recordingClient;
 
+    /* LimitClients is 2048 at max, way less that MAXINT */
+    if (stuff->nClients > LimitClients)
+        return BadValue;
+
+    if (stuff->nRanges > (MAXINT - 4 * stuff->nClients) / SIZEOF(xRecordRange))
+        return BadValue;
+
     if (((client->req_len << 2) - SIZEOF(xRecordRegisterClientsReq)) !=
         4 * stuff->nClients + SIZEOF(xRecordRange) * stuff->nRanges)
         return BadLength;
-- 
2.45.2

