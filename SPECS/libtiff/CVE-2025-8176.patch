From bb9b03313f18048a53d7ce2d94e56a4b2246fceb Mon Sep 17 00:00:00 2001
From: Lee Howard <faxguy@howardsilvan.com>
Date: Mon, 19 May 2025 10:53:30 -0700
Subject: [PATCH 1/3] Don't skip the first line of the input image. Addresses
 issue #703

---
 archive/tools/tiffdither.c | 4 ++--
 archive/tools/tiffmedian.c | 4 ++--
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/archive/tools/tiffdither.c b/archive/tools/tiffdither.c
index 187a61a..0c86e7f 100644
--- a/archive/tools/tiffdither.c
+++ b/archive/tools/tiffdither.c
@@ -98,7 +98,7 @@ static int fsdither(TIFF *in, TIFF *out)
     nextptr = nextline;
     for (j = 0; j < imagewidth; ++j)
         *nextptr++ = *inptr++;
-    for (i = 1; i < imagelength; ++i)
+    for (i = 0; i < imagelength; ++i)
     {
         tmpptr = thisline;
         thisline = nextline;
@@ -146,7 +146,7 @@ static int fsdither(TIFF *in, TIFF *out)
                     nextptr[0] += v / 16;
             }
         }
-        if (TIFFWriteScanline(out, outline, i - 1, 0) < 0)
+        if (TIFFWriteScanline(out, outline, i, 0) < 0)
             goto skip_on_error;
     }
     goto exit_label;
diff --git a/archive/tools/tiffmedian.c b/archive/tools/tiffmedian.c
index 334566a..291e73b 100644
--- a/archive/tools/tiffmedian.c
+++ b/archive/tools/tiffmedian.c
@@ -912,7 +912,7 @@ static void quant_fsdither(TIFF *in, TIFF *out)
     outline = (unsigned char *)_TIFFmalloc(TIFFScanlineSize(out));
 
     GetInputLine(in, 0, goto bad); /* get first line */
-    for (i = 1; i <= imagelength; ++i)
+    for (i = 0; i <= imagelength; ++i)
     {
         SWAP(short *, thisline, nextline);
         lastline = (i >= imax);
@@ -992,7 +992,7 @@ static void quant_fsdither(TIFF *in, TIFF *out)
                 nextptr += 3;
             }
         }
-        if (TIFFWriteScanline(out, outline, i - 1, 0) < 0)
+        if (TIFFWriteScanline(out, outline, i, 0) < 0)
             break;
     }
 bad:
-- 
2.45.4


From d0c7247863929e08d845c06c858da790bf324dca Mon Sep 17 00:00:00 2001
From: Lee Howard <faxguy@howardsilvan.com>
Date: Sat, 24 May 2025 21:25:16 -0700
Subject: [PATCH 2/3] Fix tiffmedian bug #707

---
 archive/tools/tiffmedian.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/archive/tools/tiffmedian.c b/archive/tools/tiffmedian.c
index 291e73b..b3b2671 100644
--- a/archive/tools/tiffmedian.c
+++ b/archive/tools/tiffmedian.c
@@ -410,7 +410,10 @@ static void get_histogram(TIFF *in, Colorbox *box)
     for (i = 0; i < imagelength; i++)
     {
         if (TIFFReadScanline(in, inputline, i, 0) <= 0)
-            break;
+        {
+            fprintf(stderr, "Error reading scanline\n");
+            exit(EXIT_FAILURE);
+        }
         inptr = inputline;
         for (j = imagewidth; j-- > 0;)
         {
-- 
2.45.4


From 7e2657583a539f680b3491bc6d17d355f32fbebf Mon Sep 17 00:00:00 2001
From: Lee Howard <faxguy@howardsilvan.com>
Date: Sat, 24 May 2025 21:38:09 -0700
Subject: [PATCH 3/3] conflict resolution

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: https://gitlab.com/libtiff/libtiff/-/merge_requests/727.patch
---
 archive/tools/tiffmedian.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/archive/tools/tiffmedian.c b/archive/tools/tiffmedian.c
index b3b2671..3d5c9ca 100644
--- a/archive/tools/tiffmedian.c
+++ b/archive/tools/tiffmedian.c
@@ -915,7 +915,7 @@ static void quant_fsdither(TIFF *in, TIFF *out)
     outline = (unsigned char *)_TIFFmalloc(TIFFScanlineSize(out));
 
     GetInputLine(in, 0, goto bad); /* get first line */
-    for (i = 0; i <= imagelength; ++i)
+    for (i = 0; i < imagelength; ++i)
     {
         SWAP(short *, thisline, nextline);
         lastline = (i >= imax);
-- 
2.45.4

