From 711cbcb097e6e0e633ee7123ac5cefa1e94022aa Mon Sep 17 00:00:00 2001
From: Lee Howard <faxguy@howardsilvan.com>
Date: Thu, 19 Jun 2025 11:51:33 -0700
Subject: [PATCH 1/2] Fix for thumbnail issue #715

---
 archive/tools/thumbnail.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/archive/tools/thumbnail.c b/archive/tools/thumbnail.c
index 8ce0d9b..a94a738 100644
--- a/archive/tools/thumbnail.c
+++ b/archive/tools/thumbnail.c
@@ -620,7 +620,15 @@ static void setrow(uint8_t *row, uint32_t nrows, const uint8_t *rows[])
             }
             acc += bits[*src & mask1];
         }
-        *row++ = cmap[(255 * acc) / area];
+        if (255 * acc / area < 256)
+        {
+            *row++ = cmap[(255 * acc) / area];
+        }
+        else
+        {
+            fprintf(stderr, "acc=%d, area=%d\n", acc, area);
+            row++;
+        }
     }
 }
 
-- 
2.45.4


From 73cc2dc864fb100769bab46f626da1f4465b518d Mon Sep 17 00:00:00 2001
From: Lee Howard <faxguy@howardsilvan.com>
Date: Mon, 23 Jun 2025 10:09:07 -0700
Subject: [PATCH 2/2] set a default value - assumes cmap[0] was not, itself,
 uninitialized

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: https://gitlab.com/libtiff/libtiff/-/merge_requests/737.patch
---
 archive/tools/thumbnail.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/archive/tools/thumbnail.c b/archive/tools/thumbnail.c
index a94a738..237d99e 100644
--- a/archive/tools/thumbnail.c
+++ b/archive/tools/thumbnail.c
@@ -627,7 +627,7 @@ static void setrow(uint8_t *row, uint32_t nrows, const uint8_t *rows[])
         else
         {
             fprintf(stderr, "acc=%d, area=%d\n", acc, area);
-            row++;
+            *row++ = cmap[0];
         }
     }
 }
-- 
2.45.4

