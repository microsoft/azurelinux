From a22866244736345239909eaca7be2eb8da791997 Mon Sep 17 00:00:00 2001
From: Viktor Chuchurski <viktor@doyensec.com>
Date: Thu, 25 Jul 2024 19:34:35 +0200
Subject: [PATCH 1/6] - added output encoding in redirect HTML

---
 src/twisted/test/test_redirect_html_escape.py | 46 +++++++++++++++++++
 src/twisted/web/_template_util.py             |  2 +-
 2 files changed, 47 insertions(+), 1 deletion(-)
 create mode 100644 src/twisted/test/test_redirect_html_escape.py

diff --git a/src/twisted/test/test_redirect_html_escape.py b/src/twisted/test/test_redirect_html_escape.py
new file mode 100644
index 00000000000..1f57808cced
--- /dev/null
+++ b/src/twisted/test/test_redirect_html_escape.py
@@ -0,0 +1,46 @@
+# Copyright (c) Twisted Matrix Laboratories.
+# See LICENSE for details.
+
+"""
+Tests for L{twisted.web.util.redirectTo}.
+"""
+from twisted.trial import unittest
+from twisted.web.util import redirectTo
+from twisted.web.test.requesthelper import DummyRequest
+
+class RedirectHtmlEscapeTests(unittest.TestCase):
+    def test_legitimate_redirect(self) -> None:
+        """
+        Test how redirectTo escapes legitimate URLs
+        """
+        request = DummyRequest([b""])
+        html = redirectTo(b'https://twisted.org/', request)
+        expected = b"""
+<html>
+    <head>
+        <meta http-equiv=\"refresh\" content=\"0;URL=https://twisted.org/\">
+    </head>
+    <body bgcolor=\"#FFFFFF\" text=\"#000000\">
+    <a href=\"https://twisted.org/\">click here</a>
+    </body>
+</html>
+""" 
+        self.assertEqual(html, expected)
+
+    def test_malicious_redirect(self) -> None:
+        """
+        Test how redirectTo escapes redirect URLs containing HTML tags
+        """
+        request = DummyRequest([b""])
+        html = redirectTo(b'https://twisted.org/"><script>alert(document.location)</script>', request)
+        expected = b"""
+<html>
+    <head>
+        <meta http-equiv=\"refresh\" content=\"0;URL=https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">
+    </head>
+    <body bgcolor=\"#FFFFFF\" text=\"#000000\">
+    <a href=\"https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">click here</a>
+    </body>
+</html>
+""" 
+        self.assertEqual(html, expected)
\ No newline at end of file
diff --git a/src/twisted/web/_template_util.py b/src/twisted/web/_template_util.py
index 230c33f3e8f..4f607fa8fbe 100644
--- a/src/twisted/web/_template_util.py
+++ b/src/twisted/web/_template_util.py
@@ -92,7 +92,7 @@ def render_GET(self, request):
     </body>
 </html>
 """ % {
-        b"url": URL
+        b"url": escape(URL.decode('utf-8')).encode('utf-8')
     }
     return content
 

From ed886e87dddad64f39ae094e12628dcc255c5aab Mon Sep 17 00:00:00 2001
From: Viktor Chuchurski <viktor@doyensec.com>
Date: Fri, 26 Jul 2024 10:22:48 +0200
Subject: [PATCH 2/6] - "redirectTo" HTML encoding test cleanup

---
 src/twisted/test/test_redirect_html_escape.py | 46 -------------------
 src/twisted/web/test/test_util.py             | 36 +++++++++++++++
 2 files changed, 36 insertions(+), 46 deletions(-)
 delete mode 100644 src/twisted/test/test_redirect_html_escape.py

diff --git a/src/twisted/test/test_redirect_html_escape.py b/src/twisted/test/test_redirect_html_escape.py
deleted file mode 100644
index 1f57808cced..00000000000
--- a/src/twisted/test/test_redirect_html_escape.py
+++ /dev/null
@@ -1,46 +0,0 @@
-# Copyright (c) Twisted Matrix Laboratories.
-# See LICENSE for details.
-
-"""
-Tests for L{twisted.web.util.redirectTo}.
-"""
-from twisted.trial import unittest
-from twisted.web.util import redirectTo
-from twisted.web.test.requesthelper import DummyRequest
-
-class RedirectHtmlEscapeTests(unittest.TestCase):
-    def test_legitimate_redirect(self) -> None:
-        """
-        Test how redirectTo escapes legitimate URLs
-        """
-        request = DummyRequest([b""])
-        html = redirectTo(b'https://twisted.org/', request)
-        expected = b"""
-<html>
-    <head>
-        <meta http-equiv=\"refresh\" content=\"0;URL=https://twisted.org/\">
-    </head>
-    <body bgcolor=\"#FFFFFF\" text=\"#000000\">
-    <a href=\"https://twisted.org/\">click here</a>
-    </body>
-</html>
-""" 
-        self.assertEqual(html, expected)
-
-    def test_malicious_redirect(self) -> None:
-        """
-        Test how redirectTo escapes redirect URLs containing HTML tags
-        """
-        request = DummyRequest([b""])
-        html = redirectTo(b'https://twisted.org/"><script>alert(document.location)</script>', request)
-        expected = b"""
-<html>
-    <head>
-        <meta http-equiv=\"refresh\" content=\"0;URL=https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">
-    </head>
-    <body bgcolor=\"#FFFFFF\" text=\"#000000\">
-    <a href=\"https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">click here</a>
-    </body>
-</html>
-""" 
-        self.assertEqual(html, expected)
\ No newline at end of file
diff --git a/src/twisted/web/test/test_util.py b/src/twisted/web/test/test_util.py
index 1e763009ca9..23af6146de1 100644
--- a/src/twisted/web/test/test_util.py
+++ b/src/twisted/web/test/test_util.py
@@ -394,3 +394,39 @@ def test_renderNoFailure(self):
         gc.collect()
         errors = self.flushLoggedErrors(RuntimeError)
         self.assertEqual(errors, [])
+
+    def test_legitimateRedirect(self) -> None:
+        """
+        Legitimate URLs are fully interpolated in the `redirectTo` response body without transformation
+        """
+        request = DummyRequest([b""])
+        html = redirectTo(b'https://twisted.org/', request)
+        expected = b"""
+<html>
+    <head>
+        <meta http-equiv=\"refresh\" content=\"0;URL=https://twisted.org/\">
+    </head>
+    <body bgcolor=\"#FFFFFF\" text=\"#000000\">
+    <a href=\"https://twisted.org/\">click here</a>
+    </body>
+</html>
+""" 
+        self.assertEqual(html, expected)
+
+    def test_maliciousRedirect(self) -> None:
+        """
+        Malicious URLs are HTML-escaped before interpolating them in the `redirectTo` response body
+        """
+        request = DummyRequest([b""])
+        html = redirectTo(b'https://twisted.org/"><script>alert(document.location)</script>', request)
+        expected = b"""
+<html>
+    <head>
+        <meta http-equiv=\"refresh\" content=\"0;URL=https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">
+    </head>
+    <body bgcolor=\"#FFFFFF\" text=\"#000000\">
+    <a href=\"https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">click here</a>
+    </body>
+</html>
+""" 
+        self.assertEqual(html, expected)

From 33edbedebad993c953905fcbaa15133c8d007bc2 Mon Sep 17 00:00:00 2001
From: Tom Most <twm@freecog.net>
Date: Fri, 26 Jul 2024 13:02:36 -0700
Subject: [PATCH 3/6] Automatic formatting changes

---
 src/twisted/web/_template_util.py |  2 +-
 src/twisted/web/test/test_util.py | 10 ++++++----
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/src/twisted/web/_template_util.py b/src/twisted/web/_template_util.py
index 4f607fa8fbe..7266079ac2e 100644
--- a/src/twisted/web/_template_util.py
+++ b/src/twisted/web/_template_util.py
@@ -92,7 +92,7 @@ def render_GET(self, request):
     </body>
 </html>
 """ % {
-        b"url": escape(URL.decode('utf-8')).encode('utf-8')
+        b"url": escape(URL.decode("utf-8")).encode("utf-8")
     }
     return content
 
diff --git a/src/twisted/web/test/test_util.py b/src/twisted/web/test/test_util.py
index 23af6146de1..5ed0818bf8d 100644
--- a/src/twisted/web/test/test_util.py
+++ b/src/twisted/web/test/test_util.py
@@ -400,7 +400,7 @@ def test_legitimateRedirect(self) -> None:
         Legitimate URLs are fully interpolated in the `redirectTo` response body without transformation
         """
         request = DummyRequest([b""])
-        html = redirectTo(b'https://twisted.org/', request)
+        html = redirectTo(b"https://twisted.org/", request)
         expected = b"""
 <html>
     <head>
@@ -410,7 +410,7 @@ def test_legitimateRedirect(self) -> None:
     <a href=\"https://twisted.org/\">click here</a>
     </body>
 </html>
-""" 
+"""
         self.assertEqual(html, expected)
 
     def test_maliciousRedirect(self) -> None:
@@ -418,7 +418,9 @@ def test_maliciousRedirect(self) -> None:
         Malicious URLs are HTML-escaped before interpolating them in the `redirectTo` response body
         """
         request = DummyRequest([b""])
-        html = redirectTo(b'https://twisted.org/"><script>alert(document.location)</script>', request)
+        html = redirectTo(
+            b'https://twisted.org/"><script>alert(document.location)</script>', request
+        )
         expected = b"""
 <html>
     <head>
@@ -428,5 +430,5 @@ def test_maliciousRedirect(self) -> None:
     <a href=\"https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">click here</a>
     </body>
 </html>
-""" 
+"""
         self.assertEqual(html, expected)

From c1aa1a9572dc1282abd89399d15b56c61b37b80b Mon Sep 17 00:00:00 2001
From: Tom Most <twm@freecog.net>
Date: Fri, 26 Jul 2024 13:08:29 -0700
Subject: [PATCH 4/6] Move tests, fix MyPy

---
 src/twisted/web/test/test_util.py | 77 +++++++++++++++----------------
 1 file changed, 38 insertions(+), 39 deletions(-)

diff --git a/src/twisted/web/test/test_util.py b/src/twisted/web/test/test_util.py
index 5ed0818bf8d..9847dcbb8b5 100644
--- a/src/twisted/web/test/test_util.py
+++ b/src/twisted/web/test/test_util.py
@@ -5,7 +5,6 @@
 Tests for L{twisted.web.util}.
 """
 
-
 import gc
 
 from twisted.internet import defer
@@ -64,6 +63,44 @@ def test_redirectToUnicodeURL(self):
         targetURL = "http://target.example.com/4321"
         self.assertRaises(TypeError, redirectTo, targetURL, request)
 
+    def test_legitimateRedirect(self):
+        """
+        Legitimate URLs are fully interpolated in the `redirectTo` response body without transformation
+        """
+        request = DummyRequest([b""])
+        html = redirectTo(b"https://twisted.org/", request)
+        expected = b"""
+<html>
+    <head>
+        <meta http-equiv=\"refresh\" content=\"0;URL=https://twisted.org/\">
+    </head>
+    <body bgcolor=\"#FFFFFF\" text=\"#000000\">
+    <a href=\"https://twisted.org/\">click here</a>
+    </body>
+</html>
+"""
+        self.assertEqual(html, expected)
+
+    def test_maliciousRedirect(self):
+        """
+        Malicious URLs are HTML-escaped before interpolating them in the `redirectTo` response body
+        """
+        request = DummyRequest([b""])
+        html = redirectTo(
+            b'https://twisted.org/"><script>alert(document.location)</script>', request
+        )
+        expected = b"""
+<html>
+    <head>
+        <meta http-equiv=\"refresh\" content=\"0;URL=https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">
+    </head>
+    <body bgcolor=\"#FFFFFF\" text=\"#000000\">
+    <a href=\"https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">click here</a>
+    </body>
+</html>
+"""
+        self.assertEqual(html, expected)
+
 
 class ParentRedirectTests(SynchronousTestCase):
     """
@@ -394,41 +431,3 @@ def test_renderNoFailure(self):
         gc.collect()
         errors = self.flushLoggedErrors(RuntimeError)
         self.assertEqual(errors, [])
-
-    def test_legitimateRedirect(self) -> None:
-        """
-        Legitimate URLs are fully interpolated in the `redirectTo` response body without transformation
-        """
-        request = DummyRequest([b""])
-        html = redirectTo(b"https://twisted.org/", request)
-        expected = b"""
-<html>
-    <head>
-        <meta http-equiv=\"refresh\" content=\"0;URL=https://twisted.org/\">
-    </head>
-    <body bgcolor=\"#FFFFFF\" text=\"#000000\">
-    <a href=\"https://twisted.org/\">click here</a>
-    </body>
-</html>
-"""
-        self.assertEqual(html, expected)
-
-    def test_maliciousRedirect(self) -> None:
-        """
-        Malicious URLs are HTML-escaped before interpolating them in the `redirectTo` response body
-        """
-        request = DummyRequest([b""])
-        html = redirectTo(
-            b'https://twisted.org/"><script>alert(document.location)</script>', request
-        )
-        expected = b"""
-<html>
-    <head>
-        <meta http-equiv=\"refresh\" content=\"0;URL=https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">
-    </head>
-    <body bgcolor=\"#FFFFFF\" text=\"#000000\">
-    <a href=\"https://twisted.org/&quot;&gt;&lt;script&gt;alert(document.location)&lt;/script&gt;\">click here</a>
-    </body>
-</html>
-"""
-        self.assertEqual(html, expected)

From eae359c7d186ae2337390f1798417a168cbe080e Mon Sep 17 00:00:00 2001
From: Tom Most <twm@freecog.net>
Date: Fri, 26 Jul 2024 13:10:09 -0700
Subject: [PATCH 5/6] Add newsfragment

---
 src/twisted/web/newsfragments/9839.bugfix | 1 +
 1 file changed, 1 insertion(+)
 create mode 100644 src/twisted/web/newsfragments/9839.bugfix

diff --git a/src/twisted/web/newsfragments/9839.bugfix b/src/twisted/web/newsfragments/9839.bugfix
new file mode 100644
index 00000000000..1e2e7f72986
--- /dev/null
+++ b/src/twisted/web/newsfragments/9839.bugfix
@@ -0,0 +1 @@
+twisted.web.util.redirectTo now HTML-escapes the provided URL in the fallback response body it returns (GHSA-cf56-g6w6-pqq2, CVE-2024-41810).

From bbb59e62473f67b2bef81f0cd3b66db2856e97fc Mon Sep 17 00:00:00 2001
From: Viktor Chuchurski <viktor@doyensec.com>
Date: Mon, 29 Jul 2024 13:43:41 +0200
Subject: [PATCH 6/6] - bugfix news fragment added

---
 src/twisted/web/newsfragments/12263.bugfix | 1 +
 1 file changed, 1 insertion(+)
 create mode 100644 src/twisted/web/newsfragments/12263.bugfix

diff --git a/src/twisted/web/newsfragments/12263.bugfix b/src/twisted/web/newsfragments/12263.bugfix
new file mode 100644
index 00000000000..b3982ca0fb5
--- /dev/null
+++ b/src/twisted/web/newsfragments/12263.bugfix
@@ -0,0 +1 @@
+twisted.web.util.redirectTo now HTML-escapes the provided URL in the fallback response body it returns (GHSA-cf56-g6w6-pqq2). The issue is being tracked with CVE-2024-41810.
\ No newline at end of file
