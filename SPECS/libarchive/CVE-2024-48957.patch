From 9a6a505a1da891df29909eb2aeb6f067fe46f7d3 Mon Sep 17 00:00:00 2001
From: Nan Liu <liunan@microsoft.com>
Date: Tue, 15 Oct 2024 18:44:56 +0000
Subject: [PATCH] fix: OOB in rar audio filter(CVE-2024-48957)

---
From 3ad7b9b6cc37d8a197a6c55af4634560df13771f Mon Sep 17 00:00:00 2001
From: Wei-Cheng Pan <legnaleurc@gmail.com>
Date: Fri, 26 Apr 2024 16:35:06 +0900
Subject: [PATCH] fix: OOB in rar audio filter

---
 libarchive/archive_read_support_format_rar.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/libarchive/archive_read_support_format_rar.c b/libarchive/archive_read_support_format_rar.c
index dae2309..6510bcf 100644
--- a/libarchive/archive_read_support_format_rar.c
+++ b/libarchive/archive_read_support_format_rar.c
@@ -3716,6 +3716,12 @@ execute_filter_audio(struct rar_filter *filter, struct rar_virtual_machine *vm)
     memset(&state, 0, sizeof(state));
     for (j = i; j < length; j += numchannels)
     {
+      /*
+       * The src block should not overlap with the dst block.
+       * If so it would be better to consider this archive is broken.
+       */
+      if (src >= dst)
+        return 0;
       int8_t delta = (int8_t)*src++;
       uint8_t predbyte, byte;
       int prederror;
-- 
2.34.1

