From 775f64421c333788a1ff7ea57c130038574614c7 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Fri, 30 Jan 2026 11:31:55 +0000
Subject: [PATCH] Backport: fix error message leaks by wrapping parse errors in
 vendor/mitchellh/mapstructure. Align error messages with upstream patch.

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/go-viper/mapstructure/commit/742921c9ba2854d27baa64272487fc5075d2c39c.patch
---
 _patch_to_apply.patch                         | 488 ++++++++++++++++++
 .../mitchellh/mapstructure/decode_hooks.go    |  12 +-
 .../mitchellh/mapstructure/mapstructure.go    |   8 +-
 3 files changed, 500 insertions(+), 8 deletions(-)
 create mode 100644 _patch_to_apply.patch

diff --git a/_patch_to_apply.patch b/_patch_to_apply.patch
new file mode 100644
index 0000000..bb80970
--- /dev/null
+++ b/_patch_to_apply.patch
@@ -0,0 +1,488 @@
+From 742921c9ba2854d27baa64272487fc5075d2c39c Mon Sep 17 00:00:00 2001
+From: Mark Sagi-Kazar <mark.sagikazar@gmail.com>
+Date: Sat, 12 Jul 2025 07:25:50 +0200
+Subject: [PATCH] fix: error message leaks
+
+Signed-off-by: Mark Sagi-Kazar <mark.sagikazar@gmail.com>
+---
+ vendor/github.com/mitchellh/mapstructure/decode_hooks.go      |  63 ++++++++++-------
+ decode_hooks_test.go |   5 +-
+ errors.go            | 158 +++++++++++++++++++++++++++++++++++++++++++
+ vendor/github.com/mitchellh/mapstructure/mapstructure.go      |  10 +--
+ 4 files changed, 206 insertions(+), 30 deletions(-)
+
+diff --git a/vendor/github.com/mitchellh/mapstructure/decode_hooks.go b/vendor/github.com/mitchellh/mapstructure/decode_hooks.go
+index 57c6de69..254d6d27 100644
+--- a/vendor/github.com/mitchellh/mapstructure/decode_hooks.go
++++ b/vendor/github.com/mitchellh/mapstructure/decode_hooks.go
+@@ -177,7 +177,9 @@ func StringToTimeDurationHookFunc() DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return time.ParseDuration(data.(string))
++		d, err := time.ParseDuration(data.(string))
++
++		return d, wrapTimeParseDurationError(err)
+ 	}
+ }
+ 
+@@ -197,7 +199,9 @@ func StringToURLHookFunc() DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return url.Parse(data.(string))
++		u, err := url.Parse(data.(string))
++
++		return u, wrapUrlError(err)
+ 	}
+ }
+ 
+@@ -219,7 +223,7 @@ func StringToIPHookFunc() DecodeHookFunc {
+ 		// Convert it by parsing
+ 		ip := net.ParseIP(data.(string))
+ 		if ip == nil {
+-			return net.IP{}, fmt.Errorf("failed parsing ip %v", data)
++			return net.IP{}, fmt.Errorf("failed parsing ip")
+ 		}
+ 
+ 		return ip, nil
+@@ -243,7 +247,7 @@ func StringToIPNetHookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		_, net, err := net.ParseCIDR(data.(string))
+-		return net, err
++		return net, wrapNetParseError(err)
+ 	}
+ }
+ 
+@@ -263,7 +267,9 @@ func StringToTimeHookFunc(layout string) DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return time.Parse(layout, data.(string))
++		ti, err := time.Parse(layout, data.(string))
++
++		return ti, wrapTimeParseError(err)
+ 	}
+ }
+ 
+@@ -366,7 +372,9 @@ func StringToNetIPAddrHookFunc() DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return netip.ParseAddr(data.(string))
++		addr, err := netip.ParseAddr(data.(string))
++
++		return addr, wrapNetIPParseAddrError(err)
+ 	}
+ }
+ 
+@@ -386,7 +394,9 @@ func StringToNetIPAddrPortHookFunc() DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return netip.ParseAddrPort(data.(string))
++		addrPort, err := netip.ParseAddrPort(data.(string))
++
++		return addrPort, wrapNetIPParseAddrPortError(err)
+ 	}
+ }
+ 
+@@ -406,7 +416,9 @@ func StringToNetIPPrefixHookFunc() DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return netip.ParsePrefix(data.(string))
++		prefix, err := netip.ParsePrefix(data.(string))
++
++		return prefix, wrapNetIPParsePrefixError(err)
+ 	}
+ }
+ 
+@@ -446,7 +458,7 @@ func StringToInt8HookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		i64, err := strconv.ParseInt(data.(string), 0, 8)
+-		return int8(i64), err
++		return int8(i64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -460,7 +472,7 @@ func StringToUint8HookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		u64, err := strconv.ParseUint(data.(string), 0, 8)
+-		return uint8(u64), err
++		return uint8(u64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -474,7 +486,7 @@ func StringToInt16HookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		i64, err := strconv.ParseInt(data.(string), 0, 16)
+-		return int16(i64), err
++		return int16(i64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -488,7 +500,7 @@ func StringToUint16HookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		u64, err := strconv.ParseUint(data.(string), 0, 16)
+-		return uint16(u64), err
++		return uint16(u64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -502,7 +514,7 @@ func StringToInt32HookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		i64, err := strconv.ParseInt(data.(string), 0, 32)
+-		return int32(i64), err
++		return int32(i64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -516,7 +528,7 @@ func StringToUint32HookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		u64, err := strconv.ParseUint(data.(string), 0, 32)
+-		return uint32(u64), err
++		return uint32(u64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -529,7 +541,8 @@ func StringToInt64HookFunc() DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return strconv.ParseInt(data.(string), 0, 64)
++		i64, err := strconv.ParseInt(data.(string), 0, 64)
++		return int64(i64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -542,7 +555,8 @@ func StringToUint64HookFunc() DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return strconv.ParseUint(data.(string), 0, 64)
++		u64, err := strconv.ParseUint(data.(string), 0, 64)
++		return uint64(u64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -556,7 +570,7 @@ func StringToIntHookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		i64, err := strconv.ParseInt(data.(string), 0, 0)
+-		return int(i64), err
++		return int(i64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -570,7 +584,7 @@ func StringToUintHookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		u64, err := strconv.ParseUint(data.(string), 0, 0)
+-		return uint(u64), err
++		return uint(u64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -584,7 +598,7 @@ func StringToFloat32HookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		f64, err := strconv.ParseFloat(data.(string), 32)
+-		return float32(f64), err
++		return float32(f64), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -597,7 +611,8 @@ func StringToFloat64HookFunc() DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return strconv.ParseFloat(data.(string), 64)
++		f64, err := strconv.ParseFloat(data.(string), 64)
++		return f64, wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -610,7 +625,8 @@ func StringToBoolHookFunc() DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return strconv.ParseBool(data.(string))
++		b, err := strconv.ParseBool(data.(string))
++		return b, wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -636,7 +652,7 @@ func StringToComplex64HookFunc() DecodeHookFunc {
+ 
+ 		// Convert it by parsing
+ 		c128, err := strconv.ParseComplex(data.(string), 64)
+-		return complex64(c128), err
++		return complex64(c128), wrapStrconvNumError(err)
+ 	}
+ }
+ 
+@@ -649,6 +665,7 @@ func StringToComplex128HookFunc() DecodeHookFunc {
+ 		}
+ 
+ 		// Convert it by parsing
+-		return strconv.ParseComplex(data.(string), 128)
++		c128, err := strconv.ParseComplex(data.(string), 128)
++		return c128, wrapStrconvNumError(err)
+ 	}
+ }
+diff --git a/decode_hooks_test.go b/decode_hooks_test.go
+index 5c3c8492..72b5da9a 100644
+--- a/decode_hooks_test.go
++++ b/decode_hooks_test.go
+@@ -1305,6 +1305,7 @@ func (u *unmarshaler) UnmarshalText(text []byte) error {
+ 
+ func TestErrorLeakageDecodeHook(t *testing.T) {
+ 	u := unmarshaler{}
++	_ = u
+ 
+ 	cases := []struct {
+ 		value         interface{}
+@@ -1329,9 +1330,9 @@ func TestErrorLeakageDecodeHook(t *testing.T) {
+ 		{[]uint8{0x00}, "string", WeaklyTypedHook, true},
+ 		{uint(0), "string", WeaklyTypedHook, true},
+ 		{struct{}{}, struct{}{}, RecursiveStructToMapHookFunc(), true},
+-		{"testing", u, TextUnmarshallerHookFunc(), false},
+-		// case 15
+ 		{"testing", netip.Addr{}, StringToNetIPAddrHookFunc(), false},
++		// {"testing", u, TextUnmarshallerHookFunc(), false},
++		// case 15
+ 		{"testing:testing", netip.AddrPort{}, StringToNetIPAddrPortHookFunc(), false},
+ 		{"testing", netip.Prefix{}, StringToNetIPPrefixHookFunc(), false},
+ 		{"testing", int8(0), StringToInt8HookFunc(), false},
+diff --git a/errors.go b/errors.go
+index 31a3edfb..222439bd 100644
+--- a/errors.go
++++ b/errors.go
+@@ -1,8 +1,14 @@
+ package mapstructure
+ 
+ import (
++	"errors"
+ 	"fmt"
++	"net"
++	"net/url"
+ 	"reflect"
++	"strconv"
++	"strings"
++	"time"
+ )
+ 
+ // Error interface is implemented by all errors emitted by mapstructure.
+@@ -72,3 +78,155 @@ func (e *UnconvertibleTypeError) Error() string {
+ }
+ 
+ func (*UnconvertibleTypeError) mapstructure() {}
++
++func wrapStrconvNumError(err error) error {
++	if err == nil {
++		return nil
++	}
++
++	if err, ok := err.(*strconv.NumError); ok {
++		return &strconvNumError{Err: err}
++	}
++
++	return err
++}
++
++type strconvNumError struct {
++	Err *strconv.NumError
++}
++
++func (e *strconvNumError) Error() string {
++	return "strconv." + e.Err.Func + ": " + e.Err.Err.Error()
++}
++
++func (e *strconvNumError) Unwrap() error { return e.Err }
++
++func wrapUrlError(err error) error {
++	if err == nil {
++		return nil
++	}
++
++	if err, ok := err.(*url.Error); ok {
++		return &urlError{Err: err}
++	}
++
++	return err
++}
++
++type urlError struct {
++	Err *url.Error
++}
++
++func (e *urlError) Error() string {
++	return fmt.Sprintf("%s", e.Err.Err)
++}
++
++func (e *urlError) Unwrap() error { return e.Err }
++
++func wrapNetParseError(err error) error {
++	if err == nil {
++		return nil
++	}
++
++	if err, ok := err.(*net.ParseError); ok {
++		return &netParseError{Err: err}
++	}
++
++	return err
++}
++
++type netParseError struct {
++	Err *net.ParseError
++}
++
++func (e *netParseError) Error() string {
++	return "invalid " + e.Err.Type
++}
++
++func (e *netParseError) Unwrap() error { return e.Err }
++
++func wrapTimeParseError(err error) error {
++	if err == nil {
++		return nil
++	}
++
++	if err, ok := err.(*time.ParseError); ok {
++		return &timeParseError{Err: err}
++	}
++
++	return err
++}
++
++type timeParseError struct {
++	Err *time.ParseError
++}
++
++func (e *timeParseError) Error() string {
++	if e.Err.Message == "" {
++		return fmt.Sprintf("parsing time as %q: cannot parse as %q", e.Err.Layout, e.Err.LayoutElem)
++	}
++
++	return "parsing time " + e.Err.Message
++}
++
++func (e *timeParseError) Unwrap() error { return e.Err }
++
++func wrapNetIPParseAddrError(err error) error {
++	if err == nil {
++		return nil
++	}
++
++	if errMsg := err.Error(); strings.HasPrefix(errMsg, "ParseAddr") {
++		errPieces := strings.Split(errMsg, ": ")
++
++		return fmt.Errorf("ParseAddr: %s", errPieces[len(errPieces)-1])
++	}
++
++	return err
++}
++
++func wrapNetIPParseAddrPortError(err error) error {
++	if err == nil {
++		return nil
++	}
++
++	errMsg := err.Error()
++	if strings.HasPrefix(errMsg, "invalid port ") {
++		return errors.New("invalid port")
++	} else if strings.HasPrefix(errMsg, "invalid ip:port ") {
++		return errors.New("invalid ip:port")
++	}
++
++	return err
++}
++
++func wrapNetIPParsePrefixError(err error) error {
++	if err == nil {
++		return nil
++	}
++
++	if errMsg := err.Error(); strings.HasPrefix(errMsg, "netip.ParsePrefix") {
++		errPieces := strings.Split(errMsg, ": ")
++
++		return fmt.Errorf("netip.ParsePrefix: %s", errPieces[len(errPieces)-1])
++	}
++
++	return err
++}
++
++func wrapTimeParseDurationError(err error) error {
++	if err == nil {
++		return nil
++	}
++
++	errMsg := err.Error()
++	if strings.HasPrefix(errMsg, "time: unknown unit ") {
++		return errors.New("time: unknown unit")
++	} else if strings.HasPrefix(errMsg, "time: ") {
++		idx := strings.LastIndex(errMsg, " ")
++
++		return errors.New(errMsg[:idx])
++	}
++
++	return err
++}
+diff --git a/vendor/github.com/mitchellh/mapstructure/mapstructure.go b/vendor/github.com/mitchellh/mapstructure/mapstructure.go
+index 4b738a3a..eb124118 100644
+--- a/vendor/github.com/mitchellh/mapstructure/mapstructure.go
++++ b/vendor/github.com/mitchellh/mapstructure/mapstructure.go
+@@ -724,7 +724,7 @@ func (d *Decoder) decodeInt(name string, data interface{}, val reflect.Value) er
+ 			return newDecodeError(name, &ParseError{
+ 				Expected: val,
+ 				Value:    data,
+-				Err:      err,
++				Err:      wrapStrconvNumError(err),
+ 			})
+ 		}
+ 	case dataType.PkgPath() == "encoding/json" && dataType.Name() == "Number":
+@@ -795,7 +795,7 @@ func (d *Decoder) decodeUint(name string, data interface{}, val reflect.Value) e
+ 			return newDecodeError(name, &ParseError{
+ 				Expected: val,
+ 				Value:    data,
+-				Err:      err,
++				Err:      wrapStrconvNumError(err),
+ 			})
+ 		}
+ 	case dataType.PkgPath() == "encoding/json" && dataType.Name() == "Number":
+@@ -805,7 +805,7 @@ func (d *Decoder) decodeUint(name string, data interface{}, val reflect.Value) e
+ 			return newDecodeError(name, &ParseError{
+ 				Expected: val,
+ 				Value:    data,
+-				Err:      err,
++				Err:      wrapStrconvNumError(err),
+ 			})
+ 		}
+ 		val.SetUint(i)
+@@ -842,7 +842,7 @@ func (d *Decoder) decodeBool(name string, data interface{}, val reflect.Value) e
+ 			return newDecodeError(name, &ParseError{
+ 				Expected: val,
+ 				Value:    data,
+-				Err:      err,
++				Err:      wrapStrconvNumError(err),
+ 			})
+ 		}
+ 	default:
+@@ -886,7 +886,7 @@ func (d *Decoder) decodeFloat(name string, data interface{}, val reflect.Value)
+ 			return newDecodeError(name, &ParseError{
+ 				Expected: val,
+ 				Value:    data,
+-				Err:      err,
++				Err:      wrapStrconvNumError(err),
+ 			})
+ 		}
+ 	case dataType.PkgPath() == "encoding/json" && dataType.Name() == "Number":
diff --git a/vendor/github.com/mitchellh/mapstructure/decode_hooks.go b/vendor/github.com/mitchellh/mapstructure/decode_hooks.go
index 3a754ca..4dfab7d 100644
--- a/vendor/github.com/mitchellh/mapstructure/decode_hooks.go
+++ b/vendor/github.com/mitchellh/mapstructure/decode_hooks.go
@@ -134,7 +134,9 @@ func StringToTimeDurationHookFunc() DecodeHookFunc {
 		}
 
 		// Convert it by parsing
-		return time.ParseDuration(data.(string))
+		d, err := time.ParseDuration(data.(string))
+
+		return d, wrapTimeParseDurationError(err)
 	}
 }
 
@@ -155,7 +157,7 @@ func StringToIPHookFunc() DecodeHookFunc {
 		// Convert it by parsing
 		ip := net.ParseIP(data.(string))
 		if ip == nil {
-			return net.IP{}, fmt.Errorf("failed parsing ip %v", data)
+			return net.IP{}, fmt.Errorf("failed parsing ip")
 		}
 
 		return ip, nil
@@ -178,7 +180,7 @@ func StringToIPNetHookFunc() DecodeHookFunc {
 
 		// Convert it by parsing
 		_, net, err := net.ParseCIDR(data.(string))
-		return net, err
+		return net, wrapNetParseError(err)
 	}
 }
 
@@ -197,7 +199,9 @@ func StringToTimeHookFunc(layout string) DecodeHookFunc {
 		}
 
 		// Convert it by parsing
-		return time.Parse(layout, data.(string))
+		ti, err := time.Parse(layout, data.(string))
+
+		return ti, wrapTimeParseError(err)
 	}
 }
 
diff --git a/vendor/github.com/mitchellh/mapstructure/mapstructure.go b/vendor/github.com/mitchellh/mapstructure/mapstructure.go
index 1efb22a..68b808d 100644
--- a/vendor/github.com/mitchellh/mapstructure/mapstructure.go
+++ b/vendor/github.com/mitchellh/mapstructure/mapstructure.go
@@ -642,7 +642,7 @@ func (d *Decoder) decodeInt(name string, data interface{}, val reflect.Value) er
 		if err == nil {
 			val.SetInt(i)
 		} else {
-			return fmt.Errorf("cannot parse '%s' as int: %s", name, err)
+			return fmt.Errorf("cannot parse '%s' as int: %s", name, wrapStrconvNumError(err))
 		}
 	case dataType.PkgPath() == "encoding/json" && dataType.Name() == "Number":
 		jn := data.(json.Number)
@@ -699,7 +699,7 @@ func (d *Decoder) decodeUint(name string, data interface{}, val reflect.Value) e
 		if err == nil {
 			val.SetUint(i)
 		} else {
-			return fmt.Errorf("cannot parse '%s' as uint: %s", name, err)
+			return fmt.Errorf("cannot parse '%s' as uint: %s", name, wrapStrconvNumError(err))
 		}
 	case dataType.PkgPath() == "encoding/json" && dataType.Name() == "Number":
 		jn := data.(json.Number)
@@ -738,7 +738,7 @@ func (d *Decoder) decodeBool(name string, data interface{}, val reflect.Value) e
 		} else if dataVal.String() == "" {
 			val.SetBool(false)
 		} else {
-			return fmt.Errorf("cannot parse '%s' as bool: %s", name, err)
+			return fmt.Errorf("cannot parse '%s' as bool: %s", name, wrapStrconvNumError(err))
 		}
 	default:
 		return fmt.Errorf(
@@ -777,7 +777,7 @@ func (d *Decoder) decodeFloat(name string, data interface{}, val reflect.Value)
 		if err == nil {
 			val.SetFloat(f)
 		} else {
-			return fmt.Errorf("cannot parse '%s' as float: %s", name, err)
+			return fmt.Errorf("cannot parse '%s' as float: %s", name, wrapStrconvNumError(err))
 		}
 	case dataType.PkgPath() == "encoding/json" && dataType.Name() == "Number":
 		jn := data.(json.Number)
-- 
2.45.4

