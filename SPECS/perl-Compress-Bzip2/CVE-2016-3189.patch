From 5e4d075627b36c51b3df3c5c0d05f70db6bf6a51 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Thu, 18 Dec 2025 07:00:10 +0000
Subject: [PATCH] =?UTF-8?q?Backport:=20bzip2recover=20fix=20=E2=80=93=20en?=
 =?UTF-8?q?sure=20outFile/handle=20set=20to=20NULL=20after=20closing;=20ap?=
 =?UTF-8?q?ply=20to=20Bzip2.xs=20close=20paths=20per=20original.patch=20gu?=
 =?UTF-8?q?idance?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://bugzilla-attachments.redhat.com/attachment.cgi?id=1169843
---
 Bzip2.xs | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/Bzip2.xs b/Bzip2.xs
index 0d8d0e9..b6e653c 100644
--- a/Bzip2.xs
+++ b/Bzip2.xs
@@ -889,9 +889,11 @@ int bzfile_closeread( obj, abandon ) bzFile* obj; int abandon; {
   obj->nBufferBytes = 0;	/* toss getreadline data */
   obj->pending_io_error = False;
 
-  if ( obj->handle )
+  if ( obj->handle ) {
     if ( 0 != PerlIO_close( obj->handle ) )
       ret = BZ_SETERR(obj, BZ_IO_ERROR, NULL);
+    obj->handle = NULL;
+  }
 
   return BZ_SETERR(obj, ret, NULL);
 }
@@ -1034,9 +1036,11 @@ int bzfile_closewrite( obj, abandon ) bzFile* obj; int abandon; {
 
   obj->pending_io_error = False;
 
-  if ( obj->handle )
+  if ( obj->handle ) {
     if ( 0 != PerlIO_close( obj->handle ) )
       ret = BZ_SETERR(obj, BZ_IO_ERROR, NULL);
+    obj->handle = NULL;
+  }
 
   return BZ_SETERR(obj, ret, NULL);
 }
-- 
2.45.4

