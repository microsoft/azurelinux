From da35fa7fbab4d73bef441808aa32cc5c350d071e Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Fri, 7 Nov 2025 08:06:47 +0000
Subject: [PATCH] server: tighten top-level dir perms; add upgrade chmod; note
 state dir perms and userns. runtime/v2: document parent dir perms for
 root/state.

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/containerd/containerd/commit/7c59e8e9e970d38061a77b586b23655c352bfec5.diff
---
 runtime/v2/manager.go     |  2 ++
 services/server/server.go | 20 +++++++++++++++++---
 2 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/runtime/v2/manager.go b/runtime/v2/manager.go
index 73e1af7..5db386b 100644
--- a/runtime/v2/manager.go
+++ b/runtime/v2/manager.go
@@ -133,6 +133,8 @@ type ManagerConfig struct {
 // NewShimManager creates a manager for v2 shims
 func NewShimManager(ctx context.Context, config *ManagerConfig) (*ShimManager, error) {
 	for _, d := range []string{config.Root, config.State} {
+		// root:  the parent of this directory is created as 0o700, not 0o711.
+		// state: the parent of this directory is created as 0o711 too, so as to support userns-remapped containers.
 		if err := os.MkdirAll(d, 0711); err != nil {
 			return nil, err
 		}
diff --git a/services/server/server.go b/services/server/server.go
index 2a548ef..f652d6d 100644
--- a/services/server/server.go
+++ b/services/server/server.go
@@ -1,3 +1,5 @@
+
+
 /*
    Copyright The containerd Authors.
 
@@ -72,16 +74,26 @@ func CreateTopLevelDirectories(config *srvconfig.Config) error {
 		return errors.New("root and state must be different paths")
 	}
 
-	if err := sys.MkdirAllWithACL(config.Root, 0711); err != nil {
+	if err := sys.MkdirAllWithACL(config.Root, 0o700); err != nil {
+		return err
+	}
+	// chmod is needed for upgrading from an older release that created the dir with 0o711
+	if err := os.Chmod(config.Root, 0o700); err != nil {
 		return err
 	}
 
-	if err := sys.MkdirAllWithACL(config.State, 0711); err != nil {
+	// For supporting userns-remapped containers, the state dir cannot be just mkdired with 0o700.
+	// Each of plugins creates a dedicated directory beneath the state dir with appropriate permission bits.
+	if err := sys.MkdirAllWithACL(config.State, 0o711); err != nil {
 		return err
 	}
 
 	if config.TempDir != "" {
-		if err := sys.MkdirAllWithACL(config.TempDir, 0711); err != nil {
+		if err := sys.MkdirAllWithACL(config.TempDir, 0o700); err != nil {
+			return err
+		}
+		// chmod is needed for upgrading from an older release that created the dir with 0o711
+		if err := os.Chmod(config.Root, 0o700); err != nil {
 			return err
 		}
 		if runtime.GOOS == "windows" {
@@ -514,3 +526,5 @@ func trapClosedConnErr(err error) error {
 	}
 	return err
 }
+
+
-- 
2.45.4

