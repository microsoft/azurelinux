From dd00211116f9b7da04772f6404aff5986a2b54e2 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Fri, 6 Feb 2026 05:06:56 +0000
Subject: [PATCH] Backport: Fix buffer overflow in zlib inflate extra header
 copy by bounding len against extra_max (from upstream patch)

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/madler/zlib/commit/eff308af425b67093bab25f80f1ae950166bece1.patch
---
 vendor/libz-sys/src/zlib/inflate.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/vendor/libz-sys/src/zlib/inflate.c b/vendor/libz-sys/src/zlib/inflate.c
index cd01857..d758a1c 100644
--- a/vendor/libz-sys/src/zlib/inflate.c
+++ b/vendor/libz-sys/src/zlib/inflate.c
@@ -758,10 +758,10 @@ int flush;
                 copy = state->length;
                 if (copy > have) copy = have;
                 if (copy) {
+                    len = state->head->extra_len - state->length;
                     if (state->head != Z_NULL &&
                         state->head->extra != Z_NULL &&
-                        (len = state->head->extra_len - state->length) <
-                            state->head->extra_max) {
+                        len < state->head->extra_max) {
                         zmemcpy(state->head->extra + len, next,
                                 len + copy > state->head->extra_max ?
                                 state->head->extra_max - len : copy);
-- 
2.45.4

