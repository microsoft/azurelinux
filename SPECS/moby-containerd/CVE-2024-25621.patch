From 808ae14e2da379e517298396c2242e07d37503ad Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Tue, 11 Nov 2025 11:41:09 +0000
Subject: [PATCH] Fix directory permissions: make root and tempdir 0o700 with
 chmod adjustments; keep state at 0o711 for userns; add comments in v2
 manager;

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/containerd/containerd/commit/0450f046e6942e513d0ebf1ef5c2aff13daa187f.patch
Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: https://raw.githubusercontent.com/microsoft/azurelinux/22d76f85edefac1f144ba78ea3b2e4529a238491/SPECS/moby-containerd/CVE-2024-25621.patch
---
 pkg/cri/cri.go            |  8 ++++++++
 runtime/v2/manager.go     |  2 ++
 services/server/server.go | 14 ++++++++++++--
 3 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/pkg/cri/cri.go b/pkg/cri/cri.go
index 59861ed..dee6988 100644
--- a/pkg/cri/cri.go
+++ b/pkg/cri/cri.go
@@ -19,6 +19,7 @@ package cri
 import (
 	"flag"
 	"fmt"
+	"os"
 	"path/filepath"
 
 	imagespec "github.com/opencontainers/image-spec/specs-go/v1"
@@ -79,6 +80,13 @@ func initCRIService(ic *plugin.InitContext) (interface{}, error) {
 		}
 	}
 
+	if err := os.MkdirAll(ic.State, 0700); err != nil {
+		return nil, err
+	}
+	// chmod is needed for upgrading from an older release that created the dir with 0755
+	if err := os.Chmod(ic.State, 0700); err != nil {
+		return nil, err
+	}
 	c := criconfig.Config{
 		PluginConfig:       *pluginConfig,
 		ContainerdRootDir:  filepath.Dir(ic.Root),
diff --git a/runtime/v2/manager.go b/runtime/v2/manager.go
index 1927cbb..1f26bbe 100644
--- a/runtime/v2/manager.go
+++ b/runtime/v2/manager.go
@@ -109,6 +109,8 @@ type ManagerConfig struct {
 // NewShimManager creates a manager for v2 shims
 func NewShimManager(ctx context.Context, config *ManagerConfig) (*ShimManager, error) {
 	for _, d := range []string{config.Root, config.State} {
+		// root:  the parent of this directory is created as 0700, not 0711.
+		// state: the parent of this directory is created as 0711 too, so as to support userns-remapped containers.
 		if err := os.MkdirAll(d, 0711); err != nil {
 			return nil, err
 		}
diff --git a/services/server/server.go b/services/server/server.go
index c2b504c..e707ae4 100644
--- a/services/server/server.go
+++ b/services/server/server.go
@@ -86,16 +86,26 @@ func CreateTopLevelDirectories(config *srvconfig.Config) error {
 		return errors.New("root and state must be different paths")
 	}
 
-	if err := sys.MkdirAllWithACL(config.Root, 0711); err != nil {
+	if err := sys.MkdirAllWithACL(config.Root, 0700); err != nil {
+		return err
+	}
+	// chmod is needed for upgrading from an older release that created the dir with 0o711
+	if err := os.Chmod(config.Root, 0700); err != nil {
 		return err
 	}
 
+	// For supporting userns-remapped containers, the state dir cannot be just mkdired with 0o700.
+	// Each of plugins creates a dedicated directory beneath the state dir with appropriate permission bits.
 	if err := sys.MkdirAllWithACL(config.State, 0711); err != nil {
 		return err
 	}
 
 	if config.TempDir != "" {
-		if err := sys.MkdirAllWithACL(config.TempDir, 0711); err != nil {
+		if err := sys.MkdirAllWithACL(config.TempDir, 0700); err != nil {
+			return err
+		}
+		// chmod is needed for upgrading from an older release that created the dir with 0o711
+		if err := os.Chmod(config.Root, 0700); err != nil {
 			return err
 		}
 		if runtime.GOOS == "windows" {
-- 
2.45.4

