From aef6802754f93dfd1b5219e9fb268d04b3db9f14 Mon Sep 17 00:00:00 2001
From: AllSpark <allspark@microsoft.com>
Date: Mon, 8 Dec 2025 12:36:49 +0000
Subject: [PATCH] Increase robustness of <img> tag sizes and rich text object
 allocation; cap image dimensions and use QImageIOHandler::allocateImage. Also
 clamp QTextImageFormat width/height rounding to INT bounds. Add logging and
 coord limit.

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: AI Backport of https://github.com/qt/qtdeclarative/commit/4aaf9bf21f7cc69d73066785e254b664fcc82025.patch https://github.com/qt/qtdeclarative/commit/144ce34e846b3f732bdb003f99b1f9455425416f.patch
---
 src/quick/items/qquicktextdocument.cpp   |  4 ++--
 src/quick/items/qquicktextnodeengine.cpp | 12 +++++++-----
 src/quick/util/qquickstyledtext.cpp      | 22 ++++++++++++++++++++--
 3 files changed, 29 insertions(+), 9 deletions(-)

diff --git a/src/quick/items/qquicktextdocument.cpp b/src/quick/items/qquicktextdocument.cpp
index 06ac5804..6610d1a6 100644
--- a/src/quick/items/qquicktextdocument.cpp
+++ b/src/quick/items/qquicktextdocument.cpp
@@ -138,9 +138,9 @@ QSizeF QQuickTextDocumentWithImageResources::intrinsicSize(
     if (format.isImageFormat()) {
         QTextImageFormat imageFormat = format.toImageFormat();
 
-        const int width = qRound(imageFormat.width());
+        const int width = qRound(qBound(qreal(INT_MIN), imageFormat.width(), qreal(INT_MAX)));
         const bool hasWidth = imageFormat.hasProperty(QTextFormat::ImageWidth) && width > 0;
-        const int height = qRound(imageFormat.height());
+        const int height = qRound(qBound(qreal(INT_MIN), imageFormat.height(), qreal(INT_MAX)));
         const bool hasHeight = imageFormat.hasProperty(QTextFormat::ImageHeight) && height > 0;
 
         QSizeF size(width, height);
diff --git a/src/quick/items/qquicktextnodeengine.cpp b/src/quick/items/qquicktextnodeengine.cpp
index 5a4ef2b6..1c6d8fe0 100644
--- a/src/quick/items/qquicktextnodeengine.cpp
+++ b/src/quick/items/qquicktextnodeengine.cpp
@@ -47,6 +47,7 @@
 #include <QtGui/qtextobject.h>
 #include <QtGui/qtexttable.h>
 #include <QtGui/qtextlist.h>
+#include <QtGui/qimageiohandler.h>
 
 #include <private/qquicktext_p.h>
 #include <private/qquicktextdocument_p.h>
@@ -468,11 +469,12 @@ void QQuickTextNodeEngine::addTextObject(const QTextBlock &block, const QPointF
         }
 
         if (image.isNull()) {
-            image = QImage(size.toSize(), QImage::Format_ARGB32_Premultiplied);
-            image.fill(Qt::transparent);
-            {
-                QPainter painter(&image);
-                handler->drawObject(&painter, image.rect(), textDocument, pos, format);
+            if (QImageIOHandler::allocateImage(size.toSize(), QImage::Format_ARGB32_Premultiplied, &image)) {
+                image.fill(Qt::transparent);
+                {
+                    QPainter painter(&image);
+                    handler->drawObject(&painter, image.rect(), textDocument, pos, format);
+                }
             }
         }
 
diff --git a/src/quick/util/qquickstyledtext.cpp b/src/quick/util/qquickstyledtext.cpp
index 5e1aaf12..23b37584 100644
--- a/src/quick/util/qquickstyledtext.cpp
+++ b/src/quick/util/qquickstyledtext.cpp
@@ -46,6 +46,14 @@
 #include "qquickstyledtext_p.h"
 #include <QQmlContext>
 
+#include <QtGui/private/qoutlinemapper_p.h>
+
+#ifndef QQUICKSTYLEDPARSER_COORD_LIMIT
+#  define QQUICKSTYLEDPARSER_COORD_LIMIT QT_RASTER_COORD_LIMIT
+#endif
+
+Q_STATIC_LOGGING_CATEGORY(lcStyledText, "qt.quick.styledtext")
+
 /*
     QQuickStyledText supports few tags:
 
@@ -688,9 +696,19 @@ void QQuickStyledTextPrivate::parseImageAttributes(const QChar *&ch, const QStri
             if (attr.first == QLatin1String("src")) {
                 image->url =  QUrl(attr.second.toString());
             } else if (attr.first == QLatin1String("width")) {
-                image->size.setWidth(attr.second.toString().toInt());
+                bool ok;
+                int v = attr.second.toString().toInt(&ok);
+                if (ok && v <= QQUICKSTYLEDPARSER_COORD_LIMIT)
+                    image->size.setWidth(v);
+                else
+                    qCWarning(lcStyledText) << "Invalid width provided for <img>";
             } else if (attr.first == QLatin1String("height")) {
-                image->size.setHeight(attr.second.toString().toInt());
+                bool ok;
+                int v = attr.second.toString().toInt(&ok);
+                if (ok && v <= QQUICKSTYLEDPARSER_COORD_LIMIT)
+                    image->size.setHeight(v);
+                else
+                    qCWarning(lcStyledText) << "Invalid height provided for <img>";
             } else if (attr.first == QLatin1String("align")) {
                 if (attr.second.toString() == QLatin1String("top")) {
                     image->align = QQuickStyledTextImgTag::Top;
-- 
2.45.4

