From 4f0a5864edceb52060f9beba46c598480591b24c Mon Sep 17 00:00:00 2001
From: Chris PeBenito <chpebeni@linux.microsoft.com>
Date: Mon, 1 Jul 2024 09:27:04 -0400
Subject: [PATCH 33/33] cloud-init and kmod fixes.

---
 policy/modules/system/modutils.fc | 2 ++
 policy/modules/system/modutils.te | 4 ++++
 policy/modules/system/udev.te     | 4 ++++
 3 files changed, 10 insertions(+)

diff --git a/policy/modules/system/modutils.fc b/policy/modules/system/modutils.fc
index 323120062..de9f88fa8 100644
--- a/policy/modules/system/modutils.fc
+++ b/policy/modules/system/modutils.fc
@@ -8,6 +8,8 @@ ifdef(`distro_gentoo',`
 /etc/modprobe\.devfs.*		--	gen_context(system_u:object_r:modules_conf_t,s0)
 ')
 
+/run/modprobe\.d(/.*)?			gen_context(system_u:object_r:modules_conf_t,s0)
+
 ifdef(`init_systemd',`
 /run/tmpfiles\.d/kmod\.conf	--	gen_context(system_u:object_r:kmod_tmpfiles_conf_t,s0)
 /run/tmpfiles\.d/static-nodes\.conf --  gen_context(system_u:object_r:kmod_tmpfiles_conf_t,s0)
diff --git a/policy/modules/system/modutils.te b/policy/modules/system/modutils.te
index 996ecac85..6af867650 100644
--- a/policy/modules/system/modutils.te
+++ b/policy/modules/system/modutils.te
@@ -141,6 +141,10 @@ optional_policy(`
 	apt_use_ptys(kmod_t)
 ')
 
+optional_policy(`
+	cloudinit_append_inherited_tmp_files(kmod_t)
+')
+
 optional_policy(`
 	# for postinst of a new kernel package
 	dpkg_manage_script_tmp_files(kmod_t)
diff --git a/policy/modules/system/udev.te b/policy/modules/system/udev.te
index 8af0d90e0..5d2ff060a 100644
--- a/policy/modules/system/udev.te
+++ b/policy/modules/system/udev.te
@@ -437,6 +437,10 @@ storage_getattr_fixed_disk_dev(udevadm_t)
 
 userdom_use_user_terminals(udevadm_t)
 
+optional_policy(`
+	cloudinit_append_inherited_tmp_files(udevadm_t)
+')
+
 optional_policy(`
 	rpm_read_inherited_tmp_files(udevadm_t)
 	rpm_append_inherited_tmp_files(udevadm_t)
-- 
2.45.2

