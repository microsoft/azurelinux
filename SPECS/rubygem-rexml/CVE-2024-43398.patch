From e5bcd0e09cc9dde045e850c657071974080d11e6 Mon Sep 17 00:00:00 2001
From: akhila-guruju <v-guakhila@microsoft.com>
Date: Wed, 21 May 2025 12:09:38 +0000
Subject: [PATCH] Address CVE-2024-43398

Upstream Patch reference: https://github.com/ruby/rexml/commit/7cb5eaeb221c322b9912f724183294d8ce96bae3

---
 lib/rexml/element.rb            | 11 -----------
 lib/rexml/parsers/baseparser.rb | 15 +++++++++++++++
 test/parse/test_element.rb      | 14 ++++++++++++++
 test/test_core.rb               |  2 +-
 4 files changed, 30 insertions(+), 12 deletions(-)

diff --git a/lib/rexml/element.rb b/lib/rexml/element.rb
index bf913a8..b44f41d 100644
--- a/lib/rexml/element.rb
+++ b/lib/rexml/element.rb
@@ -2388,17 +2388,6 @@ module REXML
       elsif old_attr.kind_of? Hash
         old_attr[value.prefix] = value
       elsif old_attr.prefix != value.prefix
-        # Check for conflicting namespaces
-        if value.prefix != "xmlns" and old_attr.prefix != "xmlns"
-          old_namespace = old_attr.namespace
-          new_namespace = value.namespace
-          if old_namespace == new_namespace
-            raise ParseException.new(
-                    "Namespace conflict in adding attribute \"#{value.name}\": "+
-                    "Prefix \"#{old_attr.prefix}\" = \"#{old_namespace}\" and "+
-                    "prefix \"#{value.prefix}\" = \"#{new_namespace}\"")
-          end
-        end
         store value.name, {old_attr.prefix => old_attr,
                            value.prefix    => value}
       else
diff --git a/lib/rexml/parsers/baseparser.rb b/lib/rexml/parsers/baseparser.rb
index a2818ae..f66e20a 100644
--- a/lib/rexml/parsers/baseparser.rb
+++ b/lib/rexml/parsers/baseparser.rb
@@ -699,6 +699,7 @@ module REXML
 
       def parse_attributes(prefixes, curr_ns)
         attributes = {}
+	expanded_names = {}
         closed = false
         while true
           if @source.match(">", true)
@@ -750,6 +751,20 @@ module REXML
               raise REXML::ParseException.new(msg, @source, self)
             end
 
+            unless prefix == "xmlns"
+              uri = @namespaces[prefix]
+              expanded_name = [uri, local_part]
+              existing_prefix = expanded_names[expanded_name]
+              if existing_prefix
+                message = "Namespace conflict in adding attribute " +
+                          "\"#{local_part}\": " +
+                          "Prefix \"#{existing_prefix}\" = \"#{uri}\" and " +
+                          "prefix \"#{prefix}\" = \"#{uri}\""
+                raise REXML::ParseException.new(message, @source, self)
+              end
+              expanded_names[expanded_name] = prefix
+            end
+
             attributes[name] = value
           else
             message = "Invalid attribute name: <#{@source.buffer.split(%r{[/>\s]}).first}>"
diff --git a/test/parse/test_element.rb b/test/parse/test_element.rb
index 14d0703..f1a4629 100644
--- a/test/parse/test_element.rb
+++ b/test/parse/test_element.rb
@@ -85,6 +85,20 @@ Last 80 unconsumed characters:
 </ </x>
         DETAIL
       end
+
+      def test_linear_performance_deep_same_name_attributes
+        seq = [100, 500, 1000, 1500, 2000]
+        assert_linear_performance(seq, rehearsal: 10) do |n|
+          xml = <<-XML
+<?xml version="1.0"?>
+<root xmlns:ns="ns-uri">
+#{"<x ns:name='ns-value' name='value'>\n" * n}
+#{"</x>\n" * n}
+</root>
+          XML
+          REXML::Document.new(xml)
+        end
+      end
     end
   end
 end
diff --git a/test/test_core.rb b/test/test_core.rb
index 44e2e7e..788bcaa 100644
--- a/test/test_core.rb
+++ b/test/test_core.rb
@@ -117,7 +117,7 @@ module REXMLTests
     def test_attribute_namespace_conflict
       # https://www.w3.org/TR/xml-names/#uniqAttrs
       message = <<-MESSAGE.chomp
-Duplicate attribute "a"
+Namespace conflict in adding attribute "a": Prefix "n1" = "http://www.w3.org" and prefix "n2" = "http://www.w3.org"
 Line: 4
 Position: 140
 Last 80 unconsumed characters:
-- 
2.45.2

