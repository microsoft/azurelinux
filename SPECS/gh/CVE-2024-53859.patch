From 5d6079f8ad16f553cdaea1d56fedcb4a3a1db082 Mon Sep 17 00:00:00 2001
From: William Martin <williammartin@github.com>
Date: Thu, 31 Oct 2024 14:07:48 +0100
Subject: [PATCH] Fix token exposure for non-gh hosts in codespaces

This commit introduces a fix for `GITHUB_TOKEN` being exposed to non-github hosts while in a codespace. We no longer return the `GITHUB_TOKEN` for any host except github.com and github.localhost while in a codespace (while the env var `CODESPACES` is `true`).

This commit also changes how tokens are returned when no oAuth token is found in a config. Previously, an empty string and the `oauthToken` source was returned. Now, we return an empty string and the `defaultSource` source. The intention behind this change is to make more logical sense by not returning an `oauthToken` source when we didn't get any token. It's also worth mentioning that this change also improves our test coverage - all lines in `tokenForHost` are now covered by tests, and we don't have unreachable code.

Co-authored-by: Kynan Ware <47394200+BagToad@users.noreply.github.com>

Modified patch to apply to AzureLinux
Modified-by: Sandeep Karambelkar <skarambelkar@microsoft.com>
---
 pkg/auth/auth.go      | 27 ++++++++----
 1 file changed, 91 insertions(+), 33 deletions(-)

diff --git a/vendor/github.com/cli/go-gh/v2/pkg/auth/auth.go b/vendor/github.com/cli/go-gh/v2/pkg/auth/auth.go
index a903736..4378e75 100644
--- a/vendor/github.com/cli/go-gh/v2/pkg/auth/auth.go
+++ b/vendor/github.com/cli/go-gh/v2/pkg/auth/auth.go
@@ -63,6 +63,15 @@ func TokenFromEnvOrConfig(host string) (string, string) {

 func tokenForHost(cfg *config.Config, host string) (string, string) {
 	host = NormalizeHostname(host)
+
+	if isCodespaces, _ := strconv.ParseBool(os.Getenv(codespaces)); isCodespaces {
+		if host == github || host == localhost {
+			if token := os.Getenv(githubToken); token != "" {
+				return token, githubToken
+			}
+		}
+	}
+
 	if IsEnterprise(host) {
 		if token := os.Getenv(ghEnterpriseToken); token != "" {
 			return token, ghEnterpriseToken
@@ -70,25 +79,25 @@ func tokenForHost(cfg *config.Config, host string) (string, string) {
 		if token := os.Getenv(githubEnterpriseToken); token != "" {
 			return token, githubEnterpriseToken
 		}
-		if isCodespaces, _ := strconv.ParseBool(os.Getenv(codespaces)); isCodespaces {
-			if token := os.Getenv(githubToken); token != "" {
-				return token, githubToken
-			}
-		}
 		if cfg != nil {
-			token, _ := cfg.Get([]string{hostsKey, host, oauthToken})
-			return token, oauthToken
+			if token, _ := cfg.Get([]string{hostsKey, host, oauthToken}); token != "" {
+				return token, oauthToken
+			}
 		}
+		return "", defaultSource
 	}
+
 	if token := os.Getenv(ghToken); token != "" {
 		return token, ghToken
 	}
 	if token := os.Getenv(githubToken); token != "" {
 		return token, githubToken
 	}
+
 	if cfg != nil {
-		token, _ := cfg.Get([]string{hostsKey, host, oauthToken})
-		return token, oauthToken
+		if token, _ := cfg.Get([]string{hostsKey, host, oauthToken}); token != "" {
+			return token, oauthToken
+		}
 	}
 	return "", defaultSource
 }
