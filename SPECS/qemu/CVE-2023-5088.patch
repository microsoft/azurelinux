From ea5d979ba694a0fb613cf6aa0aa1e45f4d9d38fe Mon Sep 17 00:00:00 2001
From: Kevin Lockwood <v-klockwood@microsoft.com>
Date: Thu, 20 Mar 2025 15:23:32 -0700
Subject: [PATCH] [High] patch qemu for CVE-2023-5088

Link: https://lore.kernel.org/all/20230921160712.99521-2-simon.rowe@nutanix.com/raw
---
 hw/ide/core.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/hw/ide/core.c b/hw/ide/core.c
index e28f8aad6..765b9013d 100644
--- a/hw/ide/core.c
+++ b/hw/ide/core.c
@@ -894,8 +894,12 @@ static void ide_dma_cb(void *opaque, int ret)
         s->nsector -= n;
     }
 
-    /* end of transfer ? */
-    if (s->nsector == 0) {
+    /*
+     * End of transfer ?
+     * If a bus reset occurs immediately before the callback is invoked the
+     * bus state will have been cleared. Terminate the transfer.
+     */
+    if (s->nsector == 0 || !(s->status & DRQ_STAT)) {
         s->status = READY_STAT | SEEK_STAT;
         ide_set_irq(s->bus);
         goto eot;
-- 
2.34.1

