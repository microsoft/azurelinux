From 3669f5e40ec1744c8fb233372a07a4ba551313c3 Mon Sep 17 00:00:00 2001
From: Azure Linux Security Servicing Account
 <azurelinux-security@microsoft.com>
Date: Mon, 28 Jul 2025 19:40:37 +0000
Subject: [PATCH] Fix CVE CVE-2025-8224 in binutils

[AI Backported] Upstream Patch Reference: https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;h=db856d41004301b3a56438efd957ef5cabb91530
---
 bfd/elf.c | 14 +++++++++-----
 1 file changed, 9 insertions(+), 5 deletions(-)

diff --git a/bfd/elf.c b/bfd/elf.c
index 4fc0a65e..42972afc 100644
--- a/bfd/elf.c
+++ b/bfd/elf.c
@@ -294,9 +294,7 @@ bfd_elf_get_str_section (bfd *abfd, unsigned int shindex)
       offset = i_shdrp[shindex]->sh_offset;
       shstrtabsize = i_shdrp[shindex]->sh_size;
 
-      /* Allocate and clear an extra byte at the end, to prevent crashes
-	 in case the string table is not terminated.  */
-      if (shstrtabsize + 1 <= 1
+      if (shstrtabsize == 0
 	  || bfd_seek (abfd, offset, SEEK_SET) != 0
 	  || (shstrtab = _bfd_alloc_and_read (abfd, shstrtabsize + 1,
 					      shstrtabsize)) == NULL)
@@ -306,8 +304,14 @@ bfd_elf_get_str_section (bfd *abfd, unsigned int shindex)
 	     the string table over and over.  */
 	  i_shdrp[shindex]->sh_size = 0;
 	}
-      else
-	shstrtab[shstrtabsize] = '\0';
+      else if (shstrtab[shstrtabsize - 1] != 0)
+        {
+          /* It is an error if a string table isn't terminated.  */
+          _bfd_error_handler
+            /* xgettext:c-format */
+            (_("%pB: string table [%u] is corrupt"), abfd, shindex);
+          shstrtab[shstrtabsize - 1] = 0;
+        }
       i_shdrp[shindex]->contents = shstrtab;
     }
   return (char *) shstrtab;
-- 
2.45.2

