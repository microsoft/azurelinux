From d135b40a1bdc1bf883aa91e4eda7c85e6d6350fa Mon Sep 17 00:00:00 2001
From: BinduSri-6522866 <v-badabala@microsoft.com>
Date: Thu, 21 Aug 2025 11:32:29 +0000
Subject: [PATCH] address cve-2025-54409

Upstream Patch Reference: https://git.launchpad.net/ubuntu/+source/aide/patch/?id=e5813a39c157913ac822befd93281a17905e5f9a
---
 src/db.c   | 26 ++++++++++++++++++--------
 src/util.c |  2 +-
 2 files changed, 19 insertions(+), 9 deletions(-)

diff --git a/src/db.c b/src/db.c
index dfcc973..4a16236 100644
--- a/src/db.c
+++ b/src/db.c
@@ -351,17 +351,27 @@ db_line* db_char2line(char** ss, database* db){
           num = 0;
           while (num < line->xattrs->num)
           {
-            byte  *val = NULL;
-            size_t vsz = 0;
-            
             tval = strtok(NULL, ",");
             line->xattrs->ents[num].key = db_readchar(checked_strdup(tval));
             tval = strtok(NULL, ",");
-            val = base64tobyte(tval, strlen(tval), &vsz);
-            line->xattrs->ents[num].val = val;
-            line->xattrs->ents[num].vsz = vsz;
-
-            ++num;
+            if (strcmp(tval,"0") != 0) {
+                line->xattrs->ents[num].val = decode_base64(tval, strlen(tval), &line->xattrs->ents[num].vsz);
+            } else {
+                line->xattrs->ents[num].val = checked_strdup("");
+                line->xattrs->ents[num].vsz = 0;
+            }
+            if (line->xattrs->ents[num].val == NULL) {
+                LOG_DB_FORMAT_LINE(LOG_LEVEL_WARNING, "error while reading xattrs for '%s' from database (discarding extended attributes)", line->filename)
+                for (int j = num; j >= 0 ; --j) {
+                    free(line->xattrs->ents[j].key);
+                    line->xattrs->ents[j].key = NULL;
+                    free(line->xattrs->ents[j].val);
+                    line->xattrs->ents[j].val = NULL;
+                }
+                line->xattrs->num = 0;
+            } else {
+                ++num;
+            }
           }
         }
 #endif
diff --git a/src/util.c b/src/util.c
index b1323b3..32e4805 100644
--- a/src/util.c
+++ b/src/util.c
@@ -45,7 +45,7 @@
 #include "util.h"
 #include "errorcodes.h"
 
-#define URL_UNSAFE " <>\"#%{}|\\^~[]`@:\033'"
+#define URL_UNSAFE " <>\"#%{}|\\^~[]`@:\033',"
 #define ISPRINT(c) (isascii(c) && isprint(c))
 
 const char* btoa(bool b) {
-- 
2.45.4

