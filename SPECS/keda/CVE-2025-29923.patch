From ccc8a29fedd586a983efa3852c35175f042e5f7a Mon Sep 17 00:00:00 2001
From: Kanishk-Bansal <kbkanishk975@gmail.com>
Date: Sun, 30 Mar 2025 16:50:18 +0000
Subject: [PATCH] CVE-2025-29923

Upstream Patch Reference : https://github.com/redis/go-redis/commit/d236865b0cfa1b752ea4b7da666b1fdcd0acebb6
---
 .../github.com/redis/go-redis/v9/options.go   | 11 +++++++-
 .../redis/go-redis/v9/osscluster.go           | 18 ++++++++++--
 vendor/github.com/redis/go-redis/v9/redis.go  |  8 ++++--
 vendor/github.com/redis/go-redis/v9/ring.go   | 19 +++++++++++--
 .../github.com/redis/go-redis/v9/sentinel.go  | 28 ++++++++++++++++---
 .../github.com/redis/go-redis/v9/universal.go | 24 +++++++++++++---
 6 files changed, 92 insertions(+), 16 deletions(-)

diff --git a/vendor/github.com/redis/go-redis/v9/options.go b/vendor/github.com/redis/go-redis/v9/options.go
index dff52ae8..3e889aed 100644
--- a/vendor/github.com/redis/go-redis/v9/options.go
+++ b/vendor/github.com/redis/go-redis/v9/options.go
@@ -142,9 +142,18 @@ type Options struct {
 	// Enables read only queries on slave/follower nodes.
 	readOnly bool
 
-	// Disable set-lib on connect. Default is false.
+	// DisableIndentity - Disable set-lib on connect.
+ 	//
+ 	// default: false
+ 	//
+ 	// Deprecated: Use DisableIdentity instead.
 	DisableIndentity bool
 
+	// DisableIdentity is used to disable CLIENT SETINFO command on connect.
+ 	//
+ 	// default: false
+ 	DisableIdentity bool
+
 	// Add suffix to client name. Default is empty.
 	IdentitySuffix string
 }
diff --git a/vendor/github.com/redis/go-redis/v9/osscluster.go b/vendor/github.com/redis/go-redis/v9/osscluster.go
index 17f98d9d..c67244c8 100644
--- a/vendor/github.com/redis/go-redis/v9/osscluster.go
+++ b/vendor/github.com/redis/go-redis/v9/osscluster.go
@@ -85,8 +85,19 @@ type ClusterOptions struct {
 	ConnMaxIdleTime time.Duration
 	ConnMaxLifetime time.Duration
 
-	TLSConfig        *tls.Config
-	DisableIndentity bool // Disable set-lib on connect. Default is false.
+	TLSConfig *tls.Config
+ 
+ 	// DisableIndentity - Disable set-lib on connect.
+ 	//
+ 	// default: false
+ 	//
+ 	// Deprecated: Use DisableIdentity instead.
+ 	DisableIndentity bool
+ 
+ 	// DisableIdentity is used to disable CLIENT SETINFO command on connect.
+ 	//
+ 	// default: false
+ 	DisableIdentity bool
 
 	IdentitySuffix string // Add suffix to client name. Default is empty.
 }
@@ -294,7 +305,8 @@ func (opt *ClusterOptions) clientOptions() *Options {
 		MaxActiveConns:   opt.MaxActiveConns,
 		ConnMaxIdleTime:  opt.ConnMaxIdleTime,
 		ConnMaxLifetime:  opt.ConnMaxLifetime,
-		DisableIndentity: opt.DisableIndentity,
+		DisableIdentity:  opt.DisableIdentity,
+ 		DisableIndentity: opt.DisableIdentity,
 		IdentitySuffix:   opt.IdentitySuffix,
 		TLSConfig:        opt.TLSConfig,
 		// If ClusterSlots is populated, then we probably have an artificial
diff --git a/vendor/github.com/redis/go-redis/v9/redis.go b/vendor/github.com/redis/go-redis/v9/redis.go
index d25a0d31..46b955bb 100644
--- a/vendor/github.com/redis/go-redis/v9/redis.go
+++ b/vendor/github.com/redis/go-redis/v9/redis.go
@@ -340,7 +340,7 @@ func (c *baseClient) initConn(ctx context.Context, cn *pool.Conn) error {
 		return err
 	}
 
-	if !c.opt.DisableIndentity {
+	if !c.opt.DisableIdentity && !c.opt.DisableIndentity {
 		libName := ""
 		libVer := Version()
 		if c.opt.IdentitySuffix != "" {
@@ -349,7 +349,11 @@ func (c *baseClient) initConn(ctx context.Context, cn *pool.Conn) error {
 		p := conn.Pipeline()
 		p.ClientSetInfo(ctx, WithLibraryName(libName))
 		p.ClientSetInfo(ctx, WithLibraryVersion(libVer))
-		_, _ = p.Exec(ctx)
+		// Handle network errors (e.g. timeouts) in CLIENT SETINFO to avoid
+ 		// out of order responses later on.
+ 		if _, err = p.Exec(ctx); err != nil && !isRedisError(err) {
+			return err
+		}
 	}
 
 	if c.opt.OnConnect != nil {
diff --git a/vendor/github.com/redis/go-redis/v9/ring.go b/vendor/github.com/redis/go-redis/v9/ring.go
index 4ae00542..a8a00cd0 100644
--- a/vendor/github.com/redis/go-redis/v9/ring.go
+++ b/vendor/github.com/redis/go-redis/v9/ring.go
@@ -98,8 +98,20 @@ type RingOptions struct {
 	TLSConfig *tls.Config
 	Limiter   Limiter
 
+	// DisableIndentity - Disable set-lib on connect.
+ 	//
+ 	// default: false
+ 	//
+ 	// Deprecated: Use DisableIdentity instead.
+
 	DisableIndentity bool
-	IdentitySuffix   string
+
+ 	// DisableIdentity is used to disable CLIENT SETINFO command on connect.
+ 	//
+ 	// default: false
+ 	DisableIdentity bool
+ 	IdentitySuffix  string
+ 	UnstableResp3   bool
 }
 
 func (opt *RingOptions) init() {
@@ -166,8 +178,11 @@ func (opt *RingOptions) clientOptions() *Options {
 		TLSConfig: opt.TLSConfig,
 		Limiter:   opt.Limiter,
 
+		DisableIdentity:  opt.DisableIdentity,
+
 		DisableIndentity: opt.DisableIndentity,
-		IdentitySuffix:   opt.IdentitySuffix,
+		IdentitySuffix: opt.IdentitySuffix,
+ 		UnstableResp3:  opt.UnstableResp3,
 	}
 }
 
diff --git a/vendor/github.com/redis/go-redis/v9/sentinel.go b/vendor/github.com/redis/go-redis/v9/sentinel.go
index 188f8849..2988e300 100644
--- a/vendor/github.com/redis/go-redis/v9/sentinel.go
+++ b/vendor/github.com/redis/go-redis/v9/sentinel.go
@@ -80,8 +80,20 @@ type FailoverOptions struct {
 
 	TLSConfig *tls.Config
 
+	// DisableIndentity - Disable set-lib on connect.
+ 	//
+ 	// default: false
+ 	//
+ 	// Deprecated: Use DisableIdentity instead.
 	DisableIndentity bool
-	IdentitySuffix   string
+
+ 	// DisableIdentity is used to disable CLIENT SETINFO command on connect.
+ 	//
+ 	// default: false
+ 	DisableIdentity bool
+ 
+ 	IdentitySuffix string
+ 	UnstableResp3  bool
 }
 
 func (opt *FailoverOptions) clientOptions() *Options {
@@ -117,8 +129,12 @@ func (opt *FailoverOptions) clientOptions() *Options {
 
 		TLSConfig: opt.TLSConfig,
 
+		DisableIdentity:  opt.DisableIdentity,
+
 		DisableIndentity: opt.DisableIndentity,
-		IdentitySuffix:   opt.IdentitySuffix,
+
+		IdentitySuffix: opt.IdentitySuffix,
+		UnstableResp3:  opt.UnstableResp3,
 	}
 }
 
@@ -153,9 +169,11 @@ func (opt *FailoverOptions) sentinelOptions(addr string) *Options {
 		ConnMaxLifetime: opt.ConnMaxLifetime,
 
 		TLSConfig: opt.TLSConfig,
+		DisableIdentity:  opt.DisableIdentity,
 
 		DisableIndentity: opt.DisableIndentity,
-		IdentitySuffix:   opt.IdentitySuffix,
+		IdentitySuffix: opt.IdentitySuffix,
+ 		UnstableResp3:  opt.UnstableResp3,
 	}
 }
 
@@ -194,8 +212,10 @@ func (opt *FailoverOptions) clusterOptions() *ClusterOptions {
 
 		TLSConfig: opt.TLSConfig,
 
+		DisableIdentity:  opt.DisableIdentity,
+
 		DisableIndentity: opt.DisableIndentity,
-		IdentitySuffix:   opt.IdentitySuffix,
+		IdentitySuffix: opt.IdentitySuffix,
 	}
 }
 
diff --git a/vendor/github.com/redis/go-redis/v9/universal.go b/vendor/github.com/redis/go-redis/v9/universal.go
index 275bef3d..1ec64269 100644
--- a/vendor/github.com/redis/go-redis/v9/universal.go
+++ b/vendor/github.com/redis/go-redis/v9/universal.go
@@ -61,14 +61,25 @@ type UniversalOptions struct {
 	RouteByLatency bool
 	RouteRandomly  bool
 
-	// The sentinel master name.
-	// Only failover clients.
+	// MasterName is the sentinel master name.
+ 	// Only for failover clients.
 
 	MasterName string
 
+	// DisableIndentity - Disable set-lib on connect.
+ 	//
+ 	// default: false
+ 	//
+ 	// Deprecated: Use DisableIdentity instead.
 	DisableIndentity bool
-	IdentitySuffix   string
-}
+
+	// DisableIdentity is used to disable CLIENT SETINFO command on connect.
+ 	//
+ 	// default: false
+ 	DisableIdentity bool
+ 
+ 	IdentitySuffix string
+ 	UnstableResp3  bool}
 
 // Cluster returns cluster options created from the universal options.
 func (o *UniversalOptions) Cluster() *ClusterOptions {
@@ -112,6 +123,7 @@ func (o *UniversalOptions) Cluster() *ClusterOptions {
 
 		TLSConfig: o.TLSConfig,
 
+		DisableIdentity:  o.DisableIdentity,
 		DisableIndentity: o.DisableIndentity,
 		IdentitySuffix:   o.IdentitySuffix,
 	}
@@ -158,6 +170,9 @@ func (o *UniversalOptions) Failover() *FailoverOptions {
 
 		TLSConfig: o.TLSConfig,
 
+		ReplicaOnly: o.ReadOnly,
+ 
+ 		DisableIdentity:  o.DisableIdentity,
 		DisableIndentity: o.DisableIndentity,
 		IdentitySuffix:   o.IdentitySuffix,
 	}
@@ -201,6 +216,7 @@ func (o *UniversalOptions) Simple() *Options {
 
 		TLSConfig: o.TLSConfig,
 
+		DisableIdentity:  o.DisableIdentity,
 		DisableIndentity: o.DisableIndentity,
 		IdentitySuffix:   o.IdentitySuffix,
 	}
-- 
2.45.2

