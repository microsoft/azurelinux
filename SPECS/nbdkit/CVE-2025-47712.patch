From 7718fa6355d6f395d0822e824c943f74750500b4 Mon Sep 17 00:00:00 2001
From: AkarshHCL <v-akarshc@microsoft.com>
Date: Tue, 17 Jun 2025 05:45:34 +0000
Subject: [PATCH] Address  CVE-2025-47712

Upstream Patch reference: https://gitlab.com/nbdkit/nbdkit/-/commit/a486f88d1eea653ea88b0bf8804c4825dab25ec7

---
 filters/blocksize/blocksize.c | 5 +++--
 tests/Makefile.am             | 2 ++
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/filters/blocksize/blocksize.c b/filters/blocksize/blocksize.c
index 09195ce..e5c8b74 100644
--- a/filters/blocksize/blocksize.c
+++ b/filters/blocksize/blocksize.c
@@ -482,8 +482,9 @@ blocksize_extents (nbdkit_next *next,
     return -1;
   }
 
-  if (nbdkit_extents_aligned (next, MIN (ROUND_UP (count, h->minblock),
-                                         h->maxlen),
+  if (nbdkit_extents_aligned (next,
+                              MIN (ROUND_UP ((uint64_t) count, h->minblock),
+                                   h->maxlen),
                               ROUND_DOWN (offset, h->minblock), flags,
                               h->minblock, extents2, err) == -1)
     return -1;
diff --git a/tests/Makefile.am b/tests/Makefile.am
index 9233c37..429ba11 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -1481,12 +1481,14 @@ test_layers_filter3_la_LIBADD = $(IMPORT_LIBRARY_ON_WINDOWS)
 TESTS += \
 	test-blocksize.sh \
 	test-blocksize-extents.sh \
+	test-blocksize-extents-overflow.sh \
 	test-blocksize-default.sh \
 	test-blocksize-sharding.sh \
 	$(NULL)
 EXTRA_DIST += \
 	test-blocksize.sh \
 	test-blocksize-extents.sh \
+	test-blocksize-extents-overflow.sh \
 	test-blocksize-default.sh \
 	test-blocksize-sharding.sh \
 	$(NULL)
-- 
2.45.2

