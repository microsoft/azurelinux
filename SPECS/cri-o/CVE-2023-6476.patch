From 5faee5d82556a6bf4dd1144d2a86e70d097ab200 Mon Sep 17 00:00:00 2001
From: Peter Hunt <pehunt@redhat.com>
Date: Thu, 7 Dec 2023 16:07:12 -0500
Subject: [PATCH] allowed annotations: correctly filter prefixed annotations

without this fix, a pod is able to gain access to experimental annotations that are prefixes of container names.
The most problematic of these is io.kubernetes.cri-o.UnifiedCgroup, which allows a user to arbitrarily
change the resources of the pod, potentially leading to OOM.

Fixes CVE-2023-6476

Signed-off-by: Peter Hunt <pehunt@redhat.com>
---
 internal/oci/oci.go | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/internal/oci/oci.go b/internal/oci/oci.go
index 89ecfb2..b56b6d9 100644
--- a/internal/oci/oci.go
+++ b/internal/oci/oci.go
@@ -216,7 +216,7 @@ func (r *Runtime) FilterDisallowedAnnotations(handler string, annotations map[st
 	for ann := range annotations {
 		for _, disallowed := range rh.DisallowedAnnotations {
 			if strings.HasPrefix(ann, disallowed) {
-				delete(annotations, disallowed)
+				delete(annotations, ann)
 			}
 		}
 	}
-- 
2.25.1

