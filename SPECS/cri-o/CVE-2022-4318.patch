From 41dca27cb53bca3c9255287f53e241b9d3bfd7de Mon Sep 17 00:00:00 2001
From: Peter Hunt~ <pehunt@redhat.com>
Date: Wed, 14 Dec 2022 18:15:50 -0500
Subject: [PATCH] server: fail if HOME variable has a newline

to prevent CVE-2022-4318

Signed-off-by: Peter Hunt~ <pehunt@redhat.com>
---
 server/container_create.go | 3 +++
 test/ctr.bats              | 8 ++++++++
 2 files changed, 11 insertions(+)

diff --git a/server/container_create.go b/server/container_create.go
index fb835b0..d07e2f1 100644
--- a/server/container_create.go
+++ b/server/container_create.go
@@ -196,6 +196,9 @@ func setupContainerUser(ctx context.Context, specgen *generate.Generator, rootfs
 	for _, env := range specgen.Config.Process.Env {
 		if strings.HasPrefix(env, "HOME=") {
 			homedir = strings.TrimPrefix(env, "HOME=")
+			if idx := strings.Index(homedir, `\n`); idx > -1 {
+				return fmt.Errorf("invalid HOME environment; newline not allowed")
+			}
 			break
 		}
 	}
diff --git a/test/ctr.bats b/test/ctr.bats
index 67f941f..9c48149 100644
--- a/test/ctr.bats
+++ b/test/ctr.bats
@@ -938,3 +938,11 @@ function check_oci_annotation() {
 	pod_id=$(crictl runp "$TESTDATA"/sandbox_config.json)
 	! crictl create "$pod_id" "$TESTDIR/config" "$TESTDATA"/sandbox_config.json
 }
+
+@test "ctr HOME env newline invalid" {
+	start_crio
+	jq ' .envs = [{"key": "HOME=", "value": "/root:/sbin/nologin\\ntest::0:0::/:/bin/bash"}]' \
+		"$TESTDATA"/container_config.json > "$newconfig"
+
+	! crictl run "$newconfig" "$TESTDATA"/sandbox_config.json
+}
-- 
2.25.1

