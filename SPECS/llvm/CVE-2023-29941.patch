From 9a29d87538842a29b430c6956a4f914896643691 Mon Sep 17 00:00:00 2001
From: Kohei Yamaguchi <fix7211@gmail.com>
Date: Mon, 27 Feb 2023 16:36:16 +0100
Subject: [PATCH] [mlir][sparse] Add checking parent op of SortOp

Fix crash with segmentation fault caused by setting a parent operator
that is not func::FuncOp with sparse_tensor SortOp.

fixes https://github.com/llvm/llvm-project/issues/59988

Reviewed By: aartbik, wrengr

Differential Revision: https://reviews.llvm.org/D143874
---
 .../Dialect/SparseTensor/Transforms/SparseBufferRewriting.cpp  | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/mlir/lib/Dialect/SparseTensor/Transforms/SparseBufferRewriting.cpp b/mlir/lib/Dialect/SparseTensor/Transforms/SparseBufferRewriting.cpp
index 3e6157001266f..107d9ef7569b0 100644
--- a/mlir/lib/Dialect/SparseTensor/Transforms/SparseBufferRewriting.cpp
+++ b/mlir/lib/Dialect/SparseTensor/Transforms/SparseBufferRewriting.cpp
@@ -1160,6 +1160,9 @@ LogicalResult matchAndRewriteSortOp(OpTy op, ValueRange xys, uint64_t nx,
   }
 
   auto insertPoint = op->template getParentOfType<func::FuncOp>();
+  if (!insertPoint)
+    return failure();
+
   SmallString<32> funcName;
   FuncGeneratorType funcGenerator;
   uint32_t nTrailingP = 0;
