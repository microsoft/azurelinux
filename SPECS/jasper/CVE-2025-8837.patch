From 3e063893dc0bc44d22f1eabbf10dc7f06ee95aca Mon Sep 17 00:00:00 2001
From: Michael Adams <mdadams@ece.uvic.ca>
Date: Tue, 5 Aug 2025 20:46:48 -0700
Subject: [PATCH] Fixes #402, #403.

JPEG-2000 (JPC) Decoder:
- Added the setting of several pointers to null in some cleanup code
  after the pointed-to memory was freed.  This pointer nulling is not
  needed normally, but it is needed when certain debugging logs are
  enabled (so that the debug code understands that the memory associated
  with the aforementioned pointers has been freed).

Signed-off-by: Azure Linux Security Servicing Account <azurelinux-security@microsoft.com>
Upstream-reference: https://github.com/jasper-software/jasper/commit/8308060d3fbc1da10353ac8a95c8ea60eba9c25a.patch
---
 data/test/bad/poc_402.jpc   | Bin 0 -> 296 bytes
 data/test/bad/poc_403.jpc   | Bin 0 -> 296 bytes
 src/libjasper/jpc/jpc_dec.c |  13 ++++++++-----
 3 files changed, 8 insertions(+), 5 deletions(-)
 create mode 100644 data/test/bad/poc_402.jpc
 create mode 100644 data/test/bad/poc_403.jpc

diff --git a/data/test/bad/poc_402.jpc b/data/test/bad/poc_402.jpc
new file mode 100644
index 0000000000000000000000000000000000000000..3bd2e30735379b57677eb3e4aeb55737793cfdbd
GIT binary patch
literal 296
zcmezG|38pHp8*88fLIdDf)F4+2txoPJ0leRPhj8yiLw6w_lAM-e+&b!gM)`h00jL{
zXHbRe08yxBFeA(e0-M3ez|6wJz<_Q>3eXHj=c3falGGH1q)LT1|C!**_&hw^p;pBK
zl_i0d6@r!d7o@)P3P^ERC`&CW&dkqKFw!&8Gx$FN>I*fXV<+E-IS!~e&nv(cs<;PP
YF%ts=;~kLV<5#$357sl!NKo1Z0N)Bg!vFvP

literal 0
HcmV?d00001

diff --git a/data/test/bad/poc_403.jpc b/data/test/bad/poc_403.jpc
new file mode 100644
index 0000000000000000000000000000000000000000..3df08489529b5da27a46071da150e21cacb5d067
GIT binary patch
literal 296
zcmezG|38pHp8*8CfLIdDf)HFl3WOnmk)08W{wFZ-fW%n;|9iv0_&<h$*TKQVBLIT_
zr!%NRb$}>TGnf%(1cA+9WMF1t!89WUXa=KmQEFmIYKlTqrNW#4Oh9D}V5|5%JlvsH
z#Q~Kift3}4mH8K>zVix5aaSlyEh^5;&r>kcGto2nKLP3sHK0Y4@53AiRGjA(;0jgT
agRGc|fr0T3Nb&J2T(Sr2nP(&@?E(NM{Xql(

literal 0
HcmV?d00001

diff --git a/src/libjasper/jpc/jpc_dec.c b/src/libjasper/jpc/jpc_dec.c
index 2553696..c2600c4 100644
--- a/src/libjasper/jpc/jpc_dec.c
+++ b/src/libjasper/jpc/jpc_dec.c
@@ -1107,23 +1107,23 @@ static int jpc_dec_tilefini(jpc_dec_t *dec, jpc_dec_tile_t *tile)
 
 	if (tile->cp) {
 		jpc_dec_cp_destroy(tile->cp);
-		//tile->cp = 0;
+		tile->cp = 0;
 	}
 	if (tile->tcomps) {
 		jas_free(tile->tcomps);
-		//tile->tcomps = 0;
+		tile->tcomps = 0;
 	}
 	if (tile->pi) {
 		jpc_pi_destroy(tile->pi);
-		//tile->pi = 0;
+		tile->pi = 0;
 	}
 	if (tile->pkthdrstream) {
 		jas_stream_close(tile->pkthdrstream);
-		//tile->pkthdrstream = 0;
+		tile->pkthdrstream = 0;
 	}
 	if (tile->pptstab) {
 		jpc_ppxstab_destroy(tile->pptstab);
-		//tile->pptstab = 0;
+		tile->pptstab = 0;
 	}
 
 	tile->state = JPC_TILE_DONE;
@@ -2259,6 +2259,9 @@ static int jpc_dec_dump(const jpc_dec_t *dec, FILE *out)
 	const jpc_dec_tile_t *tile;
 	for (tileno = 0, tile = dec->tiles; tileno < dec->numtiles;
 	  ++tileno, ++tile) {
+		if (!tile->tcomps) {
+			continue;
+		}
 		assert(!dec->numcomps || tile->tcomps);
 		unsigned compno;
 		const jpc_dec_tcomp_t *tcomp;
-- 
2.45.4

