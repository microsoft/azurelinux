Date: Thu, 14 Dec 2023 19:04:19 -0800
Subject: [PATCH] Fixes #367.

Fixed an integer-overflow bug in the ICC profile parsing code.
Added another invalid image to the test set.
---
 src/libjasper/base/jas_icc.c |  10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/src/libjasper/base/jas_icc.c b/src/libjasper/base/jas_icc.c
index 0a34587..2b26b5d 100644
--- a/src/libjasper/base/jas_icc.c
+++ b/src/libjasper/base/jas_icc.c
@@ -1293,10 +1293,20 @@ static int jas_icctxt_input(jas_iccattrval_t *attrval, jas_stream_t *in,
 {
 	jas_icctxt_t *txt = &attrval->data.txt;
 	txt->string = 0;
+	/* The string must at least contain a single null character. */
+	if (cnt < 1) {
+		goto error;
+	}
 	if (!(txt->string = jas_malloc(cnt)))
 		goto error;
 	if (jas_stream_read(in, txt->string, cnt) != cnt)
 		goto error;
+	/* Ensure that the string is null terminated. */
+	if (txt->string[cnt - 1] != '\0') {
+		goto error;
+	}
+	/* The following line is redundant, unless we do not enforce that
+	  the last character must be null. */
 	txt->string[cnt - 1] = '\0';
 	if (strlen(txt->string) + 1 != cnt)
 		goto error;
-- 
2.25.1

