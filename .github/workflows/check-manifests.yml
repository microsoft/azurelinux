# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

name: Check Manifests

on:
  push:
    branches: [main, dev, 1.0*, 2.0*, 3.0*, fasttrack/*]
  pull_request:
    branches: [main, dev, 1.0*, 2.0*, 3.0*, fasttrack/*]

jobs:
  build:
    name: Check Manifests
    runs-on: ubuntu-latest
    container:
      # Use a base Azure Linux 3.0 container.
      image: mcr.microsoft.com/azurelinux/base/core:3.0
      env:
        # Reference: https://github.com/Azure/azure-cli/issues/29835
        GNUPGHOME: /root/.gnupg
    defaults:
      run:
        shell: bash

    steps:
    - name: Install prerequisites
      run: |
        tdnf install -y ca-certificates createrepo_c dnf dnf-plugins-core git jq make rpm rpm-build sudo tar wget

    - name: Check out code
      uses: actions/checkout@v4

    - name: Check x86_64 manifests
      run: |
        set -x
        echo ##########
        echo "Ensure toolchain and pkggen manifests (./toolkit/resources/manifests/package/*) match the versions in the .spec files"
        echo "Run './scripts/toolchain/check_manifests.sh -a "x86_64"' and './scripts/check_tools_metapackages.sh -a "x86_64"' to validate locally"
        echo ##########
        pushd toolkit
        ./scripts/toolchain/check_manifests.sh -a "x86_64"
        ./scripts/toolchain/check_tools_metapackages.sh -v -a "x86_64"
        popd

    - name: Check aarch64 manifests
      run: |
        set -x
        echo ##########
        echo "Ensure toolchain and pkggen manifests (./toolkit/resources/manifests/package/*) match the versions in the .spec files"
        echo "Run './scripts/toolchain/check_manifests.sh -a "aarch64"' and './scripts/check_tools_metapackages.sh -a "aarch64"' to validate locally"
        echo ##########
        pushd toolkit
        ./scripts/toolchain/check_manifests.sh -a "aarch64"
        ./scripts/toolchain/check_tools_metapackages.sh -a "aarch64"
        popd
      if: always()
