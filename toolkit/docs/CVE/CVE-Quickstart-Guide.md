# **Document: Fixing CVE Patches for Azure Linux**

This document provides a step-by-step guide to fixing CVE patches for Azure Linux. It includes identifying the CVE, locating and preparing the package, applying the patch, and submitting it for integration into Azure Linux.

---

## **Steps to Fix a CVE Patch**

### **1. Identify the CVE**

1. Navigate to the [Astrolabe Dashboard](https://brave-ocean-0baeae310.5.azurestaticapps.net/#/) to pick a CVE.
2. Determine the Azure Linux branch for the CVE:
   - **3.0** → Use the `fasttrack/3.0` branch.
   - **2.0** → Use the `fasttrack/2.0` branch.
   - Only Critical, High, Medium CVEs are fixed on fasttrack branches, otherwise fixed in 2.0, 3.0 branches only.


---

### **2. Locate the Package**

1. Clone the **azlinux repository** and switch to the appropriate branch:
   ```bash
   git checkout <branch>
   ```
2. Go to the `SPECS` directory and search for the package:
   ```bash
   cd ~/azurelinux/SPECS/<pkg-name>
   ```

---

### **3. Retrieve and Prepare the Source**

1. Locate the source URL in the `<pkg>.spec` file:
   ```bash
   less ~/azurelinux/SPECS/<pkg>/<pkg>.spec
   ```
2. Download the source tarball outside Azlinux repo:
   ```bash
   wget https://azurelinuxsrcstorage.blob.core.windows.net/sources/core/<pkg-source>
   ```
   ```bash
   sh ~/azurelinux/toolkit/scripts/download_spec_sources.sh ~/azurelinux/cgmanifest.json  <pkg-name>
   ```
3. Extract the tarball:
   ```bash
   tar -xf <pkg-source>.tar.gz
   cd <pkg-name>
   ```
4. Initialize a Git repository:
   ```bash
   git init
   git add .
   git commit -m "Initial Commit"
   ```

---

### **4. Apply Existing Patches**

1. Identify existing patches in the `<pkg>.spec` file (e.g., `Patch0`, `Patch1`).
2. Apply patches sequentially starting from `Patch0`:
   ```bash
   patch -p1 --fuzz=0 < ~/azurelinux/SPECS/<pkg>/CVE-xxxx-yyyy.patch
   ```
3. Commit the changes:
   ```bash
   git add -u
   git commit -m "In pace with AzLinux"
   ```

---

### **5. Apply the New CVE Patch**

1. Obtain the CVE patch:
   - Search on NIST ([NVD](https://nvd.nist.gov/vuln/detail/CVE-xxxx-yyyy)) or GitHub for the patch.
   - Download and rename it:
     ```bash
     wget https://github.com/<commit-id>.patch
     mv <patch-name>.patch CVE-xxxx-yyyy.patch
     ```
2. Apply the patch:
   ```bash
   patch -p1 --fuzz=0 < CVE-xxxx-yyyy.patch
   ```
3. Verify and commit:
   ```bash
   git diff
   git add -u
   ```
   - Include the Upstream Patch Reference in the newly generated patch file after the subject:
   ```bash
   git commit -m "Patch CVE-xxxx-yyyy" -m  "Upstream Patch Reference: <link>"
   ```
4. Create a new patch file:
   ```bash
   git log --oneline
   git format-patch -1 HEAD
   mv <patch-name>.patch CVE-xxxx-yyyy.patch
   ```
---

### **6. Update the Repository**

1. Create a new branch for your azlinux repository:
   ```bash
   git checkout -b <alias/pkg-name/CVE-xxxx-yyyy/branch>
   ```
2. Copy the newly created patch to the `SPECS` directory.
3. Update the `<pkg>.spec` file:
   - Increment the release number manually or use
      ```bash
      sh ~/azurelinux/toolkit/scripts/update_spec.sh 'Patch CVE-xxxx-yyyy' ~/azurelinux/SPECS/<pkg>/<pkg.spec>
      ```
   - Add the patch under `PatchX`.
   - Verify the `prep` section to ensure the patch is applied using the existing commands, and update if necessary.
   - Update the changelog:
     ```plaintext
     * <Day> <Month> <Date> <Year> User-Name <alias@microsoft.com> -<pkg-version>-<release>
     - Fix CVE-xxxx-yyyy with an upstream patch
     ```
     or use

     ```bash
      sh ~/azurelinux/toolkit/scripts/update_spec.sh 'Patch CVE-xxxx-yyyy' ~/azurelinux/SPECS/<pkg>/<pkg.spec>
      ```
   - Update the toolchain manifest
      ```bash
      python3 ~/azurelinux/toolkit/scripts/update_toolchain_manifest.py --manifest_dir ~/azurelinux/toolkit/resources/manifests/package/ --specs ~/azurelinux/SPECS/<pkg>/<pkg.spec>
      ```
4. Commit and push changes:
   ```bash
   git add -u
   git commit -s -m "Address CVE-xxxx-yyyy"
   git push --set-upstream origin <alias/pkg-name/CVE-xxxx-yyyy/branch>
   ```

---

### **7. Test the Fix Locally**

- **Build for 2.0**:
  ```bash
  git checkout 2.0-stable -- resources/
  sudo make build-packages REBUILD_TOOLS=y SOURCE_URL="https://azurelinuxsrcstorage.blob.core.windows.net/sources/core"  PACKAGE_BUILD_LIST="<pkg-name>" PACKAGE_REBUILD_LIST="<pkg-name>" SRPM_PACK_LIST="<pkg-name>" RUN_CHECK=y SRPM_FILE_SIGNATURE_HANDLING=update
  ```
- **Build for 3.0**:
  ```bash
  cd ~/azurelinux/toolkit
  ./pkgbld.sh -c -p "<package-name>"
  ```

---

### **8. Create and Submit a PR**

1. Create a PR in the [Azure Linux GitHub repository](https://github.com/microsoft/azurelinux):
   - Title: `Patch <pkg-name> for CVE-xxxx-yyyy [Severity]`.
   - Include CVE details and NIST link in the description.
2. Set the base branch:
   - `fasttrack/3.0` for 3.0.
   - `fasttrack/2.0` for 2.0.
3. It's a good practice to apply the `security` label on CVE PRs as it can aid in generating the `Changelog` automatically by leveraging tools like [github-changelog-generator](https://github.com/github-changelog-generator/github-changelog-generator).
4. Please avoid combining multiple packages affected by a single CVE into one PR. However, you can combine multiple CVEs affecting a single package into one PR.
---

### **9. Perform Buddy Build**

1. Navigate to [ADO Buddy Build](https://dev.azure.com/mariner-org/mariner/_build?definitionId=2190&_a=summary).
2. Run a new pipeline:
   - Use `PR-<GitHub-PR-number>` as the spec.
   - Add `<pkg-name>` for the build.
3. Paste the Buddy Build link in the PR.

---

### **10. Complete the Process**

- Ensure the PR is reviewed, approved, and merged.
- Monitor for additional verification or testing needs.

---

This process ensures that CVE patches are correctly applied, tested, and integrated into Azure Linux while adhering to best practices and guidelines.

---

### **Additional Resources :**

- [CVEs Wiki](https://dev.azure.com/mariner-org/mariner/_wiki/wikis/mariner.wiki/233/CVEs)
- [Code Ownership](https://dev.azure.com/mariner-org/mariner/_wiki/wikis/mariner.wiki/4796/Code-Ownership)
