# This file was automatically generated by merge_yaml.py
# Sources: base=templates/osguard-base.yaml delta=templates/osguard-no-ci-delta.yaml

storage:
  bootType: efi
  disks:
  - partitionTableType: gpt
    maxSize: 40G
    partitions:
    - id: esp
      type: esp
      label: esp
      size: 512M
    - id: boot-a
      type: linux-generic
      label: boot-a
      size: 100M
    - id: usr-a
      type: linux-generic
      size: 1G
    - id: usr-hash-a
      type: usr-verity
      size: 128M
    - id: root-a
      type: root
      label: root-a
      size: 12G
  verity:
  - id: usrverity
    name: usr
    dataDeviceId: usr-a
    hashDeviceId: usr-hash-a
    dataDeviceMountIdType: uuid
    hashDeviceMountIdType: uuid
    hashSignaturePath: /boot/usr.hash.sig
  filesystems:
  - deviceId: esp
    type: fat32
    mountPoint:
      idType: part-label
      path: /boot/efi
      options: nodev,noexec,umask=0077
  - deviceId: boot-a
    type: ext4
    mountPoint:
      idType: uuid
      path: /boot
      options: nodev,noexec,nosuid
  - deviceId: usrverity
    type: ext4
    mountPoint:
      path: /usr
      options: nodev,ro
  - deviceId: root-a
    type: ext4
    mountPoint:
      path: /
      options: nodev,nosuid,x-systemd.growfs,x-initrd.mount
os:
  bootloader:
    resetType: hard-reset
  hostname: azure-linux-os-guard
  selinux:
    mode: permissive
  uki:
    kernels: auto
  kernelCommandLine:
    extraCommandLine:
    - console=tty0
    - console=tty1
    - console=ttyS0
    - rd.luks=0
    - rd.hostonly=0
    - fips=1
    - net.ifnames=1
    - ipe.enforce=0
  packages:
    remove:
    - dracut-hostonly
    - grub2-efi-binary
    - kernel
    install:
    - syslog
    - WALinuxAgent
    - device-mapper
    - kernel-ipe
    - cni
    - containerd2
    - cri-tools
    - systemd-boot
    - dracut-hyperv
    - hyperv-daemons
    - cloud-init
    - checkpolicy
    - libselinux
    - policycoreutils-python-utils
    - secilc
    - selinux-policy
    - selinux-policy-ci
    - selinux-policy-modules
    - setools-console
    - systemd-ukify
    - systemd-boot
    - efibootmgr
    - lvm2
    - veritysetup
    - selinux-policy
    - selinux-policy-modules
    - gptfdisk
    - curl
    - bind-utils
    - tar
    - wget
    - blobfuse2
    - ca-certificates
    - chrony
    - cifs-utils
    - cloud-init-azure-kvp
    - conntrack-tools
    - cracklib
    - ebtables
    - ethtool
    - fuse
    - inotify-tools
    - iotop
    - iproute
    - ipset
    - iptables
    - iscsi-initiator-utils
    - jq
    - logrotate
    - lsof
    - netplan
    - nftables
    - nmap-ncat
    - nfs-utils
    - oras
    - pam
    - psmisc
    - rsyslog
    - socat
    - sysstat
    - traceroute
    - util-linux
    - xz
    - zip
  additionalDirs:
  - source: files/osguard/repart.d
    destination: /etc/repart.d
    childFilePermissions: 644
  additionalFiles:
  - source: files/osguard/selinux-ci-uki.semanage
    destination: /etc/selinux/targeted/selinux-ci.semanage
  - source: files/osguard/cloud.cfg
    destination: /etc/cloud/cloud.cfg
    permissions: '644'
  - source: files/osguard/10-repart.conf
    destination: /etc/dracut.conf.d/10-repart.conf
    permissions: '644'
  - source: files/osguard/chrony.conf
    destination: /etc/chrony.conf
    permissions: '644'
  - source: files/osguard/resolv-uplink-override.service
    destination: /etc/systemd/system/resolv-uplink-override.service
    permissions: '600'
  services:
    disable:
    - sshd
    enable:
    - systemd-networkd
    - systemd-resolved
  modules:
  - name: iptable_nat
    loadMode: always
scripts:
  postCustomization:
  - path: scripts/common/performance-tuning.sh
  - path: scripts/common/azlinuxagentconfig.sh
  - path: scripts/common/selinux-ci-config.py
    interpreter: /usr/bin/python3
  - path: scripts/common/cleanup-machineid.sh
  - path: scripts/common/prepare_trusted_cni_plugins.sh
  - path: scripts/common/move-iptables-scripts-to-usr.sh
  - path: scripts/common/tmp-no-exec.sh
  - path: scripts/common/remove-getty-import-credential.sh
  - path: scripts/osguard/create-empty-certs-dir.sh
  - path: scripts/set_os_release_variant_entries.sh
    arguments:
    - --variant-id
    - osguard
    - --variant
    - OS Guard Image
output:
  artifacts:
    items:
    - verity-hash
    - ukis
    path: ./output
  image:
    format: vhdx
previewFeatures:
- output-artifacts
- uki
