# prchecks/CveSpecFilePRCheck/CveSpecFilePRCheck.yml
# Trigger on PRs to fasttrack/abadawi/test/3.0 when .spec or .patch files change

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) Reference your GitHub service connection here
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
resources:
  repositories:
    - repository: self
      type: github
      name: microsoft/azurelinux   # <org>/<repo>
      endpoint: microsoft          # <your service-connection name>

trigger: none

pr:
  branches:
    include:
      - fasttrack/abadawi/test/3.0
  paths:
    include:
      - '**/*.spec'
      - '**/*.patch'

name: Automaton-OpenAI-PR-Check

pool:
  name: mariner-dev-build-1es-mariner2-amd64

parameters:
  - name: failOnWarnings
    displayName: Fail pipeline on warnings
    type: boolean
    default: false
  - name: useExitCodeSeverity
    displayName: Use different exit codes based on severity
    type: boolean
    default: true
  - name: postGitHubComments
    displayName: Post analysis results as GitHub PR comments
    type: boolean
    default: true
  - name: useGitHubChecks
    displayName: Use GitHub Checks API for status updates
    type: boolean
    default: true

variables:
  FAIL_ON_WARNINGS:      ${{ parameters.failOnWarnings }}
  USE_EXIT_CODE_SEVERITY: ${{ parameters.useExitCodeSeverity }}
  POST_GITHUB_COMMENTS:  ${{ parameters.postGitHubComments }}
  USE_GITHUB_CHECKS:     ${{ parameters.useGitHubChecks }}

steps:
  # 1) Clone the repo
  - checkout: self
    fetchDepth: 2
    persistCredentials: true

  # 2) Debug workspace (optional)
  - task: Bash@3
    displayName: 'ğŸ” Debug: list workspace contents'
    inputs:
      targetType: inline
      script: |
        echo "Working directory: $(pwd)"
        ls -la .
        ls -la .pipelines/prchecks/CveSpecFilePRCheck || echo "Directory not found"
        echo "PR Source Branch: $(System.PullRequest.SourceBranch)"
        echo "PR Target Branch: $(System.PullRequest.TargetBranch)"
        echo "Modified files in PR:"
        git fetch origin "+refs/heads/${SYSTEM_PULLREQUEST_TARGETBRANCH}:refs/remotes/origin/${SYSTEM_PULLREQUEST_TARGETBRANCH}"
        git diff --name-only "origin/$(System.PullRequest.TargetBranch)" HEAD

  # 3) Apply OpenAI config via your UMI-login script
  - task: Bash@3
    displayName: 'âš™ï¸  Apply OpenAI Config'
    inputs:
      targetType: inline
      script: |
        cd .pipelines/prchecks/CveSpecFilePRCheck
        if [ ! -f apply-security-config.sh ]; then
          echo "âŒ Cannot find apply-security-config.sh in $(pwd)"
          exit 1
        fi
        bash apply-security-config.sh --openaiModel=o3-mini

  # 4) Verify and use system Python
  - task: Bash@3
    displayName: 'ğŸ Verify System Python'
    inputs:
      targetType: inline
      script: |
        python3 --version
        which python3
        echo "Using system Python instead of downloading version"

  # 5) Debug GitHub Integration Settings
  - task: Bash@3
    displayName: 'Debug GitHub Integration Settings'
    inputs:
      targetType: inline
      script: |
        echo "System.AccessToken: ${SYSTEM_ACCESSTOKEN:0:4}..."
        echo "GitHub Access Token: ${GITHUB_ACCESS_TOKEN:0:4}..."
        echo "ENDPOINT_AUTH_MICROSOFT_PARAMETER_ACCESSTOKEN: ${ENDPOINT_AUTH_MICROSOFT_PARAMETER_ACCESSTOKEN:0:4}..."
        echo "Build.Repository.Name: $(Build.Repository.Name)"
        echo "System.PullRequest.PullRequestId: $(System.PullRequest.PullRequestId)"
        echo "System.PullRequest.SourceBranch: $(System.PullRequest.SourceBranch)"

  # 6) Run your PRâ€check entrypoint (installs deps & invokes Azure OpenAI)
  - task: Bash@3
    displayName: 'ğŸ” Run PR Check'
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      GITHUB_REPOSITORY:   $(Build.Repository.Name)   # "owner/repo"
      BUILD_SOURCEBRANCH:  $(Build.SourceBranch)       # "refs/pull/<PR>/merge"
    inputs:
      targetType: inline
      script: |
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Pull the GitHub App token from your service connection
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        export GITHUB_ACCESS_TOKEN="${ENDPOINT_AUTH_MICROSOFT_PARAMETER_ACCESSTOKEN}"
        echo "ğŸ”‘ GitHub token prefix: ${GITHUB_ACCESS_TOKEN:0:4}â€¦"

        cd .pipelines/prchecks/CveSpecFilePRCheck
        chmod +x run-pr-check.sh

        # Build command with your flags
        CMD="./run-pr-check.sh"
        if [ "$FAIL_ON_WARNINGS"       = "True" ]; then CMD="$CMD --fail-on-warnings";      fi
        if [ "$USE_EXIT_CODE_SEVERITY" = "True" ]; then CMD="$CMD --exit-code-severity";   fi
        if [ "$POST_GITHUB_COMMENTS"   = "True" ]; then CMD="$CMD --post-github-comments"; fi
        if [ "$USE_GITHUB_CHECKS"      = "True" ]; then CMD="$CMD --use-github-checks";    fi

        echo "Running command: $CMD"
        $CMD
