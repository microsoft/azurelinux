# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# The "agentPool" parameter is defined in the "Agent pools (DEV)" variable group.
# The "rawToolchain*" parameters are defined in the "Raw toolchain info" variable group.

parameters:
  - name: buildConfiguration
    type: object
    default:
      - name: "AMD64"
        agentPool: "$(DEV_AMD64_Managed)"
        maxCPUs: "$(($(nproc) / 2))"
        rawToolchainCacheURL: "$(rawToolchainCacheURL_AMD64_3.0)"
        rawToolchainExpectedHash: "$(rawToolchainCacheHash_AMD64_3.0)"
      - name: "ARM64"
        agentPool: "$(DEV_ARM64_Managed)"
        maxCPUs: "$(($(nproc) / 3))"
        rawToolchainCacheURL: "$(rawToolchainCacheURL_ARM64_3.0)"
        rawToolchainExpectedHash: "$(rawToolchainCacheHash_ARM64_3.0)"

  - name: dailyBuildID
    type: string
    default: ""
    displayName: "Daily build ID"

stages:
  - ${{ each configuration in parameters.buildConfiguration }}:
      - stage: Toolchain_${{ configuration.name }}
        jobs:
          - job: Build
            pool:
              type: linux
              isCustom: true
              name: ${{ configuration.agentPool }}
            variables:
              ob_artifactBaseName: Toolchain_${{ configuration.name }}_$(System.JobAttempt)
              ob_outputDirectory: $(Build.ArtifactStagingDirectory)
            steps:
              - template: RawToolchainDownload.yml@self
                parameters:
                  rawToolchainCacheURL: ${{ configuration.rawToolchainCacheURL }}
                  rawToolchainExpectedHash: ${{ configuration.rawToolchainExpectedHash }}

              - template: ToolchainBuild.yml@self
                parameters:
                  dailyBuildID: "${{ parameters.dailyBuildID }}"
                  outputArtifactsFolder: $(ob_outputDirectory)
                  selfRepoName: self

              # Toolchain package tests should be run through the full package build, calculate the list of packages that should be re-tested
              # and make it available to the next stage via an output variable: 'CalculateToolchainPackageRetestList.toolchainPackageRetestList'
              - template: ToolchainCalculatePackageRetests.yml@self
                parameters:
                  # GCC fails to build as a regular package.
                  ignoredSpecs: ["gcc"]

              - script: echo "##vso[task.setvariable variable=toolchainArtifactName;isOutput=true]$(ob_artifactBaseName)"
                name: "ToolchainArtifactName"
                displayName: "Set variable for published artifact name"

              # 1. Automatic publishing won't work if 'isCustom: true' is set on the pool. We cannot do 'isCustom: false' because
              #    then OneBranch attempts to perform additional actions (adding build tags for instance), which require additional permissions
              #    that the PR check pipeline does not have.
              # 2. The value for 'artifact' must equal $(ob_artifactBaseName), as this is the only value OneBranch accepts.
              - task: PublishPipelineArtifact@1
                inputs:
                  artifact: Toolchain_${{ configuration.name }}_$(System.JobAttempt)
                  targetPath: $(ob_outputDirectory)
                condition: always()
                displayName: "Publish toolchain artifacts"

      - stage: RPMs_${{ configuration.name }}
        dependsOn: Toolchain_${{ configuration.name }}
        jobs:
          - job: BuildAndTest
            pool:
              type: linux
              isCustom: true
              name: ${{ configuration.agentPool }}
            variables:
              ob_artifactBaseName: RPMs_${{ configuration.name }}_$(System.JobAttempt)
              ob_outputDirectory: $(Build.ArtifactStagingDirectory)
              toolchainArtifactName: $[ stageDependencies.Toolchain_${{ configuration.name }}.Build.outputs['ToolchainArtifactName.toolchainArtifactName'] ]
            steps:
              - template: PackageBuild.yml@self
                parameters:
                  checkBuildRetries: "1"
                  customToolchainArtifactName: $(toolchainArtifactName)
                  dailyBuildID: "${{ parameters.dailyBuildID }}"
                  isCheckBuild: true
                  isQuickRebuildPackages: true
                  isUseCCache: true
                  maxCPU: "${{ configuration.maxCPUs }}"
                  outputArtifactsFolder: $(ob_outputDirectory)
                  pipArtifactFeeds: "mariner/Mariner-Pypi-Feed"
                  selfRepoName: self
                  testSuiteName: "[${{ configuration.name }}] Package test"

              - script: echo "##vso[task.setvariable variable=rpmsArtifactName;isOutput=true]$(ob_artifactBaseName)"
                name: "RPMsArtifactName"
                displayName: "Set variable for published artifact name"

              - task: PublishPipelineArtifact@1
                inputs:
                  artifact: RPMs_${{ configuration.name }}_$(System.JobAttempt)
                  targetPath: $(ob_outputDirectory)
                condition: always()
                displayName: "Publish packages build artifacts"

      - stage: Toolchain_tests_${{ configuration.name }}
        dependsOn: Toolchain_${{ configuration.name }}
        jobs:
          - job: TestToolchainPackages
            condition: stageDependencies.Toolchain_${{ configuration.name }}.Build.outputs['CalculateToolchainPackageRetestList.toolchainPackageRetestList']
            pool:
              type: linux
              isCustom: true
              name: ${{ configuration.agentPool }}
            variables:
              ob_artifactBaseName: Toolchain_tests_${{ configuration.name }}_$(System.JobAttempt)
              ob_outputDirectory: $(Build.ArtifactStagingDirectory)
              testListFromToolchain: $[ stageDependencies.Toolchain_${{ configuration.name }}.Build.outputs['CalculateToolchainPackageRetestList.toolchainPackageRetestList'] ]
              toolchainArtifactName: $[ stageDependencies.Toolchain_${{ configuration.name }}.Build.outputs['ToolchainArtifactName.toolchainArtifactName'] ]
            steps:
              - template: PackageBuild.yml@self
                parameters:
                  checkBuildRetries: "1"
                  customToolchainArtifactName: $(toolchainArtifactName)
                  dailyBuildID: "${{ parameters.dailyBuildID }}"
                  isAllowToolchainRebuilds: true
                  isCheckBuild: true
                  isQuickRebuildPackages: true
                  isUseCCache: true
                  maxCPU: "${{ configuration.maxCPUs }}"
                  outputArtifactsFolder: $(ob_outputDirectory)
                  pipArtifactFeeds: "mariner/Mariner-Pypi-Feed"
                  selfRepoName: self
                  srpmPackList: "$(testListFromToolchain)"
                  testRerunList: "$(testListFromToolchain)"
                  testSuiteName: "[${{ configuration.name }}] Toolchain test"

              - task: PublishPipelineArtifact@1
                inputs:
                  artifact: Toolchain_tests_${{ configuration.name }}_$(System.JobAttempt)
                  targetPath: $(ob_outputDirectory)
                condition: always()
                displayName: "Publish toolchain build artifacts"

      - stage: Sodiff_${{ configuration.name }}
        dependsOn: RPMs_${{ configuration.name }}
        jobs:
          - job: Sodiff_Check
            pool:
              type: linux
              isCustom: true
              name: ${{ configuration.agentPool }}
            variables:
              rpmsArtifactName: $[ stageDependencies.RPMs_${{ configuration.name }}.BuildAndTest.outputs['RPMsArtifactName.rpmsArtifactName'] ]
            steps:
              - template: ../templatesWithCheckout/SodiffCheck.yml@self
                parameters:
                  inputArtifactName: $(rpmsArtifactName)
