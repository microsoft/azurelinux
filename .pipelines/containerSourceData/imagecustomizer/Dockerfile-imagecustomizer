# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

ARG BASE_IMAGE
ARG TARGETARCH
ARG AZ_MON_CONN_STR

FROM $BASE_IMAGE

ENV AZURE_MONITOR_CONNECTION_STRING=${AZ_MON_CONN_STR}

@INCLUDE_MAIN_RUN_INSTRUCTION@

RUN tdnf update -y && \
   tdnf install -y azurelinux-repos-cloud-native && \
   tdnf update -y && \
   tdnf install -y oras && \
   if [ "$TARGETARCH" = "amd64" ]; then \
       echo "Installing AMD64-specific packages..."; \
       tdnf install -y grub2-pc systemd-ukify; \
   else \
       echo "Skipping AMD64-specific packages for $TARGETARCH"; \
   fi && \
   tdnf clean all

# Create virtual environment and install Python dependencies for telemetry
RUN python3 -m venv /opt/telemetry-venv
RUN /opt/telemetry-venv/bin/pip install --no-cache-dir -r /usr/lib/imagecustomizer/telemetry-requirements.txt

ENTRYPOINT ["/usr/lib/imagecustomizer/entrypoint.sh"]
